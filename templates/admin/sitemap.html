{% extends "base.html" %}

{% block title %}–ö–∞—Ä—Ç–∞ —Å–∞–π—Ç–∞ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ{% endblock %}

{% block content %}
<div class="sitemap-container" style="padding: 24px; max-width: 1400px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1 style="margin: 0; font-size: 2rem; font-weight: 700;">üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Å–∞–π—Ç–∞</h1>
        <div style="display: flex; gap: 12px;">
            <button onclick="addNewSection()" class="btn" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª
            </button>
            <button onclick="saveOrder()" class="btn" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white;">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </button>
        </div>
    </div>
    
    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div id="sitemap-loading" style="text-align: center; padding: 40px;">
            <div style="color: #6b7280;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã —Å–∞–π—Ç–∞...</div>
        </div>
        
        <div id="sitemap-tree" style="display: none;">
            <!-- –î–µ—Ä–µ–≤–æ —Ä–∞–∑–¥–µ–ª–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
        
        <div id="sitemap-empty" style="display: none; text-align: center; padding: 40px; color: #6b7280;">
            –ù–∞ —Å–∞–π—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–æ–≤
        </div>
    </div>

    <div style="margin-top: 32px; background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2 style="margin: 0 0 16px; font-size: 1.25rem;">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <p style="color: #6b7280; margin-bottom: 16px;">–ö–æ–ø–∏—è –ø–∞–ø–æ–∫ <strong>instance</strong> (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö) –∏ <strong>–∑–∞–≥—Ä—É–∑–∫–∏</strong> (static/uploads). –û–¥–∏–Ω –∞—Ä—Ö–∏–≤ ZIP –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.</p>
        <p style="font-size: 0.875rem; color: #b45309; background: #fffbeb; padding: 10px 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #fcd34d;">
            <strong>–í–∞–∂–Ω–æ:</strong> –ù–∞ –æ–±–ª–∞—á–Ω–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ (Render, Heroku –∏ —Ç.–ø.) –¥–∏—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π ‚Äî –ø–æ—Å–ª–µ <strong>–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏–ª–∏ –Ω–æ–≤–æ–≥–æ –¥–µ–ø–ª–æ—è</strong> –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∏–∑ ZIP —Ñ–∞–π–ª—ã –ø—Ä–æ–ø–∞–¥—É—Ç. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∫–æ–ø–∏–∏ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –Ω–∞ —Å–≤–æ—ë–º —Å–µ—Ä–≤–µ—Ä–µ (VPS) –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ.
        </p>
        <div style="display: flex; flex-wrap: wrap; gap: 24px; align-items: flex-end;">
            <div>
                <button type="button" id="backup-export-preview-btn" class="btn" style="background: #e5e7eb; color: #374151;">
                    –ü–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥—Ä—É–∂–µ–Ω–æ
                </button>
            </div>
            <div>
                <a href="{{ url_for('admin.backup_export') }}" class="btn" style="background: linear-gradient(135deg, #059669, #047857); color: white; text-decoration: none; display: inline-block; padding: 10px 20px; border-radius: 8px;">
                    –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é (ZIP)
                </a>
            </div>
            <div style="flex: 1; min-width: 280px;"></div>
            <form id="backup-import-form" style="display: flex; flex-wrap: wrap; align-items: flex-end; gap: 12px;">
                <div>
                    <label style="display: block; font-size: 0.875rem; color: #6b7280; margin-bottom: 4px;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–ø–∏–∏ (.zip)</label>
                    <input type="file" name="file" accept=".zip" required style="font-size: 0.875rem;">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="clear_before" id="backup-clear-before" value="1" checked>
                    <label for="backup-clear-before" style="font-size: 0.875rem;">–û—á–∏—Å—Ç–∏—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π</label>
                </div>
                <button type="submit" class="btn" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                    –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–ø–∏–∏
                </button>
            </form>
        </div>
        <div id="backup-export-preview" style="display: none; margin-top: 16px;" class="backup-preview-box"></div>
        <div id="backup-preview" style="display: none; margin-top: 16px;" class="backup-preview-box">
            <div class="backup-preview-title">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞</div>
            <div id="backup-preview-content" class="backup-preview-body"></div>
            <div id="backup-preview-loading" style="display: none;" class="backup-preview-loading">–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞...</div>
        </div>
        <div id="backup-message" style="margin-top: 12px; font-size: 0.875rem;"></div>
    </div>
</div>

<style>
.sitemap-item {
    padding: 12px 16px;
    margin: 8px 0;
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: move;
    transition: all 0.2s ease;
}

.sitemap-item:hover {
    background: #f1f5f9;
    border-color: #3b82f6;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
}

.sitemap-item.dragging {
    opacity: 0.5;
    background: #e0e7ff;
}

.sitemap-item.drag-over {
    border-top: 3px solid #3b82f6;
}

.sitemap-item.drop-as-child {
    border-left: 4px solid #10b981;
    background: #ecfdf5;
}

.sitemap-item-handle {
    cursor: grab;
    color: #9ca3af;
    font-size: 18px;
}

.sitemap-item-handle:active {
    cursor: grabbing;
}

.sitemap-item-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
}

.sitemap-item-title {
    font-weight: 600;
    color: #1f2937;
}

.sitemap-item-url {
    font-size: 0.875rem;
    color: #6b7280;
    font-family: monospace;
}

.sitemap-item-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.sitemap-move-select {
    padding: 6px 10px;
    font-size: 0.875rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: #fff;
    color: #374151;
    min-width: 140px;
    max-width: 200px;
}

.sitemap-move-select:hover,
.sitemap-move-select:focus {
    border-color: #3b82f6;
    outline: none;
}

.sitemap-item-actions button {
    padding: 6px 12px;
    font-size: 0.875rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-edit {
    background: #3b82f6;
    color: white;
}

.btn-edit:hover {
    background: #2563eb;
}

.btn-delete {
    background: #ef4444;
    color: white;
}

.btn-delete:hover {
    background: #dc2626;
}

.sitemap-children {
    margin-left: 32px;
    padding-left: 16px;
    border-left: 2px dashed #e5e7eb;
}

.sitemap-item-parent {
    font-size: 0.75rem;
    color: #9ca3af;
    font-style: italic;
}

#backup-import-form .btn:hover {
    opacity: 0.9;
}

.backup-preview-box {
    padding: 16px 20px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.875rem;
    max-height: 70vh;
    overflow-y: auto;
}
.backup-preview-title {
    font-weight: 600;
    margin-bottom: 12px;
    color: #1e293b;
    font-size: 1rem;
}
.backup-preview-body { color: #475569; }
.backup-preview-loading { color: #64748b; margin-top: 8px; }

.backup-table-block {
    margin-bottom: 16px;
    padding: 12px 14px;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}
.backup-table-block h4,
.backup-table-block .backup-table-block-title {
    margin: 0 0 8px;
    font-size: 0.9rem;
    color: #334155;
}
.backup-upload-section {
    margin-bottom: 14px;
    padding: 12px 14px;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    border-left: 4px solid #0ea5e9;
}
.backup-upload-section-clickable {
    cursor: pointer;
}
.backup-upload-section-clickable:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
    border-left-color: #0284c7;
}
.backup-upload-toggle-hint {
    color: #0ea5e9;
    font-size: 0.8rem;
}
.backup-upload-files-toggle {
    margin-top: 8px;
}
.backup-upload-section-header {
    font-weight: 600;
    margin-bottom: 6px;
    color: #0f172a;
    font-size: 0.9rem;
}
.backup-upload-section-path {
    font-size: 0.75rem;
    color: #64748b;
    font-family: monospace;
    margin-bottom: 6px;
}
.backup-upload-section-meta {
    font-size: 0.8rem;
    color: #64748b;
    margin-bottom: 6px;
}
.backup-upload-file-list {
    margin: 0;
    padding-left: 20px;
    font-size: 0.8rem;
    max-height: 140px;
    overflow-y: auto;
    color: #475569;
}
.backup-upload-file-list li { margin: 2px 0; }
.backup-upload-file-size { color: #94a3b8; font-size: 0.75rem; }
</style>

<script src="/static/admin-sitemap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
(function() {
    function esc(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function formatBytes(n) {
        if (n == null || n < 0) return '';
        if (n < 1024) return n + ' –ë';
        if (n < 1024 * 1024) return (n / 1024).toFixed(1) + ' –ö–ë';
        return (n / (1024 * 1024)).toFixed(1) + ' –ú–ë';
    }

    function renderExportPreview(data) {
        if (!data) return '';
        var html = '<div class="backup-preview-title">–ß—Ç–æ –ø–æ–ø–∞–¥—ë—Ç –≤ –≤—ã–≥—Ä—É–∑–∫—É</div>';
        if (data.instance && data.instance.files && data.instance.files.length > 0) {
            html += '<div class="backup-table-block"><h4>instance (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)</h4><ul style="margin: 0; padding-left: 20px;">';
            data.instance.files.forEach(function(f) {
                var sizeStr = (f.size != null) ? ' <span class="backup-upload-file-size">' + formatBytes(f.size) + '</span>' : '';
                html += '<li>' + esc(f.name) + sizeStr + '</li>';
            });
            html += '</ul></div>';
        } else {
            html += '<div class="backup-table-block"><h4>instance</h4><p style="margin: 0; color: #64748b;">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p></div>';
        }
        if (data.uploads) {
            var u = data.uploads;
            html += '<div class="backup-table-block"><h4>–ó–∞–≥—Ä—É–∑–∫–∏ (uploads)</h4>';
            html += '<div style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px;">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: <strong>' + (u.total_files || 0) + '</strong>, –æ–±—ä—ë–º: <strong>' + formatBytes(u.total_size || 0) + '</strong></div>';
            if (u.sections && u.sections.length > 0) {
                u.sections.forEach(function(s) {
                    html += '<div class="backup-upload-section"><div class="backup-upload-section-path">' + esc(s.path) + '</div>';
                    html += '<div class="backup-upload-section-meta">' + s.count + ' —Ñ–∞–π–ª–æ–≤, ' + formatBytes(s.size) + '</div></div>';
                });
            }
            html += '</div>';
        }
        return html;
    }

    function renderZipPreview(instanceCount, uploadsCount, uploadsSize) {
        var html = '<div class="backup-preview-title">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞</div>';
        html += '<div class="backup-table-block"><h4>instance</h4><p style="margin: 0;">' + (instanceCount || 0) + ' —Ñ–∞–π–ª–æ–≤</p></div>';
        var sizeText = (uploadsSize && uploadsSize > 0) ? formatBytes(uploadsSize) : ' (–≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–∞ —Ä–∞–∑–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω)';
        html += '<div class="backup-table-block"><h4>uploads</h4><p style="margin: 0;">' + (uploadsCount || 0) + ' —Ñ–∞–π–ª–æ–≤, –æ–±—ä—ë–º ' + sizeText + '</p></div>';
        return html;
    }

    function showPreview(contentHtml, showLoading) {
        var box = document.getElementById('backup-preview');
        var content = document.getElementById('backup-preview-content');
        var loading = document.getElementById('backup-preview-loading');
        if (!box || !content) return;
        if (showLoading) {
            loading.style.display = 'block';
            content.innerHTML = '';
        } else {
            loading.style.display = 'none';
            content.innerHTML = contentHtml || '';
        }
        box.style.display = 'block';
    }

    var form = document.getElementById('backup-import-form');
    var msg = document.getElementById('backup-message');
    if (!form || !msg) return;

    var exportPreviewBtn = document.getElementById('backup-export-preview-btn');
    var exportPreviewBox = document.getElementById('backup-export-preview');
    if (exportPreviewBtn && exportPreviewBox) {
        exportPreviewBtn.addEventListener('click', function() {
            exportPreviewBox.style.display = 'none';
            exportPreviewBox.innerHTML = '<div class="backup-preview-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            exportPreviewBox.style.display = 'block';
            fetch('{{ url_for("admin.backup_export_preview") }}', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.error) {
                        exportPreviewBox.innerHTML = '<div style="color: #dc2626;">' + esc(data.error) + '</div>';
                    } else {
                        exportPreviewBox.innerHTML = renderExportPreview(data);
                    }
                })
                .catch(function() {
                    exportPreviewBox.innerHTML = '<div style="color: #dc2626;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>';
                });
        });
    }

    var zipFileInput = form.querySelector('input[name="file"]');
    if (zipFileInput) {
        zipFileInput.addEventListener('change', function() {
            var file = this.files[0];
            if (!file) { showPreview('', false); return; }
            showPreview('', true);
            if (typeof JSZip === 'undefined') {
                showPreview('<span style="color: #64748b;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .zip –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–ø–∏–∏¬ª</span>', false);
                return;
            }
            var reader = new FileReader();
            reader.onload = function() {
                JSZip.loadAsync(reader.result).then(function(zip) {
                    var names = Object.keys(zip.files);
                    var instanceNames = names.filter(function(n) { return n.indexOf('instance/') === 0 && !n.endsWith('/'); });
                    var uploadNames = names.filter(function(n) { return n.indexOf('uploads/') === 0 && !n.endsWith('/'); });
                    var uploadsSize = uploadNames.reduce(function(sum, n) {
                        var e = zip.files[n];
                        var sz = e && (e.uncompressedSize != null) ? e.uncompressedSize : (e && e._data && e._data.uncompressedSize != null ? e._data.uncompressedSize : 0);
                        return sum + (sz || 0);
                    }, 0);
                    if (instanceNames.length === 0 && uploadNames.length === 0) {
                        showPreview('<span style="color: #dc2626;">–í –∞—Ä—Ö–∏–≤–µ –Ω–µ—Ç –∫–∞—Ç–∞–ª–æ–≥–æ–≤ instance/ –∏–ª–∏ uploads/</span>', false);
                    } else {
                        showPreview(renderZipPreview(instanceNames.length, uploadNames.length, uploadsSize), false);
                    }
                }).catch(function() {
                    showPreview('<span style="color: #dc2626;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å ZIP-–∞—Ä—Ö–∏–≤</span>', false);
                });
            };
            reader.readAsArrayBuffer(file);
        });
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        var fd = new FormData(form);
        var fileInput = form.querySelector('input[name="file"]');
        if (!fileInput || !fileInput.files.length) {
            msg.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .zip';
            msg.style.color = '#dc2626';
            return;
        }
        fd.set('file', fileInput.files[0]);
        fd.set('clear_before', form.querySelector('#backup-clear-before').checked ? 'true' : 'false');
        msg.textContent = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        msg.style.color = '#6b7280';
        fetch('{{ url_for("admin.backup_import") }}', {
            method: 'POST',
            body: fd,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(o) {
            if (o.ok && o.data.success) {
                msg.textContent = o.data.message || '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.';
                msg.style.color = '#059669';
            } else {
                msg.textContent = o.data.error || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è';
                msg.style.color = '#dc2626';
            }
        }).catch(function() {
            msg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞';
            msg.style.color = '#dc2626';
        });
    });
})();
</script>
{% endblock %}


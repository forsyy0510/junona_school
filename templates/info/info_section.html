{% extends "base.html" %}
{% block title %}{{ title }} — Юнона{% endblock %}
{% block content %}
<div class="card item info-card--no-border">
    <style>
      .info-card--no-border { border: none !important; box-shadow: none !important; }
    </style>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;">{{ title }}</h1>
        {% if current_user.is_authenticated %}
        <a href="/info/{{ endpoint }}/edit" class="btn" style="background: #10b981; text-decoration: none;">Редактировать</a>
        {% endif %}
    </div>
    <div class="content">
        <p>{{ text|safe }}</p>
    </div>

    <!-- DEBUG: content_blocks = {{ content_blocks }} -->
    {% if content_blocks %}
        <p>DEBUG: Найдено {{ content_blocks|length }} блоков контента</p>
        {% for block in content_blocks %}
        <div style="margin: 24px 0;">
            {% if block.title and block.get('show_title', True) %}
            <h3>{{ block.title }}</h3>
            {% endif %}

            {% if block.type == 'text' %}
                {% if block.content %}
                <div class="content">
                    {{ block.content }}
                </div>
                {% endif %}

            {% elif block.type == 'table' %}
            <div style="overflow-x: auto;">
                <table class="content-table">
                    {% if block.headers %}
                    <thead>
                        <tr>
                            {% for header in block.headers %}
                            <th>{{ header }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    {% endif %}
                    {% if block.rows %}
                    <tbody>
                        {% for row in block.rows %}
                        <tr>
                            {% for cell in row %}
                            <td>{{ cell }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% endif %}
                </table>
            </div>

            {% elif block.type == 'list' %}
            <ul>
                {% for item in block.list_items %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>

            {% elif block.type == 'documents' %}
            <ul>
                {% for doc in block.documents %}
                <li><a href="{{ doc.url }}" target="_blank">{{ doc.name }}</a></li>
                {% endfor %}
            </ul>

            {% elif block.type == 'photos' %}
            <div style="display:flex;gap:16px;flex-wrap:wrap;">
                {% for photo in block.photos %}
                <div style="width:140px;text-align:center;">
                    <img src="{{ photo.url }}" alt="{{ photo.alt }}" style="width:100%;max-width:140px;border-radius:8px;box-shadow:0 2px 8px #0001;">
                    <div style="font-size:0.95em;color:#666;margin-top:4px;">{{ photo.alt }}</div>
                </div>
                {% endfor %}
            </div>

            {% elif block.type == 'person' %}
            <style>
              .teachers-grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:16px; }
              .teacher-card { width: auto; background: var(--color-card); border:1px solid var(--color-border); border-radius:12px; box-shadow: var(--shadow); padding:14px; cursor:pointer; transition: transform .15s; text-align:center; }
              .teacher-card:hover { transform: translateY(-2px); }
              .teacher-card img { width:120px; height:120px; object-fit:cover; border-radius:50%; display:block; margin:0 auto 10px auto; }
              .teacher-name { font-weight:700; }
              .teacher-subject { color: var(--color-primary); margin-top:4px; }
              /* modal */
              .modal-backdrop--teacher { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1100; }
              .modal--teacher { background:#fff; width:100%; max-width:560px; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; }
              .modal-header--teacher { padding:14px 18px; background:#2563eb; color:#fff; font-weight:700; display:flex; justify-content:space-between; align-items:center; }
              .modal-body--teacher { padding:18px; display:flex; gap:16px; }
              .modal-body--teacher img { width:140px; height:140px; object-fit:cover; border-radius:12px; }
              .close-btn--teacher { background:none; border:none; color:#fff; font-size:20px; cursor:pointer; }
              .teacher-meta { color:#555; margin-top:6px; }
            </style>
            <div class="teachers-grid">
              {% for person in block.persons %}
              <div class="teacher-card" data-teacher='{"name":"{{ person.name|e }}","position":"{{ person.position|e }}","photo":"{{ person.photo|e }}","bio":"{{ person.bio|e }}","email":"{{ person.email|e }}","phone":"{{ person.phone|e }}","education":"{{ person.education|e }}","experience":"{{ person.experience|e }}"}'>
                <img src="{{ person.photo }}" alt="{{ person.name }}">
                <div class="teacher-name">{{ person.name }}</div>
                <div class="teacher-subject">{{ person.position }}</div>
              </div>
              {% endfor %}
            </div>
            <div class="modal-backdrop--teacher" id="teacherModal">
              <div class="modal--teacher" role="dialog" aria-modal="true" aria-labelledby="teacherModalTitle">
                <div class="modal-header--teacher">
                  <div id="teacherModalTitle">Сотрудник</div>
                  <button class="close-btn--teacher" id="closeTeacherModal" aria-label="Закрыть">×</button>
                </div>
                <div class="modal-body--teacher">
                  <img id="tmPhoto" src="" alt="Фото">
                  <div>
                    <div style="font-weight:700; font-size:1.1em;" id="tmName"></div>
                    <div class="teacher-meta" id="tmPosition"></div>
                    <div class="teacher-meta" id="tmBio" style="margin-top:8px;"></div>
                    <div class="teacher-meta" id="tmEducation"></div>
                    <div class="teacher-meta" id="tmExperience"></div>
                    <div class="teacher-meta" id="tmEmail"></div>
                    <div class="teacher-meta" id="tmPhone"></div>
                  </div>
                </div>
              </div>
            </div>
            <script>
              (function(){
                const modal = document.getElementById('teacherModal');
                const closeBtn = document.getElementById('closeTeacherModal');
                function open(data){
                  document.getElementById('tmPhoto').src = data.photo;
                  document.getElementById('tmName').textContent = data.name;
                  document.getElementById('tmPosition').textContent = data.position;
                  document.getElementById('tmBio').textContent = data.bio;
                  document.getElementById('tmEducation').textContent = 'Образование: ' + data.education;
                  document.getElementById('tmExperience').textContent = 'Опыт работы: ' + data.experience;
                  document.getElementById('tmEmail').textContent = 'Email: ' + data.email;
                  document.getElementById('tmPhone').textContent = 'Телефон: ' + data.phone;
                  modal.style.display = 'flex';
                }
                function close(){ modal.style.display = 'none'; }
                document.querySelectorAll('.teacher-card').forEach(card => {
                  card.addEventListener('click', () => {
                    try { const data = JSON.parse(card.getAttribute('data-teacher')); open(data); } catch(e){}
                  });
                });
                if (closeBtn) closeBtn.addEventListener('click', close);
                window.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });
                if (modal) modal.addEventListener('click', e => { if (e.target === modal) close(); });
              })();
            </script>
            {% endif %}
        </div>
        {% endfor %}
    {% endif %}
</div>
{% endblock %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}–Æ–Ω–æ–Ω–∞{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}–ú–ë–û–£ –ò–¢ –ì–∏–º–Ω–∞–∑–∏—è –Æ–Ω–æ–Ω–∞ - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–æ–ª–∞ —Å —É–≥–ª—É–±–ª—ë–Ω–Ω—ã–º –∏–∑—É—á–µ–Ω–∏–µ–º IT –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-–Ω–∞—É—á–Ω—ã—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω –ø—Ä–∏ –í–ò–¢–ò –ù–ò–Ø–£ –ú–ò–§–ò –≥. –í–æ–ª–≥–æ–¥–æ–Ω—Å–∫–∞{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}—à–∫–æ–ª–∞, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, IT, –≥–∏–º–Ω–∞–∑–∏—è, –Æ–Ω–æ–Ω–∞, –í–æ–ª–≥–æ–¥–æ–Ω—Å–∫, –í–ò–¢–ò –ù–ò–Ø–£ –ú–ò–§–ò, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏{% endblock %}">
    <meta name="author" content="–ú–ë–û–£ –ò–¢ –ì–∏–º–Ω–∞–∑–∏—è –Æ–Ω–æ–Ω–∞">
    <meta name="robots" content="{% block robots %}index, follow{% endblock %}">
    
    <!-- Open Graph -->
    <meta property="og:title" content="{% block og_title %}–Æ–Ω–æ–Ω–∞{% endblock %}">
    <meta property="og:description" content="{% block og_description %}–ú–ë–û–£ –ò–¢ –ì–∏–º–Ω–∞–∑–∏—è –Æ–Ω–æ–Ω–∞ - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–æ–ª–∞ —Å —É–≥–ª—É–±–ª—ë–Ω–Ω—ã–º –∏–∑—É—á–µ–Ω–∏–µ–º IT –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-–Ω–∞—É—á–Ω—ã—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ url_for('static', filename='images/logo.png', _external=True) }}{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.url }}{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:site_name" content="–ú–ë–û–£ –ò–¢ –ì–∏–º–Ω–∞–∑–∏—è –Æ–Ω–æ–Ω–∞">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="{% block twitter_card %}summary_large_image{% endblock %}">
    <meta name="twitter:title" content="{% block twitter_title %}–Æ–Ω–æ–Ω–∞{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}–ú–ë–û–£ –ò–¢ –ì–∏–º–Ω–∞–∑–∏—è –Æ–Ω–æ–Ω–∞{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{{ url_for('static', filename='images/logo.png', _external=True) }}{% endblock %}">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{% block canonical_url %}{{ request.url }}{% endblock %}">
    
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/wizard.css">
    <link rel="stylesheet" href="/static/html-editor.css">
    <link rel="stylesheet" href="/static/forms.css">
    <link rel="stylesheet" href="/static/modals.css">
    <link rel="stylesheet" href="/static/content-blocks.css">
    <style>
      .btn-link { background: rgba(255,255,255,0.16); color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600; }
      .btn-link:hover { background: rgba(255,255,255,0.28); }
      .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; }
      .modal { background:#fff; width:100%; max-width:420px; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.2); overflow:hidden; }
      .modal-header { padding:14px 18px; background:#2563eb; color:#fff; font-weight:700; display:flex; justify-content:space-between; align-items:center; }
      .modal-body { padding:18px; }
      .close-btn { background:none; border:none; color:#fff; font-size:20px; cursor:pointer; }
      .field { margin-bottom:12px; }
      .field input { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; box-sizing:border-box; }
      .user-box { background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; margin-top:10px; }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è */
      .dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 600;
        color: #374151;
      }
      
      .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 8px 0;
      }
      
      
      .wizard-btn {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
      }
      
      .wizard-btn:hover {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
      }
      
      .wizard-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–∞—Å—Ç–µ—Ä–∞ */
      .wizard-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 2147483647;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: wizardFadeIn 0.3s ease;
      }
      
      .wizard-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        animation: backdropFadeIn 0.3s ease;
      }
      
      .wizard-container {
        position: relative;
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        width: 95vw;
        height: 90vh;
        max-width: 1400px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 2147483648;
      }
      
      .wizard-header {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 24px 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .wizard-title h2 {
        margin: 0 0 8px 0;
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .wizard-title p {
        margin: 0;
        opacity: 0.9;
        font-size: 1rem;
      }
      
      .wizard-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.2s ease;
      }
      
      .wizard-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }
      
      .wizard-content {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      
      .wizard-sidebar {
        width: 300px;
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        padding: 24px;
        overflow-y: auto;
      }
      
      .wizard-progress {
        margin-bottom: 24px;
      }
      
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 6.25%;
      }
      
      .progress-text {
        font-size: 0.9rem;
        color: #6b7280;
        font-weight: 500;
      }
      
      .wizard-steps {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .wizard-step {
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        background: white;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .wizard-step:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
      }
      
      .wizard-step.active {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1d4ed8;
        font-weight: 600;
      }
      
      .wizard-step.completed {
        background: #dcfce7;
        border-color: #10b981;
        color: #047857;
      }
      
      .wizard-step-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
      }
      
      .wizard-step.active .wizard-step-icon {
        background: #3b82f6;
        color: white;
      }
      
      .wizard-step.completed .wizard-step-icon {
        background: #10b981;
        color: white;
      }
      
      .wizard-step-text {
        flex: 1;
        font-size: 0.9rem;
        line-height: 1.4;
      }
      
      .wizard-step-drag-handle {
        margin-left: auto;
        cursor: grab;
        color: #9ca3af;
        font-size: 12px;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        user-select: none;
      }
      
      .wizard-step-drag-handle:hover {
        background: #f3f4f6;
        color: #6b7280;
      }
      
      .wizard-step:active .wizard-step-drag-handle {
        cursor: grabbing;
      }
      
      .wizard-step.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
      }
      
        .wizard-step.drag-over {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        /* HTML Editor Styles */
        .html-editor-container {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .html-editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 8px;
            border-right: 1px solid #e5e7eb;
        }
        
        .toolbar-group:last-child {
            border-right: none;
        }
        
        .html-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
        }
        
        .html-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .html-editor-textarea {
            border: none;
            border-radius: 0;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .html-editor-textarea:focus {
            outline: none;
            box-shadow: none;
        }
        
        .html-preview {
            border-top: 1px solid #e5e7eb;
            padding: 12px;
            background: #f9fafb;
        }
        
        .html-preview h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .html-preview-content {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
            background: white;
            min-height: 60px;
            max-height: 360px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .html-preview-content h3 {
            color: #2563eb;
            font-size: 1.1em;
            font-weight: bold;
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #2563eb;
        }
        
        .html-preview-content p {
            margin: 0 0 10px 0;
            line-height: 1.6;
            color: #333;
        }
        
        .html-preview-content ul, .html-preview-content ol {
            margin: 0 0 10px 0;
            padding-left: 20px;
        }
        
        .html-preview-content li {
            margin: 0 0 5px 0;
            line-height: 1.5;
        }
      
      .wizard-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .wizard-step-content {
        flex: 1;
        padding: 32px;
        overflow-y: auto;
      }
      
      .wizard-actions {
        padding: 24px 32px;
        background: #f8fafc;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }
      
      .wizard-actions-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        flex: 1;
      }
      
      .wizard-save-status {
        font-size: 0.85rem;
        font-weight: 500;
        padding: 4px 12px;
        border-radius: 20px;
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateY(-10px);
      }
      
      .wizard-save-status.success {
        background: #dcfce7;
        color: #166534;
        opacity: 1;
        transform: translateY(0);
      }
      
      .wizard-save-status.error {
        background: #fef2f2;
        color: #dc2626;
        opacity: 1;
        transform: translateY(0);
      }
      
      .wizard-save-status.saving {
        background: #dbeafe;
        color: #1d4ed8;
        opacity: 1;
        transform: translateY(0);
      }
      
      .wizard-actions .btn {
        padding: 12px 24px;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .wizard-actions .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .wizard-actions .btn:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      .btn-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
      }
      
      .btn-warning:hover {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      }
      
      @keyframes wizardFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes backdropFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ */
      @media (max-width: 768px) {
        .wizard-container {
          width: 100vw;
          height: 100vh;
          border-radius: 0;
        }
        
        .wizard-sidebar {
          width: 250px;
          padding: 16px;
        }
        
        .wizard-step-content {
          padding: 20px;
        }
        
        .wizard-actions {
          padding: 16px 20px;
          flex-direction: column;
        }
        
        .wizard-actions .btn {
          width: 100%;
          justify-content: center;
        }
        
        .wizard-actions-center {
          order: -1;
          width: 100%;
          margin-bottom: 16px;
        }
        
        .wizard-actions {
          flex-direction: column;
          gap: 12px;
        }
      }
      .user-box small { color:#6b7280; }
      .logout-btn { background:#ef4444; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:600; }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º */
      .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
      .form-control { 
        width: 100%; 
        padding: 12px 16px; 
        border: 1px solid #d1d5db; 
        border-radius: 8px; 
        box-sizing: border-box; 
        font-size: 14px; 
        transition: border-color 0.2s, box-shadow 0.2s;
        background: #fff;
      }
      .form-control:focus { 
        outline: none; 
        border-color: #3b82f6; 
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
      }
      .form-control:hover { border-color: #9ca3af; }
      .btn { 
        display: inline-block; 
        padding: 12px 24px; 
        background: #3b82f6; 
        color: white; 
        text-decoration: none; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        font-weight: 600; 
        font-size: 14px; 
        transition: background-color 0.2s;
      }
      .btn:hover { background: #2563eb; }
      .btn-secondary { background: #6b7280; }
      .btn-secondary:hover { background: #4b5563; }
      .btn-danger { background: #ef4444; }
      .btn-danger:hover { background: #dc2626; }
      .btn-success { background: #10b981; }
      .btn-success:hover { background: #059669; }
      .btn-sm { padding: 6px 12px; font-size: 12px; }
      .btn-xs { padding: 4px 8px; font-size: 11px; }
      
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .edit-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
            color: white;
        }

        .edit-header h1 {
            margin: 0;
            color: white;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .edit-header .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .edit-header .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .edit-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .form-section {
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section h2 {
            margin-bottom: 25px;
            color: #1e293b;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            position: relative;
        }

        .form-section h2::before {
            content: '';
            width: 6px;
            height: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 15px;
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .content-block {
            border: none;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .content-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .content-block:hover {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: none;
            transform: none;
        }

        .content-block:hover::before {
            transform: scaleX(0);
            opacity: 0;
        }

        .content-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        .content-block-title {
            margin: 0;
            color: #1e293b;
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .block-type-selector {
            margin-bottom: 25px;
        }

        .block-type-selector select {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px 18px;
            font-size: 15px;
            font-weight: 500;
            color: #374151;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .block-type-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .dynamic-content {
            margin-top: 25px;
        }

        .table-editor, .list-editor, .documents-editor, .photos-editor, .persons-editor {
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .table-editor h4, .list-editor h4, .documents-editor h4, .photos-editor h4, .persons-editor h4 {
            margin: 0 0 20px 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f5f9;
        }

        .item-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .item-row:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            transform: translateX(2px);
        }

        .item-row input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .item-row input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .person-card {
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .person-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .person-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .person-card-title {
            margin: 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .file-upload-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            margin-top: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .file-upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .file-upload-section:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transform: translateY(-2px);
        }

        .file-upload-section:hover::before {
            transform: scaleX(1);
        }

        .file-upload-section h2 {
            margin-bottom: 20px;
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .file-upload-section h2::before {
            display: none;
        }

        .submit-section {
            text-align: center;
            margin-top: 50px;
            padding-top: 40px;
            border-top: 3px solid #f1f5f9;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-xs {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-block {
            animation: slideInUp 0.5s ease-out;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .edit-container {
                padding: 15px;
            }

            .edit-form {
                padding: 25px;
            }

            .edit-header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
                padding: 20px;
            }

            .edit-header h1 {
                font-size: 1.8rem;
            }

            .form-section {
                padding: 20px;
            }

            .content-block {
                padding: 20px;
            }

            .item-row {
                flex-direction: column;
                gap: 10px;
            }

            .item-row input {
                width: 100%;
            }

            .person-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö -->
    <div id="error-container"></div>
<div class="nav">
    <div class="burger" tabindex="0" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" role="button">
        <span></span><span></span><span></span>
    </div>
    <div class="nav-inner" style="flex:1;">
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <div class="dropdown">
            <a href="/sveden/common" class="dropdown-toggle">–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</a>
            <div class="dropdown-menu">
                {% if current_user.is_authenticated %}
                <div class="dropdown-header">
                    <button onclick="openWizard()" class="wizard-btn" title="–ú–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è" style="width: 100%; justify-content: center;">
                        <i class="icon">‚ö°</i> –ú–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                    </button>
                </div>
                <div class="dropdown-divider"></div>
                {% endif %}
                {% if current_user.is_authenticated %}
                <a href="/admin/sitemap" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; font-weight: 600;">
                    üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Å–∞–π—Ç–∞
                </a>
                <div class="dropdown-divider"></div>
                {% endif %}
                <a href="/sveden/common">–û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è</a>
                <a href="/sveden/struct">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –æ—Ä–≥–∞–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π</a>
                <a href="/sveden/document">–î–æ–∫—É–º–µ–Ω—Ç—ã</a>
                <a href="/sveden/education">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</a>
                <a href="/sveden/eduStandarts">–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</a>
                <a href="/sveden/managers">–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ</a>
                <a href="/sveden/employees">–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤</a>
                <a href="/sveden/objects">–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏ –æ—Å–Ω–∞—â–µ–Ω–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞. –î–æ—Å—Ç—É–ø–Ω–∞—è —Å—Ä–µ–¥–∞</a>
                <a href="/sveden/grants">–°—Ç–∏–ø–µ–Ω–¥–∏–∏ –∏ –º–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—É—á–∞—é—â–∏—Ö—Å—è</a>
                <a href="/sveden/paid_edu">–ü–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</a>
                <a href="/sveden/budget">–§–∏–Ω–∞–Ω—Å–æ–≤–æ-—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å</a>
                <a href="/sveden/vacant">–í–∞–∫–∞–Ω—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ (–ø–µ—Ä–µ–≤–æ–¥–∞) –æ–±—É—á–∞—é—â–∏—Ö—Å—è</a>
                <a href="/sveden/inter">–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ</a>
                <a href="/sveden/catering">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–∏—Ç–∞–Ω–∏—è –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</a>
            </div>
        </div>
        <a href="/news">–ù–æ–≤–æ—Å—Ç–∏</a>
        <a href="/info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a>
        <a href="/projects">–ü—Ä–æ–µ–∫—Ç—ã</a>
        <a href="/albums">–§–æ—Ç–æ–∞–ª—å–±–æ–º—ã</a>
        <a href="/contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
    </div>
    <div class="nav-auth" style="display: flex; align-items: center; gap: 12px;">
        {% if visually_impaired_url and visually_impaired_url|trim %}
        <a href="{{ visually_impaired_url }}" target="_blank" itemprop="copy"
            style="background: linear-gradient(135deg, #10b981, #059669); padding: 8px 16px; border-radius: 8px; border: none; color: white; cursor: pointer; font-size: 14px; font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; white-space: nowrap; height: 36px; box-sizing: border-box;">
            üëÅÔ∏è –í–µ—Ä—Å–∏—è –¥–ª—è —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏—Ö
        </a>
        {% else %}
        <a href="#" onclick="return false;" itemprop="copy"
            style="background: linear-gradient(135deg, #9ca3af, #6b7280); padding: 8px 16px; border-radius: 8px; border: none; color: white; cursor: not-allowed; font-size: 14px; font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; white-space: nowrap; opacity: 0.7; height: 36px; box-sizing: border-box;"
            title="URL –≤–µ—Ä—Å–∏–∏ –¥–ª—è —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏—Ö –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω">
            üëÅÔ∏è –í–µ—Ä—Å–∏—è –¥–ª—è —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏—Ö
        </a>
        {% endif %}
        {% if current_user.is_authenticated %}
        <span class="nav-auth-user">{{ current_user.username }}</span>
        <form method="post" action="/users/logout" style="margin: 0;">
            <button type="submit" class="btn btn-nav-logout">–í—ã–π—Ç–∏</button>
        </form>
        {% else %}
        <button type="button" class="btn btn-nav-login" id="openLoginModalBtn2">–í–æ–π—Ç–∏</button>
        {% endif %}
    </div>
</div>

{% if current_user.is_authenticated %}
<div class="header-actions">
    <a class="btn header-actions-btn header-actions-btn--sitemap" href="/admin/sitemap"><i class="icon">üó∫Ô∏è</i> –ö–∞—Ä—Ç–∞ —Å–∞–π—Ç–∞</a>
    <button type="button" onclick="openWizard()" class="btn header-actions-btn wizard-btn" title="–ú–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è"><i class="icon">‚ö°</i> –ú–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</button>
    <a class="btn header-actions-btn header-actions-btn--debug" href="/info/debug_files"><i class="icon">üîß</i> –û—Ç–ª–∞–¥–∫–∞ —Ñ–∞–π–ª–æ–≤</a>
    <a class="btn header-actions-btn" href="/edit/index">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–ª–∞–≤–Ω—É—é</a>
</div>
{% endif %}
<script>
(function(){ var btn = document.getElementById('openLoginModalBtn2'); if(btn){ btn.addEventListener('click', function(){ var m = document.getElementById('loginModal'); if(m) m.style.display = 'flex'; }); } })();
</script>

<!-- Login Modal -->
<div class="modal-backdrop" id="loginModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle">
    <div class="modal-header">
      <div id="loginModalTitle">–í—Ö–æ–¥</div>
      <button class="close-btn" id="closeLoginModalBtn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    <div class="modal-body">
      <form method="post" action="/users/login">
        {{ login_form.hidden_tag() }}
        <div class="field">
          {{ login_form.username.label }}<br>
          {{ login_form.username(size=32) }}
        </div>
        <div class="field">
          {{ login_form.password.label }}<br>
          {{ login_form.password(size=32) }}
        </div>
        {{ login_form.submit(class_="btn", value="–í–æ–π—Ç–∏") }}
      </form>
    </div>
  </div>
</div>

<div class="main-layout">
  <aside class="global-sidebar global-sidebar--left">
      {% if current_user.is_authenticated %}
      <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
        <button onclick="openCreateSidebarSectionModal()" class="wizard-btn" style="width: 100%; padding: 10px; font-size: 14px; background: linear-gradient(135deg, #10b981, #059669);" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é">
          <i class="icon">‚ûï</i> –°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–¥–µ–ª
        </button>
      </div>
      {% endif %}
    <nav class="sidebar-menu">
      {% macro render_sidebar_node(node) -%}
        <li>
          <a href="{{ node.href if node.href is defined else ('/sidebar/' ~ node.endpoint) }}">{{ node.title }}</a>
          {% if node.children and node.children|length > 0 %}
            <ul class="sidebar-menu__sub">
              {% for ch in node.children %}
                {{ render_sidebar_node(ch) }}
              {% endfor %}
            </ul>
          {% endif %}
        </li>
      {%- endmacro %}

      {% set roots = sidebar_menu_tree if sidebar_menu_tree is defined else [] %}
      {% set visible_roots = roots[:6] %}
      {% set hidden_roots = roots[6:] %}

      <ul>
        {% for node in visible_roots %}
          {{ render_sidebar_node(node) }}
        {% endfor %}
        {% if hidden_roots and hidden_roots|length > 0 %}
          <li class="sidebar-menu__more-toggle"><button id="sidebarMenuMoreBtn" class="sidebar-menu__toggle-btn" aria-expanded="false">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë ‚ñº</button></li>
        {% endif %}
      </ul>

      {% if hidden_roots and hidden_roots|length > 0 %}
        <ul id="sidebarMenuMore" class="sidebar-menu__more" style="display:none;">
          {% for node in hidden_roots %}
            {{ render_sidebar_node(node) }}
          {% endfor %}
          <li class="sidebar-menu__more-toggle"><button id="sidebarMenuHideBtn" class="sidebar-menu__toggle-btn">–°–∫—Ä—ã—Ç—å ‚ñ≤</button></li>
        </ul>
      {% endif %}
    </nav>
  </aside>

  <style>
    .sidebar-menu__sub {
      margin: 6px 0 6px 14px;
      padding-left: 10px;
      border-left: 2px solid rgba(59, 130, 246, 0.18);
    }
    .sidebar-menu__sub > li > a {
      font-size: 0.96em;
      opacity: 0.92;
    }
  </style>
  <div class="container">
    {% block content %}{% endblock %}
  </div>
</div>
<script src="/static/main.js"></script>

<!-- –û–ø—Ä–µ–¥–µ–ª—è–µ–º toggleInputType –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ -->
<script>
    window.toggleInputType = function(fieldName, type) {
        if (window.wizardManager && typeof window.wizardManager.toggleInputType === 'function') {
            return window.wizardManager.toggleInputType(fieldName, type);
        } else {
            console.warn('toggleInputType: wizardManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ');
            // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(function() {
                if (window.wizardManager && typeof window.wizardManager.toggleInputType === 'function') {
                    return window.wizardManager.toggleInputType(fieldName, type);
                }
            }, 200);
        }
    };
</script>

<script>
  (function(){
    function createButton(icon, title, handler){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.innerHTML = icon;
      btn.title = title;
      btn.className = 'rte-btn';
      btn.addEventListener('click', handler);
      return btn;
    }
    function surround(el, wrapper){
      el.parentNode.insertBefore(wrapper, el);
      wrapper.appendChild(el);
    }
    function initEditor(textarea){
      const wrapper = document.createElement('div');
      wrapper.className = 'rte-wrapper';
      const toolbar = document.createElement('div');
      toolbar.className = 'rte-toolbar';
      const area = document.createElement('div');
      area.className = 'rte-area';
      area.contentEditable = 'true';
      area.innerHTML = textarea.value;
      // Buttons
      const cmds = [
        {icon:'<b>B</b>', title:'–ü–æ–ª—É–∂–∏—Ä–Ω—ã–π', cmd:'bold'},
        {icon:'<i>I</i>', title:'–ö—É—Ä—Å–∏–≤', cmd:'italic'},
        {icon:'<u>U</u>', title:'–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π', cmd:'underline'},
        {icon:'‚Ä¢', title:'–ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫', cmd:'insertUnorderedList'},
        {icon:'1.', title:'–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫', cmd:'insertOrderedList'},
        {icon:'‚ü∏', title:'–í—ã—Ä–æ–≤–Ω—è—Ç—å –≤–ª–µ–≤–æ', cmd:'justifyLeft'},
        {icon:'‚ü∑', title:'–ü–æ —Ü–µ–Ω—Ç—Ä—É', cmd:'justifyCenter'},
        {icon:'‚üπ', title:'–í—ã—Ä–æ–≤–Ω—è—Ç—å –≤–ø—Ä–∞–≤–æ', cmd:'justifyRight'},
      ];
      cmds.forEach(({icon,title,cmd})=>{
        toolbar.appendChild(createButton(icon,title,()=>document.execCommand(cmd,false,null)));
      });
      // Link
      toolbar.appendChild(createButton('üîó','–°—Å—ã–ª–∫–∞',()=>{
        const url = prompt('URL —Å—Å—ã–ª–∫–∏:');
        if(url) document.execCommand('createLink', false, url);
      }));
      // Tables
      toolbar.appendChild(createButton('‚äû','–¢–∞–±–ª–∏—Ü–∞ 2x2',()=>insertTable(2,2)));
      toolbar.appendChild(createButton('‚äû','–¢–∞–±–ª–∏—Ü–∞ 3x3',()=>insertTable(3,3)));
      toolbar.appendChild(createButton('‚äû','–¢–∞–±–ª–∏—Ü–∞ 4x4',()=>insertTable(4,4)));
      toolbar.appendChild(createButton('‚äû','–¢–∞–±–ª–∏—Ü–∞ —Å —à–∞–ø–∫–æ–π 2x2',()=>insertTable(2,2,true)));
      toolbar.appendChild(createButton('‚äû','–¢–∞–±–ª–∏—Ü–∞ —Å —à–∞–ø–∫–æ–π 3x3',()=>insertTable(3,3,true)));
      toolbar.appendChild(createButton('‚äû','–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É',()=>createCustomTable()));
      // Clear format
      toolbar.appendChild(createButton('‚å´','–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ',()=>document.execCommand('removeFormat',false,null)));

      // Table insertion function
      function insertTable(rows, cols, hasHeader = false) {
        let tableHTML = '<table class="content-table">';
        
        if (hasHeader) {
          tableHTML += '<thead><tr>';
          for(let j = 0; j < cols; j++) {
            tableHTML += '<th>–ó–∞–≥–æ–ª–æ–≤–æ–∫ ' + (j + 1) + '</th>';
          }
          tableHTML += '</tr></thead>';
        }
        
        tableHTML += '<tbody>';
        for(let i = 0; i < rows; i++) {
          tableHTML += '<tr>';
          for(let j = 0; j < cols; j++) {
            tableHTML += '<td>&nbsp;</td>';
          }
          tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table>';
        document.execCommand('insertHTML', false, tableHTML);
      }

      // Custom table creation function
      function createCustomTable() {
        const rows = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:', '3');
        if (!rows || isNaN(rows) || rows <= 0) return;
        
        const cols = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤:', '3');
        if (!cols || isNaN(cols) || cols <= 0) return;
        
        const hasHeader = confirm('–î–æ–±–∞–≤–∏—Ç—å —à–∞–ø–∫—É —Ç–∞–±–ª–∏—Ü—ã?');
        
        insertTable(parseInt(rows), parseInt(cols), hasHeader);
      }

      // Sync handlers
      function sync(){ textarea.value = area.innerHTML; }
      area.addEventListener('input', sync);
      area.addEventListener('blur', sync);
      // Ensure form submit syncs
      const form = textarea.closest('form');
      if(form){ form.addEventListener('submit', sync); }

      // Insert elements
      surround(textarea, wrapper);
      textarea.style.display = 'none';
      wrapper.insertBefore(toolbar, textarea);
      wrapper.insertBefore(area, textarea);
    }
    function style(){
      const css = `.rte-wrapper{border:1px solid #e5e7eb;border-radius:8px;}
      .rte-toolbar{display:flex;gap:6px;padding:6px;border-bottom:1px solid #e5e7eb;background:#f8fafc;border-top-left-radius:8px;border-top-right-radius:8px}
      .rte-btn{background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:4px 8px;cursor:pointer}
      .rte-btn:hover{background:#f3f4f6}
      .rte-area{min-height:220px;padding:10px;border-bottom-left-radius:8px;border-bottom-right-radius:8px}
      .rte-area:focus{outline:none;box-shadow:0 0 0 2px rgba(37,99,235,0.25)}`;
      const tag = document.createElement('style');
      tag.textContent = css;
      document.head.appendChild(tag);
    }
    document.addEventListener('DOMContentLoaded', function(){
      style();
      document.querySelectorAll('textarea.js-rich').forEach(initEditor);
      
      // Initialize all sliders
      initSliders();
    });
    
    // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö —Å–ª–∞–π–¥–µ—Ä–æ–≤
    function initSliders() {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è main.js
      // document.querySelectorAll('.image-gallery').forEach(gallery => {
      //   initSlider(gallery, '.slider-wrapper', '.slider-slide', '.gallery-prev', '.gallery-next', '.gallery-dot', true);
      // });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
      document.querySelectorAll('.announcements-scroll').forEach(scroll => {
        initSlider(scroll, null, '.card', '.slider-btn--left', '.slider-btn--right', null, false);
      });
    }
    
    function initSlider(container, sliderSelector, slideSelector, prevSelector, nextSelector, dotSelector, hasAutoPlay) {
      const slider = sliderSelector ? container.querySelector(sliderSelector) : container;
      const slides = container.querySelectorAll(slideSelector);
      const prevBtn = container.querySelector(prevSelector);
      const nextBtn = container.querySelector(nextSelector);
      const dots = dotSelector ? container.querySelectorAll(dotSelector) : [];
      
      if (!slider || slides.length <= 1) {
        // –°–∫—Ä—ã—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–ª–∞–π–¥
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        if (dots.length > 0) {
          const dotsContainer = dots[0].parentElement;
          if (dotsContainer) dotsContainer.style.display = 'none';
        }
        return;
      }
      
      let currentSlide = 0;
      let autoPlayInterval = null;
      let isUserInteracting = false;
      
      function updateSlider() {
        if (sliderSelector) {
          // –î–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ —Å transform
          slider.style.transform = `translateX(-${currentSlide * 100}%)`;
        } else {
          // –î–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ —Å scroll
          const slideWidth = slides[0].offsetWidth + 24; // 24px gap
          slider.scrollTo({
            left: currentSlide * slideWidth,
            behavior: 'smooth'
          });
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ—á–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        dots.forEach((dot, index) => {
          if (index === currentSlide) {
            dot.classList.add('active');
          } else {
            dot.classList.remove('active');
          }
        });
      }
      
      function nextSlide() {
        currentSlide = (currentSlide + 1) % slides.length;
        updateSlider();
      }
      
      function prevSlide() {
        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
        updateSlider();
      }
      
      function startAutoPlay() {
        if (!hasAutoPlay) return;
        if (autoPlayInterval) clearInterval(autoPlayInterval);
        autoPlayInterval = setInterval(() => {
          if (!isUserInteracting) {
            nextSlide();
          }
        }, 5000);
      }
      
      function stopAutoPlay() {
        if (autoPlayInterval) {
          clearInterval(autoPlayInterval);
          autoPlayInterval = null;
        }
      }
      
      function userInteraction() {
        isUserInteracting = true;
        stopAutoPlay();
        if (hasAutoPlay) {
          setTimeout(() => {
            isUserInteracting = false;
            startAutoPlay();
          }, 10000);
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          nextSlide();
          userInteraction();
        });
      }
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          prevSlide();
          userInteraction();
        });
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–æ—á–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          currentSlide = index;
          updateSlider();
          userInteraction();
        });
      });
      
      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å–∞–Ω–∏–π/—Å–≤–∞–π–ø–æ–≤
      let startX = 0;
      let endX = 0;
      
      slider.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
      });
      
      slider.addEventListener('touchend', (e) => {
        endX = e.changedTouches[0].clientX;
        const diffX = startX - endX;
        
        if (Math.abs(diffX) > 50) {
          if (diffX > 0) {
            nextSlide();
          } else {
            prevSlide();
          }
          userInteraction();
        }
      });
      
      // –ü–∞—É–∑–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –º—ã—à–∏
      if (hasAutoPlay) {
        container.addEventListener('mouseenter', stopAutoPlay);
        container.addEventListener('mouseleave', () => {
          if (!isUserInteracting) {
            startAutoPlay();
          }
        });
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      updateSlider();
      if (hasAutoPlay) {
        startAutoPlay();
      }
    }
  })();
  </script>
<script>
  const loginModal = document.getElementById('loginModal');
  const openLoginBtn = document.getElementById('openLoginModalBtn');
  const closeLoginBtn = document.getElementById('closeLoginModalBtn');
  if (openLoginBtn) {
    openLoginBtn.addEventListener('click', () => { loginModal.style.display = 'flex'; });
  }
  if (closeLoginBtn) {
    closeLoginBtn.addEventListener('click', () => { loginModal.style.display = 'none'; });
  }
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape') loginModal.style.display = 'none'; });
  if (loginModal) loginModal.addEventListener('click', (e) => { if (e.target === loginModal) loginModal.style.display = 'none'; });
</script>
<!-- Image preview modal -->
<div class="modal-backdrop" id="imgPreviewModal" style="align-items:center;justify-content:center;">
  <div class="modal" style="max-width:96vw;background:transparent;box-shadow:none;">
    <img id="imgPreviewEl" src="" alt="Preview" style="width:96vw; height:94vh; object-fit:contain; display:block; margin:0 auto; border-radius:12px;">
  </div>
  <button class="close-btn" id="closeImgPreviewBtn" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="position:fixed;top:16px;right:16px;font-size:26px;">√ó</button>
  <style>
    #imgPreviewModal { display:none; }
  </style>
</div>

<!-- Sidebar Wizard Modal (separate) -->
<div id="sidebarWizardModal" class="wizard-modal" style="display:none;">
  <div class="wizard-backdrop"></div>
  <div class="wizard-container">
    <div class="wizard-header">
      <div class="wizard-title">
        <h2><i class="icon">‚ö°</i> –ú–∞—Å—Ç–µ—Ä –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é</h2>
        <p>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é</p>
      </div>
      <button onclick="closeSidebarWizard()" class="wizard-close"><i class="icon">‚úï</i></button>
    </div>
    <div class="wizard-content">
      <div class="wizard-sidebar">
        <div class="wizard-progress">
          <div class="progress-bar"><div class="progress-fill" id="sidebar-wizard-progress"></div></div>
          <span class="progress-text" id="sidebar-wizard-progress-text">–®–∞–≥ 1</span>
        </div>
        <div class="wizard-steps" id="sidebar-wizard-steps"></div>
      </div>
      <div class="wizard-main">
        <div id="sidebar-wizard-step-content"></div>
        <div class="wizard-actions">
          <button class="btn btn-secondary" id="sidebar-wizard-prev">‚Üê –ù–∞–∑–∞–¥</button>
          <div class="wizard-actions-center" style="display:flex; gap:8px; align-items:center;">
            <button class="btn" id="sidebar-wizard-add-subsection-main" style="background:#10b981; color:#fff;">‚ûï –ü–æ–¥—Ä–∞–∑–¥–µ–ª</button>
            <button class="btn btn-success" id="sidebar-wizard-save"><i class="icon">üíæ</i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <span class="wizard-save-status" id="sidebar-wizard-save-status"></span>
          </div>
          <button class="btn btn-primary" id="sidebar-wizard-next">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
  <style>
    #sidebarWizardModal .wizard-main { display:flex; flex-direction:column; gap:12px; flex:1; overflow:hidden; }
    #sidebarWizardModal #sidebar-wizard-step-content { flex:1; padding:32px; overflow-y:auto; }
    #sidebarWizardModal .field { margin-bottom:12px; }
    #sidebarWizardModal .field label { display:block; font-weight:600; margin-bottom:6px; }
    #sidebarWizardModal .field input, #sidebarWizardModal .field textarea { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
  </style>
  <script>
    function openSidebarWizard(){ if(window.sidebarWizard && typeof window.sidebarWizard.open==='function'){ window.sidebarWizard.open(); } }
    function closeSidebarWizard(){ if(window.sidebarWizard && typeof window.sidebarWizard.close==='function'){ window.sidebarWizard.close(); } }
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –∏ Esc
    document.addEventListener('click', function(e){
      const m = document.getElementById('sidebarWizardModal');
      if (!m) return;
      if (e.target === m.querySelector('.wizard-backdrop')) { closeSidebarWizard(); }
    });
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') { closeSidebarWizard(); }
    });
  </script>
</div>

<!-- –ú–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –°–≤–µ–¥–µ–Ω–∏–π –æ–± –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
<div id="wizard-modal" class="wizard-modal" style="display: none;">
    <div class="wizard-backdrop"></div>
    <div class="wizard-container">
        <div class="wizard-header">
            <div class="wizard-title">
                <h2 id="wizardTitleText"><i class="icon">‚ö°</i> –ú–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
                <p id="wizardSubtitleText">–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</p>
            </div>
            <button onclick="closeWizardModal()" class="wizard-close">
                <i class="icon">‚úï</i>
            </button>
        </div>
        
        <div class="wizard-content">
            <div class="wizard-sidebar">
                <div class="wizard-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="wizard-progress"></div>
                    </div>
                    <span class="progress-text" id="wizard-progress-text">–®–∞–≥ 1 –∏–∑ 16</span>
                </div>
                
                <div class="wizard-steps" id="wizard-steps">
                    <!-- –®–∞–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <div class="wizard-main">
                <div class="wizard-mode-toggle" id="wizard-mode-toggle" style="display: none; padding: 8px 16px; gap: 8px; align-items: center; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
                    <span style="font-weight: 600; color: #374151;">–†–µ–∂–∏–º:</span>
                    <button type="button" id="wizard-mode-normal" class="wizard-mode-btn active" onclick="setWizardMode('normal')" style="padding: 6px 14px; border-radius: 8px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer; font-size: 0.875rem;">–û–±—ã—á–Ω—ã–π</button>
                    <button type="button" id="wizard-mode-tags" class="wizard-mode-btn" onclick="setWizardMode('tags')" style="padding: 6px 14px; border-radius: 8px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer; font-size: 0.875rem;">–¢–µ–≥–∏ (itemprop)</button>
                </div>
                <div class="wizard-step-content" id="wizard-step-content">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∞–≥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <div class="wizard-actions">
                    <button onclick="wizardPrevious()" class="btn btn-secondary" id="wizard-prev" disabled>
                        <i class="icon">‚Üê</i> –ù–∞–∑–∞–¥
                    </button>
                    <div class="wizard-actions-center">
                        <button onclick="saveCurrentStep()" class="btn btn-success" id="wizard-save-current">
                            <i class="icon">üíæ</i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —à–∞–≥
                        </button>
                        <span class="wizard-save-status" id="wizard-save-status"></span>
                    </div>
                    <button onclick="wizardNext()" class="btn btn-primary" id="wizard-next">
                        –î–∞–ª–µ–µ <i class="icon">‚Üí</i>
                    </button>
                    <button onclick="wizardSave()" class="btn btn-success" id="wizard-save" style="display: none;">
                        <i class="icon">üíæ</i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ
                    </button>
                    <button onclick="cleanMissingFiles()" class="btn btn-warning" id="wizard-clean" style="display: none;">
                        <i class="icon">üßπ</i> –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
  (function(){
    const modal = document.getElementById('imgPreviewModal');
    const imgEl = document.getElementById('imgPreviewEl');
    const closeBtn = document.getElementById('closeImgPreviewBtn');
    function open(src){
      if(!modal || !imgEl) return;
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –æ–∫–Ω–æ (—á—Ç–æ–±—ã –º–∞–ª–µ–Ω—å–∫–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Ç–æ–∂–µ —É–≤–µ–ª–∏—á–∏–≤–∞–ª–∏—Å—å)
      imgEl.style.width = '96vw';
      imgEl.style.height = '94vh';
      imgEl.style.objectFit = 'contain';
      imgEl.src = src;
      modal.style.display = 'flex';
    }
    function close(){ if(!modal) return; modal.style.display = 'none'; imgEl.src=''; }
    document.addEventListener('click', function(e){
      const t = e.target;
      if (t && t.classList && t.classList.contains('js-previewable')) {
        const src = t.getAttribute('data-full') || t.getAttribute('src');
        if (src) open(src);
      }
    });
    if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
    if (closeBtn) closeBtn.addEventListener('click', close);
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
    window.openImgPreview = open;
  })();
  </script>

<!-- JavaScript –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è -->
<script>
// –í–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ - v2024.12.19.15.30
// –ö–æ–Ω—Ñ–∏–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–ª–æ–∫–æ–≤ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ ¬´–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏¬ª
const WIZARD_SECTION_HEADERS = {
    main: [
        { key: 'main_title', defaultText: '–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–æ—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫)' },
        { key: 'founder_title', defaultText: '–£—á—Ä–µ–¥–∏—Ç–µ–ª–∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ ¬´–£—á—Ä–µ–¥–∏—Ç–µ–ª–∏¬ª' },
        { key: 'working_hours_title', defaultText: '–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', label: '–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã' },
        { key: 'places_title', defaultText: '–ú–µ—Å—Ç–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', label: '–ú–µ—Å—Ç–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏' },
        { key: 'license_title', defaultText: '–õ–∏—Ü–µ–Ω–∑–∏—è', label: '–õ–∏—Ü–µ–Ω–∑–∏—è' },
        { key: 'accreditation_title', defaultText: '–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è', label: '–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è' }
    ],
    structure: [
        { key: 'structure_council_general_title', defaultText: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ —Ç—Ä—É–¥–æ–≤–æ–≥–æ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∞ –ì–∏–º–Ω–∞–∑–∏–∏', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ' },
        { key: 'structure_council_ped_title', defaultText: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç' },
        { key: 'structure_council_mgmt_title', defaultText: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç' },
        { key: 'management_bodies_title', defaultText: '–û—Ä–≥–∞–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', label: '–û—Ä–≥–∞–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è' }
    ],
    documents: [
        { key: 'page_title', defaultText: '–î–æ–∫—É–º–µ–Ω—Ç—ã', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    education: [
        { key: 'page_title', defaultText: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' },
        { key: 'documents_title', defaultText: '–î–æ–∫—É–º–µ–Ω—Ç—ã', label: '–ë–ª–æ–∫ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª' },
        { key: 'images_title', defaultText: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', label: '–ë–ª–æ–∫ ¬´–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è¬ª' }
    ],
    standards: [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    management: [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    teachers: [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    facilities: [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    scholarships: [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    'paid-services': [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    finance: [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    vacancies: [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ],
    international: [
        { key: 'page_title', defaultText: '', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã' }
    ]
};

// –î–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
const wizardSteps = [
    {
        id: 'main',
        title: '–û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è',
        icon: 'üè¢',
        endpoint: 'main',
        fields: [
            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
            { name: 'full_name', label: '–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'textarea', required: true },
            { name: 'short_name', label: '–°–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'text', required: true },
            { name: 'founding_date', label: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'date', required: true },
            { name: 'location_address', label: '–ê–¥—Ä–µ—Å –º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'textarea', required: true },
            { name: 'contact_phone', label: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'text', required: true },
            { name: 'contact_email', label: '–ê–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'email', required: true },
            { name: 'official_website', label: '–ê–¥—Ä–µ—Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞', type: 'url', required: false },
            { name: 'founder_name', label: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —É—á—Ä–µ–¥–∏—Ç–µ–ª—è', type: 'text', required: true },
            { name: 'founder_address', label: '–ê–¥—Ä–µ—Å —É—á—Ä–µ–¥–∏—Ç–µ–ª—è', type: 'textarea', required: false },
            { name: 'founder_phone', label: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω —É—á—Ä–µ–¥–∏—Ç–µ–ª—è', type: 'text', required: false },
            { name: 'founder_email', label: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ —É—á—Ä–µ–¥–∏—Ç–µ–ª—è', type: 'email', required: false },
            { name: 'founder_website', label: '–°–∞–π—Ç —É—á—Ä–µ–¥–∏—Ç–µ–ª—è', type: 'url', required: false },
            { name: 'social_media', label: '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö', type: 'textarea', required: false },
            { name: 'license_document', label: '–õ–∏—Ü–µ–Ω–∑–∏—è', type: 'file_or_text', required: false },
            { name: 'license_attachment', label: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ –ª–∏—Ü–µ–Ω–∑–∏–∏', type: 'file_or_text', required: false },
            { name: 'accreditation_document', label: '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–∏', type: 'file_or_text', required: false },
            { name: 'main_educational_location', label: '–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ—Å—Ç–æ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', type: 'textarea', required: true },
            { name: 'additional_educational_programs_location', label: '–ú–µ—Å—Ç–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ–≥—Ä–∞–º–º–∞–º', type: 'textarea', required: true },
            { name: 'main_professional_training_location', label: '–ú–µ—Å—Ç–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–æ–≥—Ä–∞–º–º–∞–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è', type: 'textarea', required: true },
            { name: 'network_form_location', label: '–ú–µ—Å—Ç–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–µ—Ç–µ–≤–æ–π —Ñ–æ—Ä–º—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º', type: 'textarea', required: true },
            { name: 'practice_location', label: '–ú–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∞–∫—Ç–∏–∫–∏', type: 'textarea', required: false },
            { name: 'practical_training_location', label: '–ú–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'textarea', required: false },
            { name: 'gia_location', label: '–ú–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –∏—Ç–æ–≥–æ–≤–æ–π –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏', type: 'textarea', required: false }
        ],
        tagsBlocks: [
            { title: '–û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è', fieldNames: ['title', 'full_name', 'short_name', 'founding_date', 'location_address', 'contact_phone', 'contact_email', 'official_website', 'social_media'] },
            { title: '–£—á—Ä–µ–¥–∏—Ç–µ–ª–∏', fieldNames: ['founder_name', 'founder_address', 'founder_phone', 'founder_email', 'founder_website'] },
            { title: '–ú–µ—Å—Ç–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', fieldNames: ['main_educational_location', 'additional_educational_programs_location', 'main_professional_training_location', 'network_form_location', 'practice_location', 'practical_training_location', 'gia_location'] },
            { title: '–õ–∏—Ü–µ–Ω–∑–∏—è –∏ –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è', fieldNames: ['license_document', 'license_attachment', 'accreditation_document'] }
        ],
        content_blocks: true
    },
    {
        id: 'structure',
        title: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –æ—Ä–≥–∞–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π',
        icon: 'üèóÔ∏è',
        endpoint: 'structure',
        fields: [
            { name: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', type: 'textarea', required: false },
            { name: 'head_name', label: '–§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', type: 'text', required: true },
            { name: 'head_position', label: '–î–æ–ª–∂–Ω–æ—Å—Ç—å', type: 'text', required: true },
            { name: 'location', label: '–ú–µ—Å—Ç–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è', type: 'textarea', required: true },
            { name: 'is_branch', label: '–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–ª–∏–∞–ª–æ–º', type: 'text', required: true },
            { name: 'website', label: '–ê–¥—Ä–µ—Å —Å–∞–π—Ç–∞', type: 'url', required: false },
            { name: 'email', label: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞', type: 'email', required: false },
            { name: 'additional_info', label: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', type: 'textarea', required: false },
            { name: 'management_bodies', label: '–û—Ä–≥–∞–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'textarea', required: false },
            // –û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ —Ç—Ä—É–¥–æ–≤–æ–≥–æ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∞ –ì–∏–º–Ω–∞–∑–∏–∏
            { name: 'structure_general_title', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ: –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è', type: 'text', required: true },
            { name: 'structure_general_head_name', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ: –§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', type: 'text', required: true },
            { name: 'structure_general_head_position', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ: –î–æ–ª–∂–Ω–æ—Å—Ç—å', type: 'text', required: true },
            { name: 'structure_general_location', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ: –ú–µ—Å—Ç–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è', type: 'textarea', required: true },
            { name: 'structure_general_is_branch', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ: —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–ª–∏–∞–ª–æ–º', type: 'text', required: true },
            { name: 'structure_general_website', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ: –ê–¥—Ä–µ—Å —Å–∞–π—Ç–∞', type: 'url', required: false },
            { name: 'structure_general_email', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ: –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞', type: 'email', required: false },
            { name: 'structure_general_additional_info', label: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', type: 'textarea', required: false },
            // –ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç
            { name: 'structure_ped_title', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è', type: 'text', required: true },
            { name: 'structure_ped_head_name', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: –§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', type: 'text', required: true },
            { name: 'structure_ped_head_position', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: –î–æ–ª–∂–Ω–æ—Å—Ç—å', type: 'text', required: true },
            { name: 'structure_ped_location', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: –ú–µ—Å—Ç–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è', type: 'textarea', required: true },
            { name: 'structure_ped_is_branch', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–ª–∏–∞–ª–æ–º', type: 'text', required: true },
            { name: 'structure_ped_website', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: –ê–¥—Ä–µ—Å —Å–∞–π—Ç–∞', type: 'url', required: false },
            { name: 'structure_ped_email', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞', type: 'email', required: false },
            { name: 'structure_ped_additional_info', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', type: 'textarea', required: false },
            // –£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç
            { name: 'structure_mgmt_title', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è', type: 'text', required: true },
            { name: 'structure_mgmt_head_name', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç: –§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', type: 'text', required: true },
            { name: 'structure_mgmt_head_position', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç: –î–æ–ª–∂–Ω–æ—Å—Ç—å', type: 'text', required: true },
            { name: 'structure_mgmt_location', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç: –ú–µ—Å—Ç–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è', type: 'textarea', required: true },
            { name: 'structure_mgmt_is_branch', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç: —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–ª–∏–∞–ª–æ–º', type: 'text', required: true },
            { name: 'structure_mgmt_website', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç: –ê–¥—Ä–µ—Å —Å–∞–π—Ç–∞', type: 'url', required: false },
            { name: 'structure_mgmt_email', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç: –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞', type: 'email', required: false },
            { name: 'structure_mgmt_additional_info', label: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', type: 'textarea', required: false }
        ],
        tagsBlocks: [
            { title: '–û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)', fieldNames: ['title', 'text', 'head_name', 'head_position', 'location', 'is_branch', 'website', 'email', 'additional_info', 'management_bodies'] },
            { title: '–û–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ —Ç—Ä—É–¥–æ–≤–æ–≥–æ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∞ –ì–∏–º–Ω–∞–∑–∏–∏', fieldNames: ['structure_general_title', 'structure_general_head_name', 'structure_general_head_position', 'structure_general_location', 'structure_general_is_branch', 'structure_general_website', 'structure_general_email', 'structure_general_additional_info'] },
            { title: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç', fieldNames: ['structure_ped_title', 'structure_ped_head_name', 'structure_ped_head_position', 'structure_ped_location', 'structure_ped_is_branch', 'structure_ped_website', 'structure_ped_email', 'structure_ped_additional_info'] },
            { title: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ–≤–µ—Ç', fieldNames: ['structure_mgmt_title', 'structure_mgmt_head_name', 'structure_mgmt_head_position', 'structure_mgmt_location', 'structure_mgmt_is_branch', 'structure_mgmt_website', 'structure_mgmt_email', 'structure_mgmt_additional_info'] }
        ],
        content_blocks: true
    },
    {
        id: 'documents',
        title: '–î–æ–∫—É–º–µ–Ω—Ç—ã',
        icon: 'üìÑ',
        endpoint: 'documents',
        fields: [
            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤', type: 'textarea', required: false },
            { name: 'charter', label: '–£—Å—Ç–∞–≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'file_or_text', required: true },
            { name: 'charter_date', label: '–£—Å—Ç–∞–≤: –¥–∞—Ç–∞', type: 'text', required: false },
            { name: 'charter_number', label: '–£—Å—Ç–∞–≤: –Ω–æ–º–µ—Ä/–ø—Ä–∏–∫–∞–∑', type: 'text', required: false },
            { name: 'license', label: '–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', type: 'file_or_text', required: true },
            { name: 'license_date', label: '–õ–∏—Ü–µ–Ω–∑–∏—è: –¥–∞—Ç–∞', type: 'text', required: false },
            { name: 'license_number', label: '–õ–∏—Ü–µ–Ω–∑–∏—è: –Ω–æ–º–µ—Ä', type: 'text', required: false },
            { name: 'accreditation', label: '–°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–∏', type: 'file_or_text', required: false },
            { name: 'accreditation_date', label: '–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è: –¥–∞—Ç–∞', type: 'text', required: false },
            { name: 'accreditation_number', label: '–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è: –Ω–æ–º–µ—Ä', type: 'text', required: false },
            { name: 'pvr_students', label: '–ü—Ä–∞–≤–∏–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–∞—Å–ø–æ—Ä—è–¥–∫–∞ –æ–±—É—á–∞—é—â–∏—Ö—Å—è (–≤–æ—Å–ø–∏—Ç–∞–Ω–Ω–∏–∫–æ–≤)', type: 'file_or_text', required: true },
            { name: 'pvr_workers', label: '–ü—Ä–∞–≤–∏–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ç—Ä—É–¥–æ–≤–æ–≥–æ —Ä–∞—Å–ø–æ—Ä—è–¥–∫–∞', type: 'file_or_text', required: true },
            { name: 'collective_agreement', label: '–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä', type: 'file_or_text', required: false },
            { name: 'collective_agreement_date', label: '–ö–æ–ª–¥–æ–≥–æ–≤–æ—Ä: –¥–∞—Ç–∞', type: 'text', required: false },
            { name: 'collective_agreement_number', label: '–ö–æ–ª–¥–æ–≥–æ–≤–æ—Ä: –Ω–æ–º–µ—Ä', type: 'text', required: false },
            { name: 'annual_report', label: '–û—Ç—á–µ—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Å–∞–º–æ–æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–ü—É–±–ª–∏—á–Ω—ã–π –¥–æ–∫–ª–∞–¥)', type: 'file_or_text', required: true },
            { name: 'annual_report_date', label: '–°–∞–º–æ–æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: –¥–∞—Ç–∞', type: 'text', required: false },
            { name: 'annual_report_number', label: '–°–∞–º–æ–æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: –Ω–æ–º–µ—Ä/–ø—Ä–∏–∫–∞–∑', type: 'text', required: false },
            { name: 'financial_statements', label: '–î–æ–∫—É–º–µ–Ω—Ç –æ –ø–æ—Ä—è–¥–∫–µ –æ–∫–∞–∑–∞–Ω–∏—è –ø–ª–∞—Ç–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥', type: 'file_or_text', required: true },
            { name: 'financial_statements_date', label: '–ü–ª–∞—Ç–Ω—ã–µ —É—Å–ª—É–≥–∏: –¥–∞—Ç–∞', type: 'text', required: false },
            { name: 'financial_statements_number', label: '–ü–ª–∞—Ç–Ω—ã–µ —É—Å–ª—É–≥–∏: –Ω–æ–º–µ—Ä/–ø—Ä–∏–∫–∞–∑', type: 'text', required: false },
            { name: 'admission_rules', label: '–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–µ–º–∞ –æ–±—É—á–∞—é—â–∏—Ö—Å—è (–≤–æ—Å–ø–∏—Ç–∞–Ω–Ω–∏–∫–æ–≤)', type: 'file_or_text', required: true },
            { name: 'admission_rules_date', label: '–ü—Ä–∏–µ–º: –¥–∞—Ç–∞', type: 'text', required: false },
            { name: 'admission_rules_number', label: '–ü—Ä–∏–µ–º: –Ω–æ–º–µ—Ä/–ø—Ä–∏–∫–∞–∑', type: 'text', required: false },
            { name: 'education_programs', label: '–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã', type: 'file_or_text', required: true },
            { name: 'curriculum', label: '–£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω', type: 'file_or_text', required: true },
            { name: 'calendar_schedule', label: '–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π —É—á–µ–±–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫', type: 'file_or_text', required: true },
            { name: 'methodological_documents', label: '–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –∏ –∏–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã', type: 'file_or_text', required: false },
            { name: 'local_regulations', label: '–õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –∞–∫—Ç—ã', type: 'file_or_text', required: false },
            { name: 'prescriptions_reports', label: '–ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–æ–≤ –Ω–∞–¥–∑–æ—Ä–∞ –∏ –æ—Ç—á—ë—Ç—ã –æ–± –∏—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏', type: 'file_or_text', required: false },
            { name: 'prescriptions_reports_date', label: '–ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∏—è: –¥–∞—Ç–∞', type: 'text', required: false },
            { name: 'prescriptions_reports_number', label: '–ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∏—è: –Ω–æ–º–µ—Ä', type: 'text', required: false },
            { name: 'training_schedule', label: '–†–µ–∂–∏–º –∑–∞–Ω—è—Ç–∏–π –æ–±—É—á–∞—é—â–∏—Ö—Å—è (–≤–æ—Å–ø–∏—Ç–∞–Ω–Ω–∏–∫–æ–≤)', type: 'file_or_text', required: false },
            { name: 'control_forms', label: '–§–æ—Ä–º—ã, –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏', type: 'file_or_text', required: false },
            { name: 'transfer_reinstatement', label: '–ü–æ—Ä—è–¥–æ–∫ –∏ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞, –æ—Ç—á–∏—Å–ª–µ–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'file_or_text', required: false },
            { name: 'relations_termination', label: '–ü–æ—Ä—è–¥–æ–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π —Å –æ–±—É—á–∞—é—â–∏–º–∏—Å—è –∏ —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏', type: 'file_or_text', required: false },
            { name: 'other_local_acts', label: '–ò–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∞–∫—Ç—ã', type: 'file_or_text', required: false },
            { name: 'students_count_docs', label: '–ß–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'file_or_text', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'education',
        title: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
        icon: 'üéì',
        endpoint: 'education',
        fields: [
            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
            { name: 'implemented_programs', label: '–†–µ–∞–ª–∏–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã', type: 'textarea', required: true },
            { name: 'adapted_programs', label: '–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)', type: 'textarea', required: true },
            { name: 'curriculum_soo', label: '–£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω –°–û–û', type: 'file_with_name', required: true },
            { name: 'curriculum_ooo', label: '–£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω –û–û–û', type: 'file_with_name', required: true },
            { name: 'curriculum_noo', label: '–£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω –ù–û–û', type: 'file_with_name', required: true },
            { name: 'calendar_schedule', label: '–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π —É—á–µ–±–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫', type: 'file_with_name', required: true },
            { name: 'student_numbers_noo', label: '–ß–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å –æ–±—É—á–∞—é—â–∏—Ö—Å—è –ù–û–û', type: 'textarea', required: true },
            { name: 'student_numbers_ooo', label: '–ß–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å –æ–±—É—á–∞—é—â–∏—Ö—Å—è –û–û–û', type: 'textarea', required: true },
            { name: 'student_numbers_soo', label: '–ß–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å –æ–±—É—á–∞—é—â–∏—Ö—Å—è –°–û–û', type: 'textarea', required: true },
            { name: 'student_numbers_document', label: '–î–æ–∫—É–º–µ–Ω—Ç –æ —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'file', required: true },
            { name: 'education_languages', label: '–Ø–∑—ã–∫–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', type: 'file', required: true },
            { name: 'professional_programs', label: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã', type: 'textarea', required: true },
            { name: 'graduate_employment', label: '–¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤', type: 'textarea', required: true }
        ],
        content_blocks: true
    },
    {
        id: 'standards',
        title: '–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è',
        icon: 'üìä',
        endpoint: 'standards',
        fields: [
            { name: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤', type: 'textarea', required: false },
            { name: 'federal_standards', label: '–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã', type: 'textarea', required: true },
            { name: 'federal_requirements', label: '–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è', type: 'textarea', required: false },
            { name: 'local_standards', label: '–õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –∞–∫—Ç—ã, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∏—Ä—É—é—â–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å', type: 'textarea', required: false },
            { name: 'standards_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º', type: 'file', required: false },
            { name: 'requirements_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º', type: 'file', required: false },
            { name: 'implementation_info', label: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤', type: 'textarea', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'management',
        title: '–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ',
        icon: 'üëî',
        endpoint: 'management',
        fields: [
            { name: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞', type: 'textarea', required: false },
            { name: 'director_name', label: '–§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', type: 'text', required: true },
            { name: 'director_position', label: '–î–æ–ª–∂–Ω–æ—Å—Ç—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', type: 'text', required: true },
            { name: 'director_phone', label: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', type: 'text', required: true },
            { name: 'director_email', label: '–ê–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', type: 'email', required: true },
            { name: 'deputy_directors', label: '–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è', type: 'textarea', required: false },
            { name: 'management_structure', label: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è', type: 'textarea', required: false },
            { name: 'management_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'teachers',
        title: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤',
        icon: 'üë®‚Äçüè´',
        endpoint: 'teachers',
        fields: [
            { name: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –ø–µ–¥–∞–≥–æ–≥–æ–≤', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞', type: 'textarea', required: false },
            { name: 'total_teachers', label: '–û–±—â–∞—è —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤', type: 'text', required: true },
            { name: 'teachers_with_education', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ —Å –≤—ã—Å—à–∏–º –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º', type: 'text', required: true },
            { name: 'teachers_with_category', label: '–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ —Å –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π', type: 'text', required: true },
            { name: 'teachers_qualification', label: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤', type: 'textarea', required: false },
            { name: 'teachers_development', label: '–ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤', type: 'textarea', required: false },
            { name: 'teachers_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'facilities',
        title: '–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏ –æ—Å–Ω–∞—â–µ–Ω–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞',
        icon: 'üè´',
        endpoint: 'facilities',
        fields: [
            { name: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –ú–¢–û', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ –ú–¢–û', type: 'textarea', required: false },
            { name: 'buildings_info', label: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–¥–∞–Ω–∏—è—Ö –∏ –ø–æ–º–µ—â–µ–Ω–∏—è—Ö', type: 'textarea', required: true },
            { name: 'library_info', label: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ', type: 'textarea', required: false },
            { name: 'sports_facilities', label: '–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã', type: 'textarea', required: false },
            { name: 'learning_equipment', label: '–°—Ä–µ–¥—Å—Ç–≤–∞ –æ–±—É—á–µ–Ω–∏—è –∏ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è', type: 'textarea', required: false },
            { name: 'catering_conditions', label: '–£—Å–ª–æ–≤–∏—è –ø–∏—Ç–∞–Ω–∏—è –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'textarea', required: false },
            { name: 'health_conditions', label: '–£—Å–ª–æ–≤–∏—è –æ—Ö—Ä–∞–Ω—ã –∑–¥–æ—Ä–æ–≤—å—è –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'textarea', required: false },
            { name: 'accessible_environment', label: '–î–æ—Å—Ç—É–ø–Ω–∞—è —Å—Ä–µ–¥–∞', type: 'textarea', required: false },
            { name: 'facilities_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'paid-services',
        title: '–ü–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏',
        icon: 'üí∞',
        endpoint: 'paid-services',
        fields: [
            { name: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –ø–ª–∞—Ç–Ω—ã—Ö —É—Å–ª—É–≥', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–Ω—ã—Ö —É—Å–ª—É–≥', type: 'textarea', required: false },
            { name: 'services_list', label: '–ü–µ—Ä–µ—á–µ–Ω—å –ø–ª–∞—Ç–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥', type: 'textarea', required: true },
            { name: 'services_prices', label: '–¶–µ–Ω—ã –Ω–∞ –ø–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏', type: 'textarea', required: true },
            { name: 'services_procedure', label: '–ü–æ—Ä—è–¥–æ–∫ –æ–∫–∞–∑–∞–Ω–∏—è –ø–ª–∞—Ç–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥', type: 'textarea', required: true },
            { name: 'services_contract', label: '–û–±—Ä–∞–∑–µ—Ü –¥–æ–≥–æ–≤–æ—Ä–∞ –æ–± –æ–∫–∞–∑–∞–Ω–∏–∏ –ø–ª–∞—Ç–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥', type: 'file', required: false },
            { name: 'services_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –ø–ª–∞—Ç–Ω—ã–º —É—Å–ª—É–≥–∞–º', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'finance',
        title: '–§–∏–Ω–∞–Ω—Å–æ–≤–æ-—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
        icon: 'üìà',
        endpoint: 'finance',
        fields: [
            { name: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', type: 'textarea', required: false },
            { name: 'budget_volume', label: '–û–±—ä–µ–º –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–π –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∑–∞ —Å—á–µ—Ç –±—é–¥–∂–µ—Ç–Ω—ã—Ö –∞—Å—Å–∏–≥–Ω–æ–≤–∞–Ω–∏–π', type: 'textarea', required: true },
            { name: 'extrabudgetary_income', label: '–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ –∏—Ç–æ–≥–∞–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –≥–æ–¥–∞', type: 'textarea', required: false },
            { name: 'extrabudgetary_expenses', label: '–†–∞—Å—Ö–æ–¥—ã –ø–æ –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–º —Å—Ä–µ–¥—Å—Ç–≤–∞–º –ø–æ –∏—Ç–æ–≥–∞–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –≥–æ–¥–∞', type: 'textarea', required: false },
            { name: 'financial_plans', label: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–ª–∞–Ω—ã –∏ –æ—Ç—á–µ—Ç—ã', type: 'file', required: false },
            { name: 'financial_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ-—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'vacancies',
        title: '–í–∞–∫–∞–Ω—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ (–ø–µ—Ä–µ–≤–æ–¥–∞) –æ–±—É—á–∞—é—â–∏—Ö—Å—è',
        icon: 'ü™ë',
        endpoint: 'vacancies',
        fields: [
            { name: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –≤–∞–∫–∞–Ω—Å–∏–π', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Ç–Ω—ã—Ö –º–µ—Å—Ç', type: 'textarea', required: false },
            { name: 'elementary_vacancies', label: '–í–∞–∫–∞–Ω—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ 1-4 –∫–ª–∞—Å—Å–∞—Ö', type: 'textarea', required: true },
            { name: 'basic_vacancies', label: '–í–∞–∫–∞–Ω—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ 5-9 –∫–ª–∞—Å—Å–∞—Ö', type: 'textarea', required: true },
            { name: 'secondary_vacancies', label: '–í–∞–∫–∞–Ω—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ 10-11 –∫–ª–∞—Å—Å–∞—Ö', type: 'textarea', required: true },
            { name: 'special_programs_vacancies', label: '–í–∞–∫–∞–Ω—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–≥—Ä–∞–º–º–∞–º', type: 'textarea', required: false },
            { name: 'vacancies_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –≤–∞–∫–∞–Ω—Ç–Ω—ã–º –º–µ—Å—Ç–∞–º', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'scholarships',
        title: '–°—Ç–∏–ø–µ–Ω–¥–∏–∏ –∏ –º–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—É—á–∞—é—â–∏—Ö—Å—è',
        icon: 'üéì',
        endpoint: 'scholarships',
        fields: [
            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
            { name: 'scholarships_info', label: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∏–ø–µ–Ω–¥–∏—è—Ö', type: 'textarea', required: true },
            { name: 'support_measures', label: '–ú–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'textarea', required: true },
            { name: 'social_support', label: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞', type: 'textarea', required: false },
            { name: 'financial_aid', label: '–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â—å', type: 'textarea', required: false },
            { name: 'scholarship_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –æ —Å—Ç–∏–ø–µ–Ω–¥–∏—è—Ö –∏ –º–µ—Ä–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'international',
        title: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ',
        icon: 'üåç',
        endpoint: 'international',
        fields: [
            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞', type: 'textarea', required: false },
            { name: 'partnerships', label: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞ –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è', type: 'textarea', required: false },
            { name: 'exchange_programs', label: '–ü—Ä–æ–≥—Ä–∞–º–º—ã –æ–±–º–µ–Ω–∞ –æ–±—É—á–∞—é—â–∏–º–∏—Å—è', type: 'textarea', required: false },
            { name: 'joint_projects', label: '–°–æ–≤–º–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã', type: 'textarea', required: false },
            { name: 'international_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'food',
        title: '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–∏—Ç–∞–Ω–∏—è –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏',
        icon: 'üçΩÔ∏è',
        endpoint: 'food',
        fields: [
            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–∏—Ç–∞–Ω–∏—è', type: 'textarea', required: false },
            { name: 'catering_organization', label: '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–∏—Ç–∞–Ω–∏—è –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'textarea', required: true },
            { name: 'catering_menu', label: '–ú–µ–Ω—é –∏ —Ä–∞—Ü–∏–æ–Ω –ø–∏—Ç–∞–Ω–∏—è', type: 'textarea', required: false },
            { name: 'catering_conditions', label: '–£—Å–ª–æ–≤–∏—è –ø–∏—Ç–∞–Ω–∏—è –æ–±—É—á–∞—é—â–∏—Ö—Å—è', type: 'textarea', required: false },
            { name: 'catering_documents', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–∏—Ç–∞–Ω–∏—è', type: 'file', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'projects',
        title: '–ü—Ä–æ–µ–∫—Ç—ã',
        icon: 'üöÄ',
        endpoint: 'projects',
        fields: [
            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤', type: 'textarea', required: false }
        ],
        content_blocks: true
    },
    {
        id: 'albums',
        title: '–§–æ—Ç–æ–∞–ª—å–±–æ–º—ã',
        icon: 'üì∑',
        endpoint: 'albums',
        fields: [
            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
            { name: 'text', label: '–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º–æ–≤', type: 'textarea', required: false }
        ],
        content_blocks: true
    }
];

let currentWizardStep = 0;
let wizardData = {};
window.wizardMode = 'normal';

var WIZARD_ITEMPROP_DEFAULTS = {
    main: { full_name: 'fullName', short_name: 'shortName', founding_date: 'regDate', location_address: 'address', contact_phone: 'telephone', contact_email: 'email', official_website: 'url', visually_impaired_version: 'copy', founder_name: 'nameUchred', founder_address: 'addressUchred', founder_phone: 'telUchred', founder_email: 'mailUchred', founder_website: 'websiteUchred', main_educational_location: 'address', additional_educational_programs_location: 'addressPlaceDop', main_professional_training_location: 'addressPlaceOpp', network_form_location: 'addressPlaceSet', practice_location: 'addressPlacePrac', practical_training_location: 'addressPlacePodg', gia_location: 'addressPlaceGia' },
    documents: { charter: 'ustavDocLink', license: 'licenseDocLink', license_document: 'licenseDocLink', accreditation_document: 'accreditationDocLink' },
    structure: {},
    education: {
        title: 'name',
        implemented_programs: 'eduOp',
        adapted_programs: 'eduAdOp',
        curriculum_noo: 'educationPlan',
        curriculum_ooo: 'educationPlan',
        curriculum_soo: 'educationPlan',
        calendar_schedule: 'educationSchedule',
        student_numbers_noo: 'eduChislenEl',
        student_numbers_ooo: 'eduChislenEl',
        student_numbers_soo: 'eduChislenEl',
        student_numbers_document: 'eduChislenEl',
        education_languages: 'languageEl',
        professional_programs: 'eduOp',
        graduate_employment: 'graduateJob'
    },
    standards: {
        title: 'name',
        federal_standards: 'eduFedDoc',
        federal_requirements: 'eduFedTreb',
        local_standards: 'eduStandartTreb',
        standards_documents: 'eduStandartDoc',
        requirements_documents: 'eduStandartTreb',
        implementation_info: 'eduStandardsInfo'
    },
    management: {
        title: 'name',
        director_name: 'fio',
        director_position: 'post',
        director_phone: 'telephone',
        director_email: 'email',
        deputy_directors: 'deputy',
        management_structure: 'structure',
        management_documents: 'document'
    },
    teachers: {
        title: 'name',
        total_teachers: 'teacherCount',
        teachers_with_education: 'teacherEducation',
        teachers_with_category: 'teacherCategory',
        teachers_qualification: 'qualification',
        teachers_development: 'qualification',
        teachers_documents: 'document'
    },
    facilities: {
        title: 'name',
        buildings_info: 'purposeCab',
        library_info: 'purposeLibr',
        sports_facilities: 'purposeSport',
        learning_equipment: 'purposeFacil',
        catering_conditions: 'purposeEios',
        health_conditions: 'healthConditions',
        accessible_environment: 'ovz',
        facilities_documents: 'document'
    },
    scholarships: {
        title: 'name',
        scholarships_info: 'grant',
        support_measures: 'support',
        social_support: 'support',
        financial_aid: 'support',
        scholarship_documents: 'localAct'
    },
    'paid-services': {
        title: 'name',
        services_list: 'paidEdu',
        services_prices: 'paidSt',
        services_procedure: 'paidEdu',
        services_contract: 'paidDog',
        services_documents: 'paidSt'
    },
    finance: {
        title: 'name',
        budget_volume: 'volume',
        extrabudgetary_income: 'finPost',
        extrabudgetary_expenses: 'finRas',
        financial_plans: 'finPlanDocLink',
        financial_documents: 'document'
    },
    vacancies: {
        title: 'name',
        elementary_vacancies: 'vacant',
        basic_vacancies: 'vacant',
        secondary_vacancies: 'vacant',
        special_programs_vacancies: 'vacant',
        vacancies_documents: 'document'
    },
    international: {
        title: 'name',
        partnerships: 'internationalDog',
        exchange_programs: 'internationalDog',
        joint_projects: 'internationalDog',
        international_documents: 'document'
    },
    food: {
        title: 'name',
        catering_organization: 'cateringInfo',
        catering_menu: 'cateringMenu',
        catering_conditions: 'cateringConditions',
        catering_documents: 'document'
    }
};
function getDefaultItemprop(stepId, fieldName) {
    var stepDefaults = WIZARD_ITEMPROP_DEFAULTS[stepId];
    return (stepDefaults && stepDefaults[fieldName]) ? stepDefaults[fieldName] : '';
}
function setWizardMode(mode) {
    window.wizardMode = mode || 'normal';
    var toggleEl = document.getElementById('wizard-mode-toggle');
    var normalBtn = document.getElementById('wizard-mode-normal');
    var tagsBtn = document.getElementById('wizard-mode-tags');
    if (normalBtn) { normalBtn.classList.toggle('active', window.wizardMode === 'normal'); normalBtn.style.background = window.wizardMode === 'normal' ? '#eff6ff' : '#fff'; normalBtn.style.borderColor = window.wizardMode === 'normal' ? '#3b82f6' : '#e5e7eb'; }
    if (tagsBtn) { tagsBtn.classList.toggle('active', window.wizardMode === 'tags'); tagsBtn.style.background = window.wizardMode === 'tags' ? '#eff6ff' : '#fff'; tagsBtn.style.borderColor = window.wizardMode === 'tags' ? '#3b82f6' : '#e5e7eb'; }
    var step = typeof wizardSteps !== 'undefined' && wizardSteps[currentWizardStep];
    if (step && typeof loadStepContent === 'function') loadStepContent(step);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏

// ===== –§–£–ù–ö–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò –ú–ê–°–¢–ï–†–ê =====

// –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
async function wizardNext() {
    if (currentWizardStep < wizardSteps.length - 1) {
        await saveCurrentStepData();
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è loadStep —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (typeof loadStep === 'function') {
            loadStep(currentWizardStep + 1);
        } else {
            console.error('loadStep function not found');
        }
    }
}

// –ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥
async function wizardPrevious() {
    if (currentWizardStep > 0) {
        await saveCurrentStepData();
        loadStep(currentWizardStep - 1);
    }
}

// –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É
async function goToStep(stepIndex) {
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
    await saveCurrentStepData();
    
    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–æ–≤–æ–º—É —à–∞–≥—É
    loadStep(stepIndex);
}

// –û—á–∏—Å—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
async function cleanOrphanedFiles() {
    try {
        
        const response = await fetch('/info/clean_files', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
            const fileLists = document.querySelectorAll('[id$="_file_list"]');
            fileLists.forEach(fileList => {
                const fileItems = fileList.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    const fileUrl = item.querySelector('.file-url');
                    if (fileUrl) {
                        const url = fileUrl.textContent;
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
                        fetch(url, { method: 'HEAD' })
                            .then(response => {
                                if (!response.ok) {
                                    // –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
                                    item.remove();
                                }
                            })
                            .catch(() => {
                                // –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ, —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
                                item.remove();
                            });
                    }
                });
            });
        } else {
            console.warn('Failed to clean orphaned files:', result.error);
        }
    } catch (error) {
        console.error('Error cleaning orphaned files:', error);
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
async function saveCurrentStepData() {
    const step = wizardSteps[currentWizardStep];
    if (!step) {
        console.error('saveCurrentStepData: Step not found:', currentWizardStep);
        return;
    }
    
    
    // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
    await cleanOrphanedFiles();
    
    if (!wizardData[step.id]) {
        wizardData[step.id] = {};
    }

    if (window.wizardMode === 'tags') {
        var contentContainer = document.getElementById('wizard-step-content');
        if (!contentContainer) return;
        var tagInputs = contentContainer.querySelectorAll('.itemprop-input');
        var mapping = {};
        var invalid = false;
        tagInputs.forEach(function(inp) {
            var name = inp.getAttribute('data-field-name');
            var val = (inp.value || '').trim();
            if (!name) return;
            if (val && !/^[A-Za-z0-9_]+$/.test(val)) { invalid = true; inp.style.borderColor = '#ef4444'; } else { inp.style.borderColor = '#e5e7eb'; if (val) mapping[name] = val; }
        });
        if (invalid) {
            showSaveStatus('error', 'itemprop: —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ _');
            return;
        }
        wizardData[step.id].itemprop_mapping = mapping;
    } else {
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    for (const field of (step.fields || [])) {
        if (field.type === 'file_with_name') {
            // –§–∞–π–ª—ã —Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º –∏–º–µ–Ω–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ handleFileWithName
            // –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º –æ–±—ä–µ–∫—Ç/–º–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ input (C:\fakepath)
            const existingValue = wizardData[step.id][field.name] || [];
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –∏–º–µ–Ω–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –∏—Ö –≤—Ä—É—á–Ω—É—é
            if (Array.isArray(existingValue)) {
                const displayInputs = document.querySelectorAll(`#file-container-${field.name} .file-display-name`);
                displayInputs.forEach((input, index) => {
                    if (existingValue[index]) {
                        existingValue[index].displayName = input.value || existingValue[index].displayName;
                    }
                });
            } else if (existingValue && typeof existingValue === 'object') {
                const displayInput = document.querySelector(`#file-container-${field.name} .file-display-name`);
                if (displayInput) {
                    existingValue.displayName = displayInput.value || existingValue.displayName;
                }
            }
            wizardData[step.id][field.name] = existingValue;
        } else if (field.type === 'file_or_text') {
            // –î–ª—è –ø–æ–ª–µ–π file_or_text —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            const fileElement = document.querySelector(`[name="${field.name}"]`);
            
            if (fileElement && fileElement.files && fileElement.files.length > 0) {
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
                await uploadFiles(fileElement.files, field.name, step.id);
            } else {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                const existingValue = wizardData[step.id][field.name] || '';
                wizardData[step.id][field.name] = existingValue;
            }
        } else if (field.type === 'file') {
            // –î–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const fileElement = document.querySelector(`[name="${field.name}"]`);
            if (fileElement && fileElement.files && fileElement.files.length > 0) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                await uploadFiles(fileElement.files, field.name, step.id);
                // –û—á–∏—â–∞–µ–º input –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                fileElement.value = '';
            } else {
                // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ DOM
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –∞ –Ω–µ –∏–∑ wizardData
                const fileList = document.getElementById(`${field.name}_file_list`);
                if (fileList) {
                    const fileItems = fileList.querySelectorAll('.file-url');
                    const files = Array.from(fileItems).map(item => item.textContent.trim()).filter(url => url);
                    wizardData[step.id][field.name] = files.join(', ');
                } else {
                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ wizardData
                    const existingValue = wizardData[step.id][field.name] || '';
                    wizardData[step.id][field.name] = existingValue;
                }
            }
        } else {
            // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª–µ–π
            const inputElement = document.querySelector(`[name="${field.name}"]`);
            if (inputElement) {
                const value = inputElement.value || '';
                wizardData[step.id][field.name] = value;
            } else {
                console.warn('Field not found:', field.name);
            }
        }
    }
    
    if (typeof WIZARD_SECTION_HEADERS !== 'undefined' && WIZARD_SECTION_HEADERS[step.id]) {
        const headersConfig = WIZARD_SECTION_HEADERS[step.id];
        const collected = {};
        headersConfig.forEach(function(h) {
            const key = h.key;
            const safeKey = (key || '').replace(/"/g, '');
            const textEl = document.getElementById('section-header-' + safeKey + '-text');
            const visibleEl = document.getElementById('section-header-' + safeKey + '-visible');
            collected[key] = { text: textEl ? textEl.value.trim() : '', visible: visibleEl ? visibleEl.checked : true };
        });
        wizardData[step.id].section_headers = collected;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–ª–æ–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (step.content_blocks && wizardData[step.id].content_blocks) {
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–ª–æ–∫–æ–≤ - —É–±–∏—Ä–∞–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ content_blocks
        const blocks = wizardData[step.id].content_blocks;
        if (Array.isArray(blocks)) {
            const normalizedBlocks = blocks.map(block => {
                if (typeof block === 'object' && block !== null) {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ content_blocks
                    const normalized = {};
                    for (const key in block) {
                        if (key !== 'content_blocks') {
                            normalized[key] = block[key];
                        }
                    }
                    return normalized;
                }
                return block;
            });
            wizardData[step.id].content_blocks = normalizedBlocks;
        }
    }
    }
    
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    try {
        const formData = new FormData();
        const dataToSave = {[step.id]: wizardData[step.id]};
        formData.append('wizard_data', JSON.stringify(dataToSave));
        formData.append('save_single', 'true');
        
        
        const response = await fetch('/info/wizard_save', {
            method: 'POST',
            body: formData
        });
        
        const responseData = await response.json();
        
        if (response.ok) {
        } else {
            console.error('Failed to save data to server:', response.statusText, responseData);
        }
    } catch (error) {
        console.error('Error saving data to server:', error);
    }
}


// –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function showSaveStatus(type, message) {
    const statusElement = document.getElementById('wizard-save-status');
    if (!statusElement) return;
    
    // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã
    statusElement.className = 'wizard-save-status';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –∏ —Ç–µ–∫—Å—Ç
    statusElement.classList.add(type);
    statusElement.textContent = message;
    
    // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if (type !== 'error') {
        setTimeout(() => {
            statusElement.className = 'wizard-save-status';
            statusElement.textContent = '';
        }, 3000);
    }
}

// –î—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è —Ñ—É–Ω–∫—Ü–∏—è updateStepStatus —É–¥–∞–ª–µ–Ω–∞





// ===== –§–£–ù–ö–¶–ò–ò –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø –®–ê–ì–û–í =====

let draggedStep = null;

function handleDragStart(e) {
    draggedStep = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
}

function handleStepDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const afterElement = getDragAfterElement(this.parentNode, e.clientY);
    if (afterElement == null) {
        this.parentNode.appendChild(draggedStep);
    } else {
        this.parentNode.insertBefore(draggedStep, afterElement);
    }
}

function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    draggedStep = null;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —à–∞–≥–æ–≤ –≤ –º–∞—Å—Å–∏–≤–µ wizardSteps
    updateWizardStepsOrder();
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.wizard-step:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updateWizardStepsOrder() {
    const stepsContainer = document.getElementById('wizard-steps');
    const stepElements = stepsContainer.querySelectorAll('.wizard-step');
    const newOrder = [];
    
    stepElements.forEach((stepElement, index) => {
        const stepIndex = parseInt(stepElement.getAttribute('data-step'));
        newOrder.push(stepIndex);
    });
    
    // –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ wizardSteps
    const reorderedSteps = newOrder.map(index => wizardSteps[index]);
    wizardSteps.splice(0, wizardSteps.length, ...reorderedSteps);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º data-step –∞—Ç—Ä–∏–±—É—Ç—ã
    stepElements.forEach((stepElement, index) => {
        stepElement.setAttribute('data-step', index);
        stepElement.onclick = () => goToStep(index);
    });
    
}


    // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø HTML-–†–ï–î–ê–ö–¢–û–†–ê =====
    
    // –§—É–Ω–∫—Ü–∏—è insertHtmlTag –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –Ω–∏–∂–µ
    
    // –§—É–Ω–∫—Ü–∏—è updateHtmlPreview –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –Ω–∏–∂–µ
    
    // –§—É–Ω–∫—Ü–∏—è initializeHtmlEditors –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –Ω–∏–∂–µ
    
    // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –§–ê–ô–õ–û–í –° –û–¢–û–ë–†–ê–ñ–ê–ï–ú–´–ú–ò –ò–ú–ï–ù–ê–ú–ò =====

async function handleFileWithName(event, fieldName) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–¥–µ–ª –ø–æ currentWizardStep
        let section = 'main';
        if (!isNaN(currentWizardStep) && wizardSteps[currentWizardStep]) {
            section = wizardSteps[currentWizardStep].endpoint || wizardSteps[currentWizardStep].id || 'main';
        } else {
            // –†–µ–∑–µ—Ä–≤: –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É DOM
            try {
                const activeStep = document.querySelector('.wizard-step.active');
                if (activeStep) {
                    const stepIndex = parseInt(activeStep.getAttribute('data-step'));
                    if (!isNaN(stepIndex) && wizardSteps[stepIndex]) {
                        section = wizardSteps[stepIndex].endpoint || wizardSteps[stepIndex].id || 'main';
                    }
                }
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —à–∞–≥, –∏—Å–ø–æ–ª—å–∑—É–µ–º main');
            }
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
        if (!wizardData[section]) {
            wizardData[section] = {};
        }
        const existingFiles = wizardData[section][fieldName];
        const filesArray = Array.isArray(existingFiles) ? existingFiles : (existingFiles ? [existingFiles] : []);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
        const uploadPromises = Array.from(files).map(async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('section', section);
            formData.append('field_name', fieldName);
            
            try {
            const response = await fetch('/info/upload_file', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                return {
                        success: true,
                    filename: result.filename,
                    originalName: result.original_name,
                    url: result.url,
                    displayName: result.original_name
                };
            } else {
                console.error('Upload failed:', result.error);
                    return {
                        success: false,
                        error: result.error,
                        filename: file.name
                    };
                }
            } catch (error) {
                console.error('Upload error:', error);
                return {
                    success: false,
                    error: error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞',
                    filename: file.name
                };
            }
        });
        
        const uploadResults = await Promise.all(uploadPromises);
        const successfulUploads = uploadResults.filter(f => f.success).map(f => ({
            filename: f.filename,
            originalName: f.originalName,
            url: f.url,
            displayName: f.displayName
        }));
        const failedUploads = uploadResults.filter(f => !f.success);
        
        if (successfulUploads.length > 0) {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
            const allFiles = [...filesArray, ...successfulUploads];
            wizardData[section][fieldName] = allFiles;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateFileWithNameUI(fieldName, allFiles);
            if (failedUploads.length > 0) {
                showSaveStatus('success', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${successfulUploads.length} –∏–∑ ${files.length} —Ñ–∞–π–ª–æ–≤`);
            } else {
            showSaveStatus('success', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${successfulUploads.length} —Ñ–∞–π–ª–æ–≤`);
            }
        } else if (failedUploads.length > 0) {
            // –í—Å–µ —Ñ–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
            const errorMessages = failedUploads.map(f => `${f.filename}: ${f.error}`).join('; ');
            showSaveStatus('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: ' + errorMessages);
        }
    } catch (error) {
        console.error('Error uploading files:', error);
        showSaveStatus('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤');
    }
    
    // –û—á–∏—â–∞–µ–º input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    event.target.value = '';
}

function escapeFileDisplayHtml(s) {
    if (s == null || s === '') return '';
    const t = String(s);
    return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function updateFileWithNameUI(fieldName, filesData) {
    const container = document.getElementById(`file-container-${fieldName}`);
    if (!container) return;
    
    const filesArray = Array.isArray(filesData) ? filesData : (filesData ? [filesData] : []);
    
    container.innerHTML = filesArray.map((fileData, index) => {
        const displayText = fileData.displayName || fileData.originalName || fileData.filename || '–§–∞–π–ª';
        const displayValue = (fileData.displayName || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/&/g, '&amp;');
        return `
        <div class="file-item-with-name" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <div class="file-info" style="display: flex; align-items: center; flex: 1;">
                <i class="file-icon" style="margin-right: 8px; font-size: 16px;">üìÑ</i>
                <span class="file-name" style="color: #2563eb; font-weight: 500;">${escapeFileDisplayHtml(displayText)}</span>
            </div>
            <div class="file-actions" style="display: flex; align-items: center; gap: 8px;">
                <input type="text" class="file-display-name" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è" value="${displayValue}" onchange="updateFileDisplayNameMulti('${fieldName}', ${index}, this.value)" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                <button type="button" class="btn-remove-file" onclick="removeFileWithNameMulti('${fieldName}', ${index})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">√ó</button>
            </div>
        </div>
    `;
    }).join('');
}

function updateFileDisplayName(fieldName, displayName) {
    const step = wizardSteps[currentWizardStep] || {};
    const sectionKey = step.endpoint || step.id || 'main';

    if (!wizardData[sectionKey]) {
        wizardData[sectionKey] = {};
    }
    
    const fileData = wizardData[sectionKey][fieldName];
    if (fileData && typeof fileData === 'object') {
        fileData.displayName = displayName;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const fileNameElement = document.querySelector(`#file-container-${fieldName} .file-name`);
        if (fileNameElement) {
            fileNameElement.textContent = displayName || fileData.filename;
        }
        
    }
}

function updateFileDisplayNameMulti(fieldName, index, displayName) {
    const step = wizardSteps[currentWizardStep] || {};
    const sectionKey = step.endpoint || step.id || 'main';
    
    if (!wizardData[sectionKey]) {
        wizardData[sectionKey] = {};
    }
    
    const filesData = wizardData[sectionKey][fieldName];
    if (Array.isArray(filesData) && filesData[index]) {
        filesData[index].displayName = displayName;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const container = document.getElementById(`file-container-${fieldName}`);
        if (container) {
            const fileItems = container.querySelectorAll('.file-item-with-name');
            if (fileItems[index]) {
                const fileNameElement = fileItems[index].querySelector('.file-name');
                if (fileNameElement) {
                    fileNameElement.textContent = displayName || filesData[index].originalName || filesData[index].filename;
                }
            }
        }
    }
}

function removeFileWithName(fieldName) {
    const step = wizardSteps[currentWizardStep] || {};
    const sectionKey = step.endpoint || step.id || 'main';

    if (!wizardData[sectionKey]) {
        wizardData[sectionKey] = {};
    }
    
    const fileData = wizardData[sectionKey][fieldName];
    const filenameToDelete = fileData && typeof fileData === 'object'
        ? (fileData.filename || (fileData.url ? fileData.url.split('/').filter(Boolean).pop() : null))
        : null;
    if (filenameToDelete) {
        fetch('/info/delete_file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                filename: filenameToDelete,
                section: sectionKey,
                field_name: fieldName
            })
        }).catch(() => {});
    }
    
    wizardData[sectionKey][fieldName] = '';
    
    const container = document.getElementById(`file-container-${fieldName}`);
    if (container) {
        container.innerHTML = '';
    }
}

async function removeFileWithNameMulti(fieldName, index) {
    const step = wizardSteps[currentWizardStep] || {};
    const sectionKey = step.endpoint || step.id || 'main';
    
    if (!wizardData[sectionKey]) {
        wizardData[sectionKey] = {};
    }
    
    const filesData = wizardData[sectionKey][fieldName];
    if (!Array.isArray(filesData) || !filesData[index]) {
        return;
    }
    const fileData = filesData[index];
    const filenameToDelete = fileData.filename || (fileData.url ? fileData.url.split('/').filter(Boolean).pop() : null);
    
    if (filenameToDelete) {
        try {
            const response = await fetch('/info/delete_file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: filenameToDelete,
                    section: sectionKey,
                    field_name: fieldName
                })
            });
            const result = await response.json();
            if (!result.success) {
                console.error('Failed to delete file from server:', result.error);
            }
        } catch (error) {
            console.error('Error deleting file:', error);
        }
    }
    
    filesData.splice(index, 1);
    wizardData[sectionKey][fieldName] = filesData;
    updateFileWithNameUI(fieldName, filesData);
    showSaveStatus('success', '–§–∞–π–ª —É–¥–∞–ª–µ–Ω');
}

// ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ú–ê–°–¢–ï–†–ê =====


// –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function showSaveStatus(type, message) {
    const statusElement = document.getElementById('wizard-save-status');
    if (!statusElement) return;
    
    // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã
    statusElement.className = 'wizard-save-status';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –∏ —Ç–µ–∫—Å—Ç
    statusElement.classList.add(type);
    statusElement.textContent = message;
    
    // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if (type !== 'error') {
        setTimeout(() => {
            statusElement.className = 'wizard-save-status';
            statusElement.textContent = '';
        }, 3000);
    }
}

// –î—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è —Ñ—É–Ω–∫—Ü–∏—è updateStepStatus —É–¥–∞–ª–µ–Ω–∞

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
function openWizard() {
    // openWizard –≤—ã–∑–≤–∞–Ω
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const isAuthenticated = document.body.querySelector('.user-box') !== null;
    if (!isAuthenticated) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        alert('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∞—Å—Ç–µ—Ä—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞
        const loginBtn = document.getElementById('openLoginModalBtn');
        if (loginBtn) {
            loginBtn.click();
        }
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∞—Å—Ç–µ—Ä–∞
    // –Ø–≤–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º sidebar –º–∞—Å—Ç–µ—Ä–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
    window.IS_SIDEBAR_WIZARD = false;
    
    if (typeof window.openWizardModal === 'function') {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º openWizardModal
        window.openWizardModal();
    } else {
        console.error('openWizardModal function not found in base.html');
        alert('–ú–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
    }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞—Å—Ç–µ—Ä–∞
function openWizardModal() {
    // openWizardModal –≤—ã–∑–≤–∞–Ω
    
    try {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–∞—Å—Ç–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
        const titleEl = document.getElementById('wizardTitleText');
        const subtitleEl = document.getElementById('wizardSubtitleText');
        if (window.IS_SIDEBAR_WIZARD === true) {
            if (titleEl) titleEl.innerHTML = '<i class="icon">‚ö°</i> –ú–∞—Å—Ç–µ—Ä –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é';
            if (subtitleEl) subtitleEl.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é';
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —à–∞–≥–∏/–¥–∞–Ω–Ω—ã–µ —Å sidebar –º–∞—Å—Ç–µ—Ä–æ–º
            if (window.sidebarWizardManager && window.wizardManager) {
                try {
                    window.wizardManager.wizardSteps = window.sidebarWizardManager.wizardSteps;
                    window.wizardManager.wizardData = window.sidebarWizardManager.wizardData;
                    window.wizardManager.currentStep = 0;
                    window.wizardSteps = window.sidebarWizardManager.wizardSteps;
                    window.wizardData = window.sidebarWizardManager.wizardData;
                    window.currentWizardStep = 0;
                } catch (e) { console.warn('Sidebar sync failed', e); }
            }
        } else {
            if (titleEl) titleEl.innerHTML = '<i class="icon">‚ö°</i> –ú–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
            if (subtitleEl) subtitleEl.textContent = '–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏';
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        if (typeof wizardSteps === 'undefined') {
            console.error('wizardSteps not defined');
            alert('–î–∞–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }
        
        const modal = document.getElementById('wizard-modal');
        
        if (!modal) {
            console.error('Wizard modal not found');
            alert('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä–∞ (–≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö, —Ç.–∫. —à–∞–≥–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
        if (typeof initializeWizard === 'function') {
            initializeWizard();
        } else {
            console.error('initializeWizard function not found!');
            alert('–§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
        if (typeof loadWizardData === 'function') {
            loadWizardData();
        } else {
            console.error('loadWizardData function not found!');
            alert('–§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
        }
    } catch (error) {
        console.error('Error in openWizardModal:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: ' + error.message);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
function loadWizardData() {
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–∞

    // 1) –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "food" (–ü–∏—Ç–∞–Ω–∏–µ), —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –≤ —Å–ø–∏—Å–∫–µ —à–∞–≥–æ–≤
    const dynamicPromise = fetch('/info/subsections/food')
        .then(r => r.json())
        .then(data => {
            if (!data || !data.success || !Array.isArray(data.subsections)) return;
            const existing = new Set(wizardSteps.map(s => s.endpoint));

            data.subsections.forEach(s => {
                if (!s || !s.endpoint || existing.has(s.endpoint)) return;
                wizardSteps.push({
                    id: s.endpoint,
                    title: s.title || s.endpoint,
                    icon: 'üìÑ',
                    endpoint: s.endpoint,
                    parent: 'food',
                    fields: [
                        { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞', type: 'text', required: true },
                        { name: 'content', label: '–¢–µ–∫—Å—Ç', type: 'textarea', required: false }
                    ],
                    content_blocks: true
                });
                existing.add(s.endpoint);
            });

            // –ü–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Ç–µ–∫—É—â–∏–π —à–∞–≥ –ø–æ endpoint
            try {
                const currentEndpoint = wizardSteps[currentWizardStep]?.endpoint;
                initializeWizard();
                if (currentEndpoint) {
                    const idx = wizardSteps.findIndex(st => st.endpoint === currentEndpoint);
                    if (idx >= 0) loadStep(idx);
                }
            } catch (e) {
                console.warn('Failed to refresh wizard steps after loading food subsections', e);
            }
        })
        .catch(() => {});

    // 2) –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã /p/* (–∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —à–∞–≥–∏)
    const customPagesPromise = fetch('/info/section_data')
        .then(r => r.json())
        .then(data => {
            if (!data || !data.success || !Array.isArray(data.sections)) return;
            const existing = new Set(wizardSteps.map(s => s.endpoint));

            data.sections.forEach(s => {
                try {
                    const url = (s && s.url) ? String(s.url) : '';
                    const endpoint = (s && s.endpoint) ? String(s.endpoint) : '';
                    const title = (s && s.title) ? String(s.title) : endpoint;
                    if (!url.startsWith('/p/')) return;
                    if (!endpoint) return;
                    if (existing.has(endpoint)) return;

                    wizardSteps.push({
                        id: endpoint,
                        title: title || endpoint,
                        icon: 'üß©',
                        endpoint: endpoint,
                        fields: [
                            { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', type: 'text', required: true },
                            { name: 'text', label: '–¢–µ–∫—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)', type: 'textarea', required: false }
                        ],
                        content_blocks: true
                    });
                    existing.add(endpoint);
                } catch (e) {
                    // ignore bad entries
                }
            });
        })
        .catch(() => {});

    Promise.allSettled([dynamicPromise, customPagesPromise]).finally(() => {
        const loadPromises = wizardSteps.map(step => {
            return fetch(`/info/section/${step.endpoint}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.section) {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∞
                        wizardData[step.id] = {
                            title: data.section.title || '',
                            text: data.section.text || '',
                            content_blocks: data.section.content_blocks || []
                        };
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
                        if (data.section.form_data) {
                            Object.assign(wizardData[step.id], data.section.form_data);
                            
                            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
                            Object.keys(data.section.form_data).forEach(fieldName => {
                                const fieldValue = data.section.form_data[fieldName];
                                if (typeof fieldValue === 'string' && fieldValue.trim()) {
                                    if (fieldValue.includes('/download_file/') || fieldValue.includes('/info/download_file/') || fieldValue.includes('/food/')) {
                                        wizardData[step.id][fieldName] = fieldValue;
                                    }
                                }
                            });
                        }
                    } else {
                        wizardData[step.id] = { title: '', text: '', content_blocks: [] };
                    }
                })
                .catch(error => {
                    console.error('Error loading data for step:', step.id, error);
                    wizardData[step.id] = { title: '', text: '', content_blocks: [] };
                });
        });
        
        Promise.all(loadPromises).then(() => {
            // –í—Å–µ –¥–∞–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            try {
                let targetIndex = 0;
                if (window.WIZARD_TARGET_ENDPOINT) {
                    const idx = wizardSteps.findIndex(st => st && st.endpoint === window.WIZARD_TARGET_ENDPOINT);
                    if (idx >= 0) {
                        targetIndex = idx;
                    }
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–µ–ª—å –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    window.WIZARD_TARGET_ENDPOINT = null;
                }
                loadStep(targetIndex);
            } catch (e) {
                console.error('Error selecting wizard step after load:', e);
                loadStep(0);
            }
        });
    });
}

async function createFoodSubsection() {
    try {
        const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞', '–ù–æ–≤—ã–π –ø–æ–¥—Ä–∞–∑–¥–µ–ª');
        const cleanTitle = String(title || '').trim();
        if (!cleanTitle) return;

        const res = await fetch('/info/create_subsection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ parent_endpoint: 'food', title: cleanTitle })
        });
        const data = await res.json();
        if (!data || !data.success || !data.section || !data.section.endpoint) {
            alert((data && data.error) ? data.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª');
            return;
        }

        const endpoint = data.section.endpoint;
        const stepObj = {
            id: endpoint,
            title: data.section.title || cleanTitle,
            icon: 'üìÑ',
            endpoint,
            parent: 'food',
            fields: [
                { name: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞', type: 'text', required: true },
                { name: 'content', label: '–¢–µ–∫—Å—Ç', type: 'textarea', required: false }
            ],
            content_blocks: true
        };

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ "food" –∏ –µ–≥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤
        const foodIdx = wizardSteps.findIndex(s => s.endpoint === 'food');
        let insertAt = foodIdx >= 0 ? foodIdx + 1 : wizardSteps.length;
        for (let i = insertAt; i < wizardSteps.length; i++) {
            if (wizardSteps[i].parent === 'food') {
                insertAt = i + 1;
            } else {
                break;
            }
        }
        wizardSteps.splice(insertAt, 0, stepObj);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        wizardData[endpoint] = {
            title: stepObj.title,
            text: '',
            content: '',
            parent: 'food',
            content_blocks: []
        };

        // –ü–µ—Ä–µ—Ä–∏—Å—É–µ–º –∏ –ø–µ—Ä–µ–π–¥–µ–º –Ω–∞ –Ω–æ–≤—ã–π —à–∞–≥
        initializeWizard();
        loadStep(insertAt);
    } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
    }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞—Å—Ç–µ—Ä–∞

// –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function handleDragLeave(event) {
    event.currentTarget.classList.remove('drag-over');
}

async function handleFileDrop(event, fieldName) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    const files = event.dataTransfer.files;
    if (files && files.length > 0) {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–µ—Ä–µ–∑ addFileToList)
        const step = wizardSteps[currentWizardStep];
        await uploadFiles(files, fieldName, step ? step.id : currentWizardStep);
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º loadStepContent, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
    }
}

async function handleFileSelect(event, fieldName) {
    const files = event.target.files;
    if (files && files.length > 0) {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–µ—Ä–µ–∑ addFileToList)
        const step = wizardSteps[currentWizardStep];
        await uploadFiles(files, fieldName, step ? step.id : currentWizardStep);
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º loadStepContent, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
    }
}

function handleFiles(files, fieldName) {
    const fileList = document.getElementById(`${fieldName}_file_list`);
    if (!fileList) return;
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã (—Ç–æ–ª—å–∫–æ URL, –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏)
    const existingFiles = Array.from(fileList.querySelectorAll('.file-item')).map(item => {
        const urlSpan = item.querySelector('.file-url');
        return urlSpan ? urlSpan.textContent : null;
    }).filter(url => url && !url.includes('C:\\fakepath\\'));
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
    Array.from(files).forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        const newIndex = existingFiles.length + index;
        fileItem.innerHTML = `
            <div class="file-info">
                <i class="file-icon">${getFileIcon(file.type)}</i>
                <span class="file-name">${file.name}</span>
                <span class="file-size">(${formatFileSize(file.size)})</span>
            </div>
            <button type="button" class="file-remove" onclick="removeFile('${fieldName}', ${newIndex})">√ó</button>
        `;
        fileList.appendChild(fileItem);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º wizardData —Ç–æ–ª—å–∫–æ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ URL —Ñ–∞–π–ª–æ–≤
    if (!wizardData[currentWizardStep]) {
        wizardData[currentWizardStep] = {};
    }
    wizardData[currentWizardStep][fieldName] = existingFiles.join(', ');
    
    // –§–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø–æ–ª–µ
}

function getFileIcon(fileType) {
    if (fileType.includes('pdf')) return 'üìÑ';
    if (fileType.includes('word') || fileType.includes('document')) return 'üìù';
    if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìä';
    if (fileType.includes('image')) return 'üñºÔ∏è';
    if (fileType.includes('text')) return 'üìÑ';
    return 'üìé';
}

function getFileIconFromUrl(url) {
    const fileName = url.split('/').pop();
    const extension = fileName.split('.').pop().toLowerCase();
    
    if (extension === 'pdf') return 'üìÑ';
    if (['doc', 'docx'].includes(extension)) return 'üìù';
    if (['xls', 'xlsx'].includes(extension)) return 'üìä';
    if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) return 'üñºÔ∏è';
    if (extension === 'txt') return 'üìÑ';
    return 'üìé';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

async function removeFile(fieldName, index) {
    const fileList = document.getElementById(`${fieldName}_file_list`);
    const fileItems = fileList.querySelectorAll('.file-item');
    
    if (fileItems[index]) {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        const fileItem = fileItems[index];
        const fileUrl = fileItem.querySelector('.file-url').textContent;
        // –ò–∑–≤–ª–µ–∫–∞–µ–º URL —á–∞—Å—Ç—å –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ url|display_name
        const urlPart = fileUrl.includes('|') ? fileUrl.split('|')[0].trim() : fileUrl;
        const fileName = urlPart.split('/').pop();
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª –∏–∑ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, /download_file/main/filename.pdf -> main)
        const section = urlPart.split('/')[2]; // /download_file/section/filename –∏–ª–∏ /info/download_file/section/filename
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
        try {
            const response = await fetch('/info/delete_file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: fileName,
                    section: section,
                    field_name: fieldName
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
                fileItem.remove();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º wizardData
                const remainingFiles = Array.from(fileList.querySelectorAll('.file-item')).map(item => {
                    const urlSpan = item.querySelector('.file-url');
                    return urlSpan ? urlSpan.textContent.trim() : null;
                }).filter(url => url && !url.includes('C:\\fakepath\\'));
                
                if (!wizardData[currentWizardStep]) {
                    wizardData[currentWizardStep] = {};
                }
                
                wizardData[currentWizardStep][fieldName] = remainingFiles.join(', ');
                
                // wizardData –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ñ–∞–π–ª–æ–≤
                const remainingItems = fileList.querySelectorAll('.file-item');
                remainingItems.forEach((item, newIndex) => {
                    const removeBtn = item.querySelector('.file-remove');
                    if (removeBtn) {
                        removeBtn.setAttribute('onclick', `removeFile('${fieldName}', ${newIndex})`);
                    }
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏
                showSaveStatus('success', '–§–∞–π–ª —É–¥–∞–ª–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
                
            } else {
                console.error('Error deleting file:', result.error);
                showSaveStatus('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + result.error);
            }
            
        } catch (error) {
            console.error('Error deleting file:', error);
            showSaveStatus('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
        }
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
async function uploadFiles(files, fieldName, stepId) {
    const step = wizardSteps.find(s => s.id === stepId);
    const section = step ? step.endpoint : 'general';
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –∏–∑ wizardData
    const existingFiles = wizardData[stepId] && wizardData[stepId][fieldName] ? 
        wizardData[stepId][fieldName].split(',').map(url => url.trim()).filter(url => url) : [];
    
    const uploadPromises = Array.from(files).map(async (file) => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('section', section);
        formData.append('field_name', fieldName);
        
        try {
            const response = await fetch('/info/upload_file', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            if (result.success) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º display_name –∏–∑ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ original_name –∏–ª–∏ filename
                const displayName = result.display_name || result.original_name || result.filename;
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å display_name –≤ —Ñ–æ—Ä–º–∞—Ç–µ url|display_name
                const urlWithName = result.display_name ? `${result.url}|${result.display_name}` : result.url;
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏)
                const wasAdded = addFileToList(fieldName, displayName, urlWithName, result.is_image);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω (–Ω–µ –±—ã–ª –¥—É–±–ª–∏–∫–∞—Ç–æ–º)
                if (wasAdded) {
                    return { success: true, url: urlWithName, filename: displayName };
                } else {
                    // –§–∞–π–ª —É–∂–µ –±—ã–ª –≤ —Å–ø–∏—Å–∫–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    return { success: false, error: '–§–∞–π–ª —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω', filename: file.name, skipped: true };
                }
            } else {
                console.error('Upload failed:', result.error);
                return { success: false, error: result.error, filename: file.name };
            }
        } catch (error) {
            console.error('Upload error:', error);
            return { success: false, error: error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', filename: file.name };
        }
    });
    
    try {
        const uploadResults = await Promise.all(uploadPromises);
        // –§–∏–ª—å—Ç—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ (–∏—Å–∫–ª—é—á–∞–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã)
        const successfulUploads = uploadResults.filter(r => r.success && !r.skipped).map(r => r.url);
        const failedUploads = uploadResults.filter(r => !r.success && !r.skipped);
        const skippedUploads = uploadResults.filter(r => r.skipped);
        
        if (successfulUploads.length > 0) {
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã —Å –Ω–æ–≤—ã–º–∏
            // successfulUploads —É–∂–µ —Å–æ–¥–µ—Ä–∂–∞—Ç URL —Å display_name –≤ —Ñ–æ—Ä–º–∞—Ç–µ url|display_name
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ existingFiles
            const newFiles = successfulUploads.filter(newUrl => {
                const newUrlPart = newUrl.includes('|') ? newUrl.split('|')[0].trim() : newUrl;
                return !existingFiles.some(existingUrl => {
                    const existingUrlPart = existingUrl.includes('|') ? existingUrl.split('|')[0].trim() : existingUrl;
                    return existingUrlPart === newUrlPart;
                });
            });
            const allFiles = [...existingFiles, ...newFiles];
            wizardData[stepId][fieldName] = allFiles.join(', ');
            if (skippedUploads.length > 0 && newFiles.length > 0) {
                showSaveStatus('success', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${newFiles.length} —Ñ–∞–π–ª–æ–≤, ${skippedUploads.length} –ø—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏–∫–∞—Ç—ã)`);
            } else if (skippedUploads.length > 0 && newFiles.length === 0) {
                showSaveStatus('warning', `–í—Å–µ —Ñ–∞–π–ª—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (–¥—É–±–ª–∏–∫–∞—Ç—ã)`);
            } else if (failedUploads.length > 0) {
                showSaveStatus('success', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${newFiles.length} –∏–∑ ${files.length} —Ñ–∞–π–ª–æ–≤`);
            } else {
                showSaveStatus('success', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${newFiles.length} —Ñ–∞–π–ª–æ–≤`);
            }
        } else if (failedUploads.length > 0) {
            // –í—Å–µ —Ñ–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
            const errorMessages = failedUploads.map(f => `${f.filename}: ${f.error}`).join('; ');
            showSaveStatus('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: ' + errorMessages);
        }
    } catch (error) {
        console.error('Error uploading files:', error);
        showSaveStatus('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤');
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω, false –µ—Å–ª–∏ –±—ã–ª –¥—É–±–ª–∏–∫–∞—Ç–æ–º
function addFileToList(fieldName, filename, url, isImage = false) {
    const fileList = document.getElementById(`${fieldName}_file_list`);
    if (!fileList) return false;
    
    // URL –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ url|display_name –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ url
    const urlPart = url.includes('|') ? url.split('|')[0].trim() : url;
    const displayName = url.includes('|') ? url.split('|')[1].trim() : filename;
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    const urlFilename = urlPart.split('/').pop();
    const normalizeFilename = (name) => {
        if (!name) return '';
        // –£–±–∏—Ä–∞–µ–º —Å—É—Ñ—Ñ–∏–∫—Å—ã _2, _3 –∏ —Ç.–¥. –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        const parts = name.split('.');
        const ext = parts.length > 1 ? '.' + parts.pop().toLowerCase() : '';
        let base = parts.join('.');
        const baseParts = base.split('_');
        if (baseParts.length > 1 && /^\d+$/.test(baseParts[baseParts.length - 1])) {
            baseParts.pop();
            base = baseParts.join('_');
        }
        return (base + ext).toLowerCase();
    };
    const normalizedUrlFilename = normalizeFilename(urlFilename);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Å–ø–∏—Å–∫–µ (–ø–æ –ø–æ–ª–Ω–æ–º—É URL –∏ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞)
    const existingItems = fileList.querySelectorAll('.file-url');
    for (let item of existingItems) {
        const existingUrl = item.textContent.trim();
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –ø–æ–ª–Ω–æ–≥–æ URL (–≤–∫–ª—é—á–∞—è display_name)
        if (existingUrl === url) {
            // –§–∞–π–ª —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ —Å —Ç–µ–º –∂–µ URL –∏ display_name, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
            console.log(`–§–∞–π–ª —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ URL), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º: ${url}`);
            return false;
        }
        // –ò–∑–≤–ª–µ–∫–∞–µ–º URL —á–∞—Å—Ç—å –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ url|display_name –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        const existingUrlPart = existingUrl.includes('|') ? existingUrl.split('|')[0].trim() : existingUrl;
        const existingFilename = existingUrlPart.split('/').pop();
        const normalizedExistingFilename = normalizeFilename(existingFilename);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é URL —á–∞—Å—Ç–∏ (–±–µ–∑ display_name) –∏–ª–∏ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        if (existingUrlPart === urlPart || normalizedExistingFilename === normalizedUrlFilename) {
            // –§–∞–π–ª —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
            console.log(`–§–∞–π–ª —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º: ${url} (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π: ${existingUrl})`);
            return false;
        }
    }
    
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin: 4px 0; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;';
    
    const fileInfo = document.createElement('div');
    fileInfo.style.cssText = 'display: flex; align-items: center; flex: 1;';
    
    // –ò–∫–æ–Ω–∫–∞ —Ñ–∞–π–ª–∞
    const fileIcon = document.createElement('span');
    fileIcon.style.cssText = 'margin-right: 8px; font-size: 16px;';
    if (isImage) {
        fileIcon.textContent = 'üñºÔ∏è';
    } else {
        fileIcon.textContent = 'üìÑ';
    }
    
    // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª
    const fileLink = document.createElement('a');
    fileLink.href = urlPart;
    fileLink.textContent = displayName;
    fileLink.style.cssText = 'color: #2563eb; text-decoration: none; font-weight: 500;';
    fileLink.target = '_blank';
    
    // –°–∫—Ä—ã—Ç—ã–π span —Å –ø–æ–ª–Ω—ã–º URL (–≤–∫–ª—é—á–∞—è display_name) –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const urlSpan = document.createElement('span');
    urlSpan.className = 'file-url';
    urlSpan.textContent = url; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç url|display_name
    urlSpan.style.display = 'none';
    
    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
    const removeBtn = document.createElement('button');
    removeBtn.textContent = '√ó';
    removeBtn.className = 'file-remove';
    removeBtn.style.cssText = 'background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; margin-left: 8px;';
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    const currentItems = fileList.querySelectorAll('.file-item');
    const index = currentItems.length;
    removeBtn.setAttribute('onclick', `removeFile('${fieldName}', ${index})`);
    
    fileInfo.appendChild(fileIcon);
    fileInfo.appendChild(fileLink);
    fileInfo.appendChild(urlSpan);
    
    fileItem.appendChild(fileInfo);
    fileItem.appendChild(removeBtn);
    
    fileList.appendChild(fileItem);
    return true; // –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω
}

function closeWizardModal() {
    const modal = document.getElementById('wizard-modal');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    // –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö
    currentWizardStep = 0;
    wizardData = {};
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä–∞
function initializeWizard() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä–∞
    // –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–≥–æ–≤ –≤ —Å–∞–π–¥–±–∞—Ä–µ
    const stepsContainer = document.getElementById('wizard-steps');
    stepsContainer.innerHTML = '';
    
    wizardSteps.forEach((step, index) => {
        const stepElement = document.createElement('div');
        stepElement.className = 'wizard-step';
        stepElement.setAttribute('data-step', index);
        stepElement.setAttribute('draggable', 'true');
        stepElement.onclick = () => goToStep(index);

        const isFoodSubsection = step.parent === 'food';
        if (isFoodSubsection) {
            stepElement.style.marginLeft = '14px';
            stepElement.style.borderLeft = '3px solid rgba(102, 126, 234, 0.35)';
        }
        
        stepElement.innerHTML = `
            <div class="wizard-step-icon">${index + 1}</div>
            <div class="wizard-step-text">${step.title}</div>
            ${isFoodSubsection ? `<button type="button" class="wizard-step-delete" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª"
                style="margin-left:auto; background:#ef4444; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-weight:800;">üóëÔ∏è</button>` : ''}
            <div class="wizard-step-drag-handle">‚ãÆ‚ãÆ</div>
        `;

        if (isFoodSubsection) {
            const delBtn = stepElement.querySelector('.wizard-step-delete');
            if (delBtn) {
                delBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const endpoint = step.endpoint;
                    if (!endpoint) return;
                    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª "${step.title}"?`)) return;
                    try {
                        const res = await fetch('/info/delete_subsection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ endpoint })
                        });
                        const result = await res.json();
                        if (!result.success) {
                            alert(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞');
                            return;
                        }

                        // –£–¥–∞–ª—è–µ–º —à–∞–≥ –∏ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–º—è—Ç–∏
                        const idxToRemove = wizardSteps.findIndex(s => s.endpoint === endpoint);
                        if (idxToRemove >= 0) {
                            wizardSteps.splice(idxToRemove, 1);
                        }
                        delete wizardData[endpoint];

                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–∞–∑–¥–µ–ª—É food
                        initializeWizard();
                        const foodIdx = wizardSteps.findIndex(s => s.endpoint === 'food');
                        if (foodIdx >= 0) loadStep(foodIdx);
                    } catch (err) {
                        console.error(err);
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                };
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        stepElement.addEventListener('dragstart', handleDragStart);
        stepElement.addEventListener('dragover', handleStepDragOver);
        stepElement.addEventListener('drop', handleDrop);
        stepElement.addEventListener('dragend', handleDragEnd);
        
        stepsContainer.appendChild(stepElement);
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
    loadStep(0);
    // –ú–∞—Å—Ç–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–≥–∞
function loadStep(stepIndex) {
    // loadStep –≤—ã–∑–≤–∞–Ω
    currentWizardStep = stepIndex;
    const step = wizardSteps[stepIndex];
    
    if (!step) {
        console.error('Step not found:', stepIndex);
        return;
    }
    
    // –®–∞–≥ –Ω–∞–π–¥–µ–Ω
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —à–∞–≥–∞
    document.querySelectorAll('.wizard-step').forEach((el, index) => {
        el.classList.remove('active', 'completed');
        if (index === stepIndex) {
            el.classList.add('active');
        } else if (index < stepIndex) {
            el.classList.add('completed');
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const progress = ((stepIndex + 1) / wizardSteps.length) * 100;
    document.getElementById('wizard-progress').style.width = progress + '%';
    document.getElementById('wizard-progress-text').textContent = `–®–∞–≥ ${stepIndex + 1} –∏–∑ ${wizardSteps.length}`;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
    document.getElementById('wizard-prev').disabled = stepIndex === 0;
    document.getElementById('wizard-next').style.display = stepIndex < wizardSteps.length - 1 ? 'flex' : 'none';
    document.getElementById('wizard-save').style.display = stepIndex === wizardSteps.length - 1 ? 'flex' : 'none';
    document.getElementById('wizard-save-current').style.display = 'flex';
    document.getElementById('wizard-clean').style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –Ω–∞ –≤—Å–µ—Ö —à–∞–≥–∞—Ö
    
    // –í—ã–∑–æ–≤ loadStepContent
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —à–∞–≥–∞
    loadStepContent(step);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —à–∞–≥–∞
function loadStepContent(step) {
    const contentContainer = document.getElementById('wizard-step-content');
    if (!contentContainer) return;

    var toggleEl = document.getElementById('wizard-mode-toggle');
    if (toggleEl) toggleEl.style.display = 'flex';

    if (window.wizardMode === 'tags') {
        if (!wizardData[step.id]) wizardData[step.id] = {};
        if (!wizardData[step.id].itemprop_mapping) wizardData[step.id].itemprop_mapping = {};
        var mapping = wizardData[step.id].itemprop_mapping;
        var fields = step.fields || [];
        var fieldByName = {};
        fields.forEach(function(f) { fieldByName[f.name] = f; });
        function makeRow(field) {
            var value = wizardData[step.id][field.name];
            var hasValue = value !== undefined && value !== null && value !== '' && (typeof value !== 'object' || (Array.isArray(value) ? value.length > 0 : Object.keys(value).length > 0));
            if (!hasValue && !field.required) return '';
            var preview = (typeof value === 'string') ? (value.length > 60 ? value.substring(0, 60) + '‚Ä¶' : value) : (typeof value === 'object' ? JSON.stringify(value).substring(0, 60) + '‚Ä¶' : '');
            var currentItemprop = (mapping && mapping[field.name]) || getDefaultItemprop(step.id, field.name);
            var defaultHint = getDefaultItemprop(step.id, field.name) ? (' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ' + getDefaultItemprop(step.id, field.name)) : '';
            return '<div class="wizard-tags-row" style="display:flex;flex-wrap:wrap;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #e5e7eb;">' +
                '<div style="flex:1;min-width:180px;"><strong>' + (field.label || field.name) + '</strong><div style="font-size:0.8rem;color:#6b7280;margin-top:4px;" title="' + (preview || '').replace(/"/g, '&quot;') + '">' + (preview || '‚Äî') + '</div></div>' +
                '<div style="min-width:160px;"><input type="text" class="wizard-input itemprop-input" data-field-name="' + (field.name || '').replace(/"/g, '&quot;') + '" value="' + (currentItemprop || '').replace(/"/g, '&quot;').replace(/</g, '&lt;') + '" placeholder="itemprop" pattern="[A-Za-z0-9_]+" title="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid #e5e7eb;" /></div>' +
                '<div style="font-size:0.75rem;color:#9ca3af;">' + defaultHint + '</div></div>';
        }
        var html = '<div class="wizard-tags-view"><h4 style="margin:0 0 12px 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ itemprop –¥–ª—è –ø–æ–ª–µ–π —Ä–∞–∑–¥–µ–ª–∞</h4><p style="color:#6b7280;font-size:0.875rem;margin:0 0 16px 0;">–ò–∑–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ itemprop –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è (—Ç–æ–ª—å–∫–æ A‚ÄìZ, a‚Äìz, 0‚Äì9, _).</p>';
        if (step.tagsBlocks && step.tagsBlocks.length > 0) {
            var usedNames = {};
            step.tagsBlocks.forEach(function(block) {
                var blockRows = [];
                (block.fieldNames || []).forEach(function(fn) {
                    var field = fieldByName[fn];
                    if (field) { usedNames[fn] = true; var r = makeRow(field); if (r) blockRows.push(r); }
                });
                if (blockRows.length > 0) {
                    html += '<div class="wizard-tags-block" style="margin-top:20px;"><h5 style="margin:0 0 10px 0;padding:8px 0;border-bottom:2px solid #3b82f6;color:#1e40af;font-size:1rem;">' + (block.title || '').replace(/</g, '&lt;') + '</h5>' + blockRows.join('') + '</div>';
                }
            });
            fields.forEach(function(field) {
                if (!usedNames[field.name]) {
                    var r = makeRow(field);
                    if (r) {
                        if (!html.includes('wizard-tags-other')) {
                            html += '<div class="wizard-tags-other" style="margin-top:20px;"><h5 style="margin:0 0 10px 0;padding:8px 0;border-bottom:2px solid #9ca3af;color:#6b7280;font-size:1rem;">–ü—Ä–æ—á–µ–µ</h5>';
                        }
                        html += r;
                    }
                }
            });
            if (html.includes('wizard-tags-other')) html += '</div>';
        } else {
            var rows = [];
            fields.forEach(function(field) { var r = makeRow(field); if (r) rows.push(r); });
            html += rows.length ? rows.join('') : '<p style="color:#6b7280;">–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∂–∏–º–µ ¬´–û–±—ã—á–Ω—ã–π¬ª –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.</p>';
        }
        html += '</div>';
        contentContainer.innerHTML = html;
        return;
    }

    let fieldsHtml = '';
    (step.fields || []).forEach(field => {
        const value = wizardData[step.id]?.[field.name] || '';
        const required = field.required ? 'required' : '';
        
        if (field.type === 'textarea') {
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä textarea –¥–ª—è –ø–æ–ª–µ–π –≤–∞–∫–∞–Ω—Å–∏–π
            const isVacancyField = field.name && (field.name.includes('vacancies') || field.name.includes('vacancy'));
            const rows = isVacancyField ? '8' : '4';
            fieldsHtml += `
                <div class="wizard-field">
                    <label class="wizard-label">
                        <i class="icon">üìù</i> ${field.label}
                        ${field.required ? '<span class="required">*</span>' : ''}
                    </label>
                    <textarea name="${field.name}" class="wizard-input" rows="${rows}" ${required}>${value}</textarea>
                </div>
            `;
        } else if (field.type === 'file') {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (—Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—è—Ç—ã–º–∏)
            // –§–æ—Ä–º–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å: url –∏–ª–∏ url|display_name
            const fileUrls = value ? value.split(',').map(url => url.trim()).filter(url => url && !url.includes('C:\\fakepath\\')) : [];
            const fileListHtml = fileUrls.map((fileUrl, index) => {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º URL –∏ display_name –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ url|display_name
                const urlPart = fileUrl.includes('|') ? fileUrl.split('|')[0].trim() : fileUrl;
                const displayName = fileUrl.includes('|') ? fileUrl.split('|')[1].trim() : fileUrl.split('/').pop();
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ URL –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞
                const fileName = urlPart.split('/').pop();
                const isImage = /\.(jpg|jpeg|png|gif|bmp|tiff)$/i.test(fileName);
                const fileIcon = isImage ? 'üñºÔ∏è' : 'üìÑ';
                return `<div class="file-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin: 4px 0; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                    <div class="file-info" style="display: flex; align-items: center; flex: 1;">
                        <span style="margin-right: 8px; font-size: 16px;">${fileIcon}</span>
                        <a href="${urlPart}" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">${displayName}</a>
                        <span class="file-url" style="display: none;">${fileUrl}</span>
                    </div>
                    <button type="button" class="file-remove" onclick="removeFile('${field.name}', ${index})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; margin-left: 8px;">√ó</button>
                </div>`;
            }).join('');
            
            fieldsHtml += `
                <div class="wizard-field">
                    <label class="wizard-label">
                        <i class="icon">üìé</i> ${field.label}
                        ${field.required ? '<span class="required">*</span>' : ''}
                    </label>
                    <div class="file-upload-container" id="${field.name}_upload_container">
                        <div class="file-drop-zone" id="${field.name}_drop_zone" ondrop="handleFileDrop(event, '${field.name}')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="drop-zone-content">
                                <i class="icon">üìÅ</i>
                                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ <span class="file-select-link" onclick="document.getElementById('${field.name}_file_input').click()">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</span></p>
                                <p class="file-types">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, GIF, SIG, ZIP, RAR, 7Z, TAR, GZ</p>
                            </div>
                        </div>
                        <input type="file" id="${field.name}_file_input" name="${field.name}" class="wizard-input" multiple style="display: none;" onchange="handleFileSelect(event, '${field.name}')" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.sig,.zip,.rar,.7z,.tar,.gz,.tgz">
                        <div class="file-list" id="${field.name}_file_list">
                            ${fileListHtml}
                        </div>
                    </div>
                </div>
            `;
        } else if (field.type === 'url') {
            fieldsHtml += `
                <div class="wizard-field">
                    <label class="wizard-label">
                        <i class="icon">üîó</i> ${field.label}
                        ${field.required ? '<span class="required">*</span>' : ''}
                    </label>
                    <input type="url" name="${field.name}" class="wizard-input" value="${value}" placeholder="https://example.com" ${required}>
                </div>
            `;
        } else if (field.type === 'file_or_text') {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã (–∏—Å–∫–ª—é—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏)
            const fileUrls = value ? value.split(',').map(url => url.trim()).filter(url => url && !url.includes('C:\\fakepath\\')) : [];
            const fileListHtml = fileUrls.map((url, index) => {
                const fileName = url.split('/').pop(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∫–∞–∫ –µ—Å—Ç—å
                const isImage = /\.(jpg|jpeg|png|gif|bmp|tiff)$/i.test(fileName);
                const fileIcon = isImage ? 'üñºÔ∏è' : 'üìÑ';
                return `<div class="file-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin: 4px 0; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                    <div class="file-info" style="display: flex; align-items: center; flex: 1;">
                        <span style="margin-right: 8px; font-size: 16px;">${fileIcon}</span>
                        <a href="${url}" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">${fileName}</a>
                        <span class="file-url" style="display: none;">${url}</span>
                    </div>
                    <button type="button" class="file-remove" onclick="removeFile('${field.name}', ${index})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; margin-left: 8px;">√ó</button>
                </div>`;
            }).join('');
            
            fieldsHtml += `
                <div class="wizard-field">
                    <label class="wizard-label">
                        <i class="icon">üìÑ</i> ${field.label}
                        ${field.required ? '<span class="required">*</span>' : ''}
                    </label>
                    <div class="file-upload-container" id="${field.name}_upload_container">
                        <div class="file-drop-zone" id="${field.name}_drop_zone" ondrop="handleFileDrop(event, '${field.name}')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="drop-zone-content">
                                <i class="icon">üìÅ</i>
                                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ <span class="file-select-link" onclick="document.getElementById('${field.name}_file_input').click()">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</span></p>
                                <p class="file-types">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, GIF, SIG, ZIP, RAR, 7Z, TAR, GZ</p>
                            </div>
                        </div>
                        <input type="file" id="${field.name}_file_input" name="${field.name}" class="wizard-input" multiple style="display: none;" onchange="handleFileSelect(event, '${field.name}')" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.sig,.zip,.rar,.7z,.tar,.gz,.tgz">
                        <div class="file-list" id="${field.name}_file_list">
                            ${fileListHtml}
                        </div>
                    </div>
                </div>
            `;
        } else if (field.type === 'file_with_name') {
            let filesData = [];
            if (value) {
                if (Array.isArray(value)) {
                    filesData = value;
                } else if (typeof value === 'object' && value !== null) {
                    filesData = [value];
                } else if (typeof value === 'string' && (value.includes('/info/download_file/') || value.includes('/download_file/'))) {
                    const parts = value.split('|').map(s => s.trim());
                    const url = parts[0] || '';
                    const displayName = parts[1] || (url ? url.split('/').pop() : '');
                    const filename = url ? url.split('/').filter(Boolean).pop() : '';
                    if (url && filename) {
                        filesData = [{ url: url, displayName: displayName, filename: filename }];
                    }
                }
            }
            if (!wizardData[step.id]) wizardData[step.id] = {};
            wizardData[step.id][field.name] = filesData;
            
            const filesListHtml = filesData.map((fileData, index) => {
                const disp = fileData.displayName || fileData.originalName || fileData.filename || '–§–∞–π–ª';
                const dispEsc = (typeof escapeFileDisplayHtml === 'function' ? escapeFileDisplayHtml(disp) : disp.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'));
                const valEsc = (fileData.displayName || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                return `
                    <div class="file-item-with-name" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <div class="file-info" style="display: flex; align-items: center; flex: 1;">
                            <i class="file-icon" style="margin-right: 8px; font-size: 16px;">üìÑ</i>
                            <span class="file-name" style="color: #2563eb; font-weight: 500;">${dispEsc}</span>
                        </div>
                        <div class="file-actions" style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" class="file-display-name" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è" value="${valEsc}" onchange="updateFileDisplayNameMulti('${field.name}', ${index}, this.value)" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                            <button type="button" class="btn-remove-file" onclick="removeFileWithNameMulti('${field.name}', ${index})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">√ó</button>
                        </div>
                    </div>`;
            }).join('');
            
            fieldsHtml += `
                <div class="wizard-field">
                    <label class="wizard-label">
                        <i class="icon">üìé</i> ${field.label}
                        ${field.required ? '<span class="required">*</span>' : ''}
                    </label>
                    <div class="file-upload-container" id="${field.name}_upload_container">
                        <div class="file-drop-zone" id="${field.name}_drop_zone" onclick="document.getElementById('file-${field.name}').click()">
                            <div class="drop-zone-content">
                                <i class="icon">üìÅ</i>
                                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ <span class="file-select-link" onclick="document.getElementById('file-${field.name}').click(); event.stopPropagation();">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</span></p>
                                <p class="file-types">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, GIF, SIG, ZIP, RAR, 7Z, TAR, GZ</p>
                            </div>
                        </div>
                        <input type="file" id="file-${field.name}" name="${field.name}" multiple style="display: none;" onchange="handleFileWithName(event, '${field.name}')" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.sig,.zip,.rar,.7z,.tar,.gz,.tgz">
                    </div>
                    <div class="file-with-name-container" id="file-container-${field.name}">
                        ${filesListHtml}
                    </div>
                </div>
            `;
        } else if (field.type === 'html_editor') {
            fieldsHtml += `
                <div class="wizard-field">
                    <label class="wizard-label">
                        <i class="icon">üåê</i> ${field.label}
                        ${field.required ? '<span class="required">*</span>' : ''}
                    </label>
                    <div class="html-editor-container">
                        <div class="html-editor-toolbar">
                            <button type="button" onclick="insertHtmlTag('${field.name}', 'h3')" class="html-btn" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ H3">H3</button>
                            <button type="button" onclick="insertHtmlTag('${field.name}', 'p')" class="html-btn" title="–ü–∞—Ä–∞–≥—Ä–∞—Ñ">P</button>
                            <button type="button" onclick="insertHtmlTag('${field.name}', 'br')" class="html-btn" title="–ü–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏">BR</button>
                            <button type="button" onclick="insertHtmlTag('${field.name}', 'strong')" class="html-btn" title="–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç">B</button>
                            <button type="button" onclick="insertHtmlTag('${field.name}', 'em')" class="html-btn" title="–ö—É—Ä—Å–∏–≤">I</button>
                            <button type="button" onclick="insertHtmlTag('${field.name}', 'ul')" class="html-btn" title="–°–ø–∏—Å–æ–∫">UL</button>
                            <button type="button" onclick="insertHtmlTag('${field.name}', 'ol')" class="html-btn" title="–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">OL</button>
                            <button type="button" onclick="insertHtmlTag('${field.name}', 'li')" class="html-btn" title="–≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞">LI</button>
                        </div>
                        <textarea name="${field.name}" class="wizard-input html-editor-textarea" rows="12" ${required} placeholder="–í–≤–µ–¥–∏—Ç–µ HTML-—Ä–∞–∑–º–µ—Ç–∫—É...">${value}</textarea>
                        <div class="html-preview" id="${field.name}_preview">
                            <h4>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä:</h4>
                            <div class="html-preview-content"></div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            fieldsHtml += `
                <div class="wizard-field">
                    <label class="wizard-label">
                        <i class="icon">üìù</i> ${field.label}
                        ${field.required ? '<span class="required">*</span>' : ''}
                    </label>
                    <input type="${field.type}" name="${field.name}" class="wizard-input" value="${value}" ${required}>
                </div>
            `;
        }
    });

    let sectionHeadersHtml = '';
    if (typeof WIZARD_SECTION_HEADERS !== 'undefined' && WIZARD_SECTION_HEADERS[step.id]) {
        const headersConfig = WIZARD_SECTION_HEADERS[step.id];
        const sh = wizardData[step.id]?.section_headers || {};
        const stepTitle = (step.title || '').trim();
        const rows = headersConfig.map(function(h) {
            const cfg = sh[h.key] || {};
            const defaultText = (h.defaultText !== undefined && h.defaultText !== '') ? h.defaultText : stepTitle;
            const text = (cfg.text !== undefined && cfg.text !== '') ? cfg.text : defaultText;
            const visible = cfg.visible !== false;
            const safeText = (text || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
            const safeKey = (h.key || '').replace(/"/g, '');
            return '<div class="wizard-field" style="margin-bottom: 14px;">' +
                '<label class="wizard-label">' + (h.label || h.key) + '</label>' +
                '<input type="text" id="section-header-' + safeKey + '-text" class="wizard-input section-header-text" data-header-key="' + safeKey + '" value="' + safeText + '" placeholder="' + (defaultText || '').replace(/"/g, '&quot;') + '" style="margin-bottom: 8px;">' +
                '<label style="display: inline-flex; align-items: center; gap: 6px; font-weight: normal;"><input type="checkbox" id="section-header-' + safeKey + '-visible" class="section-header-visible" data-header-key="' + safeKey + '" ' + (visible ? 'checked' : '') + '> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫</label>' +
                '</div>';
        }).join('');
        sectionHeadersHtml = '<div class="wizard-section-headers" style="margin-top: 24px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">' +
            '<h4 style="margin: 0 0 16px 0; font-size: 15px;"><i class="icon">üìå</i> –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –±–ª–æ–∫–æ–≤</h4>' +
            '<p style="color: #64748b; font-size: 0.875rem; margin: 0 0 12px 0;">–¢–µ–∫—Å—Ç –∏ –≤–∏–¥–∏–º–æ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.</p>' +
            rows + '</div>';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    let contentBlocksHtml = '';
    if (step.content_blocks) {
        const blocks = wizardData[step.id]?.content_blocks || [];
        contentBlocksHtml = `
            <div class="wizard-content-blocks">
                <div class="wizard-blocks-header">
                    <h4><i class="icon">üìã</i> –ë–ª–æ–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h4>
                    <button type="button" onclick="addContentBlock('${step.id}')" class="btn btn-primary btn-sm">
                        <i class="icon">‚ûï</i> –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                    </button>
                </div>
                <div class="wizard-blocks-list" id="blocks-${step.id}-${Date.now()}">
                    ${generateBlocksHtml(step.id, blocks)}
                </div>
            </div>
        `;
    }
    
    contentContainer.innerHTML = `
        <div class="wizard-step-header">
            <h3><i class="icon">${step.icon}</i> ${step.title}</h3>
            <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "${step.title}"</p>
            ${step.endpoint === 'food' ? `
                <div style="margin-top: 12px; display:flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" onclick="createFoodSubsection()" class="btn btn-primary"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 10px 14px; border-radius: 10px; border: none; color: white; cursor: pointer; font-size: 14px; font-weight: 800;">
                        ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª
                    </button>
                </div>
            ` : ''}
        </div>
        
        <div class="wizard-form">
            ${fieldsHtml}
            ${sectionHeadersHtml}
            ${contentBlocksHtml}
        </div>
    `;
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –¥–ª—è –ø–æ–ª–µ–π
    if (!document.getElementById('wizard-styles')) {
        const style = document.createElement('style');
        style.id = 'wizard-styles';
        // CSS styles are now loaded from external files
        style.textContent = `
            .drop-zone-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            
            .drop-zone-content .icon {
                font-size: 2rem;
                color: #6b7280;
            }
            
            .drop-zone-content p {
                margin: 0;
                color: #374151;
                font-size: 0.875rem;
            }
            
            .file-select-link {
                color: #3b82f6;
                text-decoration: underline;
                cursor: pointer;
            }
            
            .file-select-link:hover {
                color: #1d4ed8;
            }
            
            /* –û–¥–Ω–æ—Ñ–∞–π–ª–æ–≤—ã–µ –ø–æ–ª—è —Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º –∏–º–µ–Ω–µ–º */
            .file-upload-area {
                border: 2px dashed #d1d5db;
                border-radius: 8px;
                padding: 18px;
                text-align: center;
                background: #f8fafc;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .file-upload-area:hover {
                border-color: #3b82f6;
                background: #eff6ff;
            }
            
            .file-upload-text {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                color: #374151;
                font-size: 0.95rem;
            }
            
            .file-upload-text .icon {
                font-size: 2rem;
                color: #f59e0b;
            }
            
            .file-with-name-container {
                margin-top: 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .file-types {
                font-size: 0.75rem !important;
                color: #6b7280 !important;
            }
            
            .file-list {
                margin-top: 12px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .file-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 8px 12px;
                background-color: #f3f4f6;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                font-size: 0.875rem;
            }
            
            .file-info {
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
            }
            
            .file-icon {
                font-size: 1.2rem;
            }
            
            .file-name {
                font-weight: 500;
                color: #374151;
            }
            
            .file-size {
                color: #6b7280;
                font-size: 0.75rem;
            }
            
            .file-remove {
                background: none;
                border: none;
                color: #ef4444;
                font-size: 1.2rem;
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
                transition: background-color 0.2s ease;
            }
            
            .file-remove:hover {
                background-color: #fee2e2;
            }
            
            /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–∞—Ö */
            .block-photos-upload-container {
                margin-top: 12px;
            }
            
            .block-photos-drop-zone {
                border: 2px dashed #d1d5db;
                border-radius: 8px;
                padding: 24px;
                text-align: center;
                background: #f8fafc;
                transition: all 0.2s ease;
            }
            
            .block-photos-drop-zone.drag-over {
                border-color: #3b82f6;
                background: #eff6ff;
            }
            
            .person-photo-drop-zone.drag-over {
                border-color: #3b82f6 !important;
                background: #dbeafe !important;
                border-style: solid !important;
            }
            
            .block-photos-list {
                margin-top: 16px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .block-photo-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background: #f8fafc;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
            }
            
            .block-photo-preview {
                width: 140px;
                height: 140px;
                flex-shrink: 0;
                border-radius: 8px;
                overflow: hidden;
                background: #fff;
                border: 1px solid #e5e7eb;
            }
            
            .block-photo-preview img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .block-photo-info {
                flex: 1;
                min-width: 0;
            }
            
            .block-photo-name {
                font-size: 0.875rem;
                color: #374151;
                word-break: break-all;
            }
            
            .block-photo-remove {
                background: none;
                border: none;
                color: #ef4444;
                font-size: 1.2rem;
                cursor: pointer;
                padding: 4px 8px;
                border-radius: 4px;
                transition: background-color 0.2s ease;
            }
            
            .block-photo-remove:hover {
                background-color: #fee2e2;
            }
            
            /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–ª–æ–∫–∞—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ */
            .block-documents-upload-container {
                margin-top: 12px;
            }
            
            .block-documents-drop-zone {
                border: 2px dashed #d1d5db;
                border-radius: 8px;
                padding: 24px;
                text-align: center;
                background: #f8fafc;
                transition: all 0.2s ease;
            }
            
            .block-documents-drop-zone.drag-over {
                border-color: #3b82f6;
                background: #eff6ff;
            }
            
            .block-documents-list {
                margin-top: 16px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .block-document-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                padding: 12px;
                background: #f8fafc;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
            }
            
            .block-document-info {
                display: flex;
                align-items: center;
                gap: 12px;
                flex: 1;
                min-width: 0;
            }
            
            .block-document-icon {
                font-size: 1.5rem;
                flex-shrink: 0;
            }
            
            .block-document-name {
                font-size: 0.875rem;
                color: #374151;
                word-break: break-all;
            }
            
            .block-document-remove {
                background: none;
                border: none;
                color: #ef4444;
                font-size: 1.2rem;
                cursor: pointer;
                padding: 4px 8px;
                border-radius: 4px;
                transition: background-color 0.2s ease;
            }
            
            .block-document-remove:hover {
                background-color: #fee2e2;
            }
            
            /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–æ–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è */
            .download-link {
                color: #3b82f6;
                text-decoration: none;
                font-weight: 500;
                padding: 4px 8px;
                border-radius: 4px;
                background-color: #eff6ff;
                border: 1px solid #dbeafe;
                transition: all 0.2s ease;
                display: inline-block;
            }
            
            .download-link:hover {
                color: #1d4ed8;
                background-color: #dbeafe;
                border-color: #3b82f6;
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
            }
        `;
        document.head.appendChild(style);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±–ª–æ–∫–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω
    setTimeout(() => {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.querySelectorAll('.edit-block-btn').forEach((btn, index) => {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            btn.removeEventListener('click', btn._editHandler);
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            btn._editHandler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const stepId = this.getAttribute('data-step-id');
                const blockIndex = parseInt(this.getAttribute('data-block-index'));
                editContentBlock(stepId, blockIndex);
            };
            btn.addEventListener('click', btn._editHandler);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        document.querySelectorAll('.remove-block-btn').forEach((btn, index) => {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            btn.removeEventListener('click', btn._removeHandler);
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            btn._removeHandler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const stepId = this.getAttribute('data-step-id');
                const blockIndex = parseInt(this.getAttribute('data-block-index'));
                removeContentBlock(stepId, blockIndex);
            };
            btn.addEventListener('click', btn._removeHandler);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤–≤–µ—Ä—Ö
        document.querySelectorAll('.move-block-up-btn').forEach((btn) => {
            btn.removeEventListener('click', btn._moveUpHandler);
            btn._moveUpHandler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const stepId = this.getAttribute('data-step-id');
                const blockIndex = parseInt(this.getAttribute('data-block-index'));
                moveBlockUp(stepId, blockIndex);
            };
            btn.addEventListener('click', btn._moveUpHandler);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤–Ω–∏–∑
        document.querySelectorAll('.move-block-down-btn').forEach((btn) => {
            btn.removeEventListener('click', btn._moveDownHandler);
            btn._moveDownHandler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const stepId = this.getAttribute('data-step-id');
                const blockIndex = parseInt(this.getAttribute('data-block-index'));
                moveBlockDown(stepId, blockIndex);
            };
            btn.addEventListener('click', btn._moveDownHandler);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
        const step = wizardSteps[currentWizardStep];
        if (step && step.fields) {
            step.fields.forEach(field => {
                const inputElement = document.querySelector(`[name="${field.name}"]`);
                if (inputElement) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                    inputElement.removeEventListener('input', inputElement._autoSaveHandler);
                    inputElement.removeEventListener('change', inputElement._autoSaveHandler);
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                    inputElement._autoSaveHandler = async function() {
                        await saveCurrentStepData();
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π
                    inputElement.addEventListener('input', inputElement._autoSaveHandler);
                    inputElement.addEventListener('change', inputElement._autoSaveHandler);
                }
            });
        }
    }, 100);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
    (step.fields || []).forEach(field => {
        if (field.type === 'file' || field.type === 'file_or_text') {
            const fileList = document.getElementById(`${field.name}_file_list`);
            if (fileList) {
                const fileItems = fileList.querySelectorAll('.file-item');
                fileItems.forEach((item, index) => {
                    const removeBtn = item.querySelector('.file-remove');
                    if (removeBtn) {
                        removeBtn.setAttribute('onclick', `removeFile('${field.name}', ${index})`);
                    }
                });
            }
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º HTML-—Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
    setTimeout(() => {
        initializeHtmlEditors();
    }, 100);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Ç–∏–ø–∞ –±–ª–æ–∫–∞
function getBlockTypeIcon(type) {
    const icons = {
        'text': 'üìù',
        'table': 'üìä',
        'list': 'üìã',
        'documents': 'üìÑ',
        'photos': 'üñºÔ∏è',
        'person': 'üë§',
        'dishes': 'üçΩÔ∏è',
        'daily-dish': 'üç≤'
    };
    return icons[type] || 'üìÑ';
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–∞ –±–ª–æ–∫–∞
function getBlockTypeName(type) {
    const names = {
        'text': '–¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫',
        'table': '–¢–∞–±–ª–∏—Ü–∞',
        'list': '–°–ø–∏—Å–æ–∫',
        'documents': '–î–æ–∫—É–º–µ–Ω—Ç—ã',
        'photos': '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏',
        'person': '–ü–µ—Ä—Å–æ–Ω–∞',
        'dishes': '–ë–ª—é–¥–∞',
        'daily-dish': '–ë–ª—é–¥–æ –Ω–∞ –¥–µ–Ω—å'
    };
    return names[type] || '–ë–ª–æ–∫';
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –¥–ª—è –±–ª–æ–∫–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
function generateBlocksHtml(stepId, blocks) {
    if (!blocks || blocks.length === 0) {
        return '<div class="wizard-empty-blocks">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</div>';
    }
    
    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –±–ª–æ–∫–æ–≤
    function normalizeBlocksRecursive(blocksArray) {
        const normalizedBlocks = [];
        for (const block of blocksArray) {
            if (typeof block === 'object' && block !== null && !Array.isArray(block)) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ content_blocks
                if (block.content_blocks && Array.isArray(block.content_blocks)) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏, —Å–∞–º –±–ª–æ–∫ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
                    normalizedBlocks.push(...normalizeBlocksRecursive(block.content_blocks));
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ content_blocks
                    const normalized = {};
                    for (const key in block) {
                        if (key !== 'content_blocks') {
                            normalized[key] = block[key];
                        }
                    }
                    normalizedBlocks.push(normalized);
                }
            } else if (Array.isArray(block)) {
                // –ï—Å–ª–∏ –±–ª–æ–∫ - —ç—Ç–æ –º–∞—Å—Å–∏–≤, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
                normalizedBlocks.push(...normalizeBlocksRecursive(block));
            } else {
                normalizedBlocks.push(block);
            }
        }
        return normalizedBlocks;
    }
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –±–ª–æ–∫–∏
    const normalizedBlocks = normalizeBlocksRecursive(blocks);
    
    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
    let html = '';
    for (let index = 0; index < normalizedBlocks.length; index++) {
        const block = normalizedBlocks[index];
        if (block && typeof block === 'object' && block.type) {
            html += `
        <div class="wizard-block-item" data-block-index="${index}">
            <div class="wizard-block-header">
                <span class="wizard-block-type">${getBlockTypeIcon(block.type)} ${getBlockTypeName(block.type)}${block.title ? ': ' + (typeof block.title === 'string' ? block.title : '') : ''}</span>
                <div class="wizard-block-actions">
                    <button type="button" class="btn btn-sm btn-secondary move-block-up-btn" data-step-id="${stepId}" data-block-index="${index}" ${index === 0 ? 'disabled' : ''} title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">
                        <i class="icon">‚¨ÜÔ∏è</i>
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary move-block-down-btn" data-step-id="${stepId}" data-block-index="${index}" ${index === normalizedBlocks.length - 1 ? 'disabled' : ''} title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">
                        <i class="icon">‚¨áÔ∏è</i>
                    </button>
                    <button type="button" class="btn btn-sm btn-primary edit-block-btn" data-step-id="${stepId}" data-block-index="${index}">
                        <i class="icon">‚úèÔ∏è</i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button type="button" class="btn btn-sm btn-danger remove-block-btn" data-step-id="${stepId}" data-block-index="${index}">
                        <i class="icon">üóëÔ∏è</i> –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
            <div class="wizard-block-preview">
                ${generateBlockPreview(block)}
            </div>
        </div>
    `;
        }
    }
    
    return html;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–ª–æ–∫–∞
function generateBlockPreview(block) {
    switch (block.type) {
        case 'text':
            return `<div class="wizard-text-preview">${block.content ? block.content.substring(0, 100) + '...' : '–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫'}</div>`;
        case 'table':
            const headers = block.headers || [];
            const rows = block.rows || [];
            let tablePreview = `<div class="wizard-table-preview">`;
            tablePreview += `<div class="wizard-table-stats">–¢–∞–±–ª–∏—Ü–∞: ${headers.length} –∫–æ–ª–æ–Ω–æ–∫, ${rows.length} —Å—Ç—Ä–æ–∫</div>`;
            
            if (headers.length > 0 || rows.length > 0) {
                tablePreview += `<div class="wizard-table-mini">`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                if (headers.length > 0) {
                    tablePreview += `<div class="wizard-table-mini-header">`;
                    headers.slice(0, 3).forEach(header => {
                        tablePreview += `<span class="wizard-table-mini-cell">${header}</span>`;
                    });
                    if (headers.length > 3) {
                        tablePreview += `<span class="wizard-table-mini-cell">...</span>`;
                    }
                    tablePreview += `</div>`;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
                if (rows.length > 0) {
                    rows.slice(0, 2).forEach(row => {
                        tablePreview += `<div class="wizard-table-mini-row">`;
                        row.slice(0, 3).forEach(cell => {
                            tablePreview += `<span class="wizard-table-mini-cell">${cell}</span>`;
                        });
                        if (row.length > 3) {
                            tablePreview += `<span class="wizard-table-mini-cell">...</span>`;
                        }
                        tablePreview += `</div>`;
                    });
                    if (rows.length > 2) {
                        tablePreview += `<div class="wizard-table-mini-more">...</div>`;
                    }
                }
                
                tablePreview += `</div>`;
            }
            
            tablePreview += `</div>`;
            return tablePreview;
        case 'list':
            return `<div class="wizard-list-preview">–°–ø–∏—Å–æ–∫: ${block.items ? block.items.length : 0} —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div>`;
        case 'documents':
            return `<div class="wizard-docs-preview">–î–æ–∫—É–º–µ–Ω—Ç—ã: ${block.documents ? block.documents.length : 0} —Ñ–∞–π–ª–æ–≤</div>`;
        case 'photos':
            return `<div class="wizard-photos-preview">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: ${block.photos ? block.photos.length : 0} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>`;
        case 'person':
            return `<div class="wizard-person-preview">–ü–µ—Ä—Å–æ–Ω–∞: ${block.persons ? block.persons.length : 0} –∑–∞–ø–∏—Å–µ–π</div>`;
        case 'dishes':
            return `<div class="wizard-dishes-preview">–ë–ª—é–¥–∞: ${block.dishes ? block.dishes.length : 0} –±–ª—é–¥</div>`;
        case 'daily-dish':
            const dish = block.dish || {};
            return `<div class="wizard-daily-dish-preview">${dish.title || '–ë–ª—é–¥–æ –Ω–∞ –¥–µ–Ω—å'}${dish.date ? ` (${dish.date})` : ''}</div>`;
        default:
            return '<div class="wizard-unknown-preview">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –±–ª–æ–∫–∞</div>';
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
function addContentBlock(stepId) {
    // addContentBlock –≤—ã–∑–≤–∞–Ω
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ sidebar wizard
    let step;
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–≥–∏ –∏–∑ sidebar wizard
        step = window.sidebarWizardManager.wizardSteps.find(s => s.id === stepId);
        if (!step) {
            // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ endpoint
            step = window.sidebarWizardManager.wizardSteps.find(s => s.endpoint === stepId);
        }
    } else {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–≥–∏ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ wizard
        step = wizardSteps.find(s => s.id === stepId);
        if (!step) {
            // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ endpoint
            step = wizardSteps.find(s => s.endpoint === stepId);
        }
    }
    
    if (!step) {
        console.error('Step not found:', stepId);
        return;
    }
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –±–ª–æ–∫–∞
    showBlockTypeModal(stepId);
}

// –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –±–ª–æ–∫–∞
function showBlockTypeModal(stepId) {
    // showBlockTypeModal –≤—ã–∑–≤–∞–Ω
    const modal = document.createElement('div');
    modal.className = 'wizard-block-type-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 2147483649;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    modal.innerHTML = `
        <div class="wizard-block-type-backdrop" onclick="closeBlockTypeModal()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);"></div>
        <div class="wizard-block-type-container" style="position: relative; background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <div class="wizard-block-type-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #111827;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –±–ª–æ–∫–∞</h3>
                <button onclick="closeBlockTypeModal()" class="wizard-block-type-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0.5rem;">‚úï</button>
            </div>
            <div class="wizard-block-type-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="wizard-block-type-option" onclick="selectBlockType('${stepId}', 'text')" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;">
                    <i class="icon" style="font-size: 1.5rem;">üìù</i>
                    <span style="font-weight: 500; color: #374151;">–¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫</span>
                </div>
                <div class="wizard-block-type-option" onclick="selectBlockType('${stepId}', 'table')" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;">
                    <i class="icon" style="font-size: 1.5rem;">üìä</i>
                    <span style="font-weight: 500; color: #374151;">–¢–∞–±–ª–∏—Ü–∞</span>
                </div>
                <div class="wizard-block-type-option" onclick="selectBlockType('${stepId}', 'list')" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;">
                    <i class="icon" style="font-size: 1.5rem;">üìã</i>
                    <span style="font-weight: 500; color: #374151;">–°–ø–∏—Å–æ–∫</span>
                </div>
                <div class="wizard-block-type-option" onclick="selectBlockType('${stepId}', 'documents')" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;">
                    <i class="icon" style="font-size: 1.5rem;">üìÑ</i>
                    <span style="font-weight: 500; color: #374151;">–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
                </div>
                <div class="wizard-block-type-option" onclick="selectBlockType('${stepId}', 'photos')" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;">
                    <i class="icon" style="font-size: 1.5rem;">üñºÔ∏è</i>
                    <span style="font-weight: 500; color: #374151;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</span>
                </div>
                <div class="wizard-block-type-option" onclick="selectBlockType('${stepId}', 'person')" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white;">
                    <i class="icon" style="font-size: 1.5rem;">üë§</i>
                    <span style="font-weight: 500; color: #374151;">–ü–µ—Ä—Å–æ–Ω–∞</span>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –±–ª–æ–∫–∞
function closeBlockTypeModal() {
    const modal = document.querySelector('.wizard-block-type-modal');
    if (modal) {
        modal.remove();
    }
}

// –í—ã–±–æ—Ä —Ç–∏–ø–∞ –±–ª–æ–∫–∞
function selectBlockType(stepId, blockType) {
    // selectBlockType –≤—ã–∑–≤–∞–Ω
    closeBlockTypeModal();
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫
    const newBlock = {
        type: blockType,
        title: '',
        content: '',
        headers: [],
        rows: [],
        items: [],
        documents: [],
        photos: [],
        persons: [],
        dishes: [],
        dish: blockType === 'daily-dish' ? {
            title: '',
            date: new Date().toISOString().split('T')[0],
            publish_date: new Date().toISOString().split('T')[0],
            photo: ''
        } : null
    };
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ sidebar wizard
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        // –†–∞–±–æ—Ç–∞–µ–º —Å sidebar wizard
        if (!window.sidebarWizardManager.wizardData[stepId]) {
            window.sidebarWizardManager.wizardData[stepId] = {};
        }
        if (!window.sidebarWizardManager.wizardData[stepId].content_blocks) {
            window.sidebarWizardManager.wizardData[stepId].content_blocks = [];
        }
        
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –±–ª–æ–∫–æ–≤
        const normalizeBlocksRecursive = (blocksArray) => {
            const normalizedBlocks = [];
            for (const block of blocksArray) {
                if (typeof block === 'object' && block !== null && !Array.isArray(block)) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ content_blocks
                    if (block.content_blocks && Array.isArray(block.content_blocks)) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏, —Å–∞–º –±–ª–æ–∫ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
                        normalizedBlocks.push(...normalizeBlocksRecursive(block.content_blocks));
                    } else {
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ content_blocks
                        const normalized = {};
                        for (const key in block) {
                            if (key !== 'content_blocks') {
                                normalized[key] = block[key];
                            }
                        }
                        normalizedBlocks.push(normalized);
                    }
                } else if (Array.isArray(block)) {
                    // –ï—Å–ª–∏ –±–ª–æ–∫ - —ç—Ç–æ –º–∞—Å—Å–∏–≤, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
                    normalizedBlocks.push(...normalizeBlocksRecursive(block));
                } else {
                    normalizedBlocks.push(block);
                }
            }
            return normalizedBlocks;
        };
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±–ª–æ–∫–∏ - —É–±–∏—Ä–∞–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ content_blocks
        const existingBlocks = window.sidebarWizardManager.wizardData[stepId].content_blocks;
        if (Array.isArray(existingBlocks)) {
            window.sidebarWizardManager.wizardData[stepId].content_blocks = normalizeBlocksRecursive(existingBlocks);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ –≤ –∫–æ–Ω–µ—Ü –º–∞—Å—Å–∏–≤–∞
        window.sidebarWizardManager.wizardData[stepId].content_blocks.push(newBlock);
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏
        window.wizardData = window.sidebarWizardManager.wizardData;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        window.sidebarWizardManager.renderCurrentStep();
    } else {
        // –†–∞–±–æ—Ç–∞–µ–º —Å –æ—Å–Ω–æ–≤–Ω—ã–º wizard
        if (!wizardData[stepId]) {
            wizardData[stepId] = {};
        }
        if (!wizardData[stepId].content_blocks) {
            wizardData[stepId].content_blocks = [];
        }
        
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –±–ª–æ–∫–æ–≤
        const normalizeBlocksRecursive = (blocksArray) => {
            const normalizedBlocks = [];
            for (const block of blocksArray) {
                if (typeof block === 'object' && block !== null && !Array.isArray(block)) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ content_blocks
                    if (block.content_blocks && Array.isArray(block.content_blocks)) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏, —Å–∞–º –±–ª–æ–∫ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
                        normalizedBlocks.push(...normalizeBlocksRecursive(block.content_blocks));
                    } else {
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –±–µ–∑ content_blocks
                        const normalized = {};
                        for (const key in block) {
                            if (key !== 'content_blocks') {
                                normalized[key] = block[key];
                            }
                        }
                        normalizedBlocks.push(normalized);
                    }
                } else if (Array.isArray(block)) {
                    // –ï—Å–ª–∏ –±–ª–æ–∫ - —ç—Ç–æ –º–∞—Å—Å–∏–≤, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
                    normalizedBlocks.push(...normalizeBlocksRecursive(block));
                } else {
                    normalizedBlocks.push(block);
                }
            }
            return normalizedBlocks;
        };
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±–ª–æ–∫–∏ - —É–±–∏—Ä–∞–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ content_blocks
        const existingBlocks = wizardData[stepId].content_blocks;
        if (Array.isArray(existingBlocks)) {
            wizardData[stepId].content_blocks = normalizeBlocksRecursive(existingBlocks);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ –≤ –∫–æ–Ω–µ—Ü –º–∞—Å—Å–∏–≤–∞
        wizardData[stepId].content_blocks.push(newBlock);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const step = wizardSteps.find(s => s.id === stepId);
        const stepIndex = wizardSteps.findIndex(s => s.id === stepId);
        loadStepContent(wizardSteps[stepIndex]);
    }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
function editContentBlock(stepId, blockIndex) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ sidebar wizard
    let stepData;
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        stepData = window.sidebarWizardManager.wizardData[stepId];
    } else {
        stepData = wizardData[stepId];
    }
    
    if (!stepData || !stepData.content_blocks || !stepData.content_blocks[blockIndex]) {
        console.error('Block not found for editing:', stepId, blockIndex);
        return;
    }
    const block = stepData.content_blocks[blockIndex];
        // –ë–ª–æ–∫ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    showBlockEditModal(stepId, blockIndex);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
function removeContentBlock(stepId, blockIndex) {
    // removeContentBlock –≤—ã–∑–≤–∞–Ω
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ sidebar wizard
    let stepData, steps, updateDisplay;
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        stepData = window.sidebarWizardManager.wizardData[stepId];
        steps = window.sidebarWizardManager.wizardSteps;
        updateDisplay = () => window.sidebarWizardManager.renderCurrentStep();
    } else {
        stepData = wizardData[stepId];
        steps = wizardSteps;
        updateDisplay = () => {
            const currentStepIndex = wizardSteps.findIndex(s => s.id === stepId);
            loadStepContent(wizardSteps[currentStepIndex]);
        };
    }
    
    if (!stepData || !stepData.content_blocks || !stepData.content_blocks[blockIndex]) {
        console.error('Block not found for removal:', stepId, blockIndex);
        return;
    }
    
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?')) {
        stepData.content_blocks.splice(blockIndex, 1);
        // –ë–ª–æ–∫ —É–¥–∞–ª–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        updateDisplay();
        // –ë–ª–æ–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω
    }
}

// –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–ª–æ–∫–∞ –≤–≤–µ—Ä—Ö
function moveBlockUp(stepId, blockIndex) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ sidebar wizard
    let stepData, updateDisplay;
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        stepData = window.sidebarWizardManager.wizardData[stepId];
        updateDisplay = () => window.sidebarWizardManager.renderCurrentStep();
    } else {
        stepData = wizardData[stepId];
        updateDisplay = () => {
            const currentStepIndex = wizardSteps.findIndex(s => s.id === stepId);
            loadStepContent(wizardSteps[currentStepIndex]);
        };
    }
    
    if (!stepData || !stepData.content_blocks || blockIndex <= 0 || blockIndex >= stepData.content_blocks.length) {
        return;
    }
    
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –±–ª–æ–∫–∏
    const blocks = stepData.content_blocks;
    [blocks[blockIndex - 1], blocks[blockIndex]] = [blocks[blockIndex], blocks[blockIndex - 1]];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    updateDisplay();
}

// –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–ª–æ–∫–∞ –≤–Ω–∏–∑
function moveBlockDown(stepId, blockIndex) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ sidebar wizard
    let stepData, updateDisplay;
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        stepData = window.sidebarWizardManager.wizardData[stepId];
        updateDisplay = () => window.sidebarWizardManager.renderCurrentStep();
    } else {
        stepData = wizardData[stepId];
        updateDisplay = () => {
            const currentStepIndex = wizardSteps.findIndex(s => s.id === stepId);
            loadStepContent(wizardSteps[currentStepIndex]);
        };
    }
    
    if (!stepData || !stepData.content_blocks || blockIndex < 0 || blockIndex >= stepData.content_blocks.length - 1) {
        return;
    }
    
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –±–ª–æ–∫–∏
    const blocks = stepData.content_blocks;
    [blocks[blockIndex], blocks[blockIndex + 1]] = [blocks[blockIndex + 1], blocks[blockIndex]];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    updateDisplay();
}

// –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
function showBlockEditModal(stepId, blockIndex) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ sidebar wizard
    let stepData;
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        stepData = window.sidebarWizardManager.wizardData[stepId];
    } else {
        stepData = wizardData[stepId];
    }
    
    if (!stepData || !stepData.content_blocks || !stepData.content_blocks[blockIndex]) {
        console.error('Block not found for editing modal:', stepId, blockIndex);
        return;
    }
    
    const block = stepData.content_blocks[blockIndex];
    
    const modal = document.createElement('div');
    modal.className = 'wizard-block-edit-modal';
    modal.innerHTML = `
        <div class="wizard-block-edit-backdrop" onclick="closeBlockEditModal()"></div>
        <div class="wizard-block-edit-container">
            <div class="wizard-block-edit-header">
                <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞: ${getBlockTypeName(block.type)}</h3>
                <button onclick="closeBlockEditModal()" class="wizard-block-edit-close">‚úï</button>
            </div>
            <div class="wizard-block-edit-content">
                ${generateBlockEditForm(stepId, blockIndex, block)}
            </div>
            <div class="wizard-block-edit-actions">
                <button onclick="closeBlockEditModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveBlockEdit('${stepId}', ${blockIndex})" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤
    if (block.type === 'text') {
        setTimeout(() => {
            initializeBlockPhotos(stepId, blockIndex, block);
            initializeBlockDocuments(stepId, blockIndex, block);
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º HTML-—Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            const textarea = modal.querySelector(`textarea[id^="block-content-${stepId}-${blockIndex}"]`);
            if (textarea) {
                initializeBlockContentEditor(textarea.id);
            }
        }, 100);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –±–ª–æ–∫–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    if (block.type === 'documents') {
        setTimeout(() => {
            initializeBlockDocuments(stepId, blockIndex, block);
        }, 100);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫/–ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è –±–ª–æ–∫–æ–≤ "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏"
    if (block.type === 'photos') {
        setTimeout(() => {
            initializeBlockPhotos(stepId, blockIndex, block);
        }, 100);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –±–ª–æ–∫–æ–≤ –±–ª—é–¥
    if (block.type === 'dishes') {
        setTimeout(() => {
            initializeDishesPhotos(stepId, blockIndex, block);
        }, 100);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é –¥–ª—è –ø–µ—Ä—Å–æ–Ω
    if (block.type === 'person' && block.persons) {
        setTimeout(() => {
            block.persons.forEach((person, idx) => {
                if (person.photo) {
                    updatePersonPhotoPreview(stepId, blockIndex, idx);
                }
            });
        }, 100);
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
function generateBlockEditForm(stepId, blockIndex, block) {
    const showTitle = block.show_title !== false;
    let formHtml = `
        <div class="wizard-block-edit-field">
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞</label>
            <input type="text" id="block-title-${stepId}-${blockIndex}-${Date.now()}" value="${(block.title || '').replace(/"/g, '&quot;')}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞...">
        </div>
        <div class="wizard-block-edit-field" style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="block-show-title-${stepId}-${blockIndex}-${Date.now()}" ${showTitle ? 'checked' : ''}>
            <label for="block-show-title-${stepId}-${blockIndex}-${Date.now()}" style="margin:0;">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
        </div>
    `;
    
    switch (block.type) {
        case 'text':
            const contentId = `block-content-${stepId}-${blockIndex}-${Date.now()}`;
            formHtml += `
                <div class="wizard-block-edit-field">
                    <label>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</label>
                    <div class="html-editor-container">
                        <div class="html-editor-toolbar">
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText('${contentId}', 'bold')" class="html-btn" title="–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç"><b>B</b></button>
                                <button type="button" onclick="formatText('${contentId}', 'italic')" class="html-btn" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
                                <button type="button" onclick="formatText('${contentId}', 'underline')" class="html-btn" title="–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π"><u>U</u></button>
                                <button type="button" onclick="formatText('${contentId}', 'strike')" class="html-btn" title="–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π"><s>S</s></button>
                            </div>
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText('${contentId}', 'h1')" class="html-btn" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1">H1</button>
                                <button type="button" onclick="formatText('${contentId}', 'h2')" class="html-btn" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2">H2</button>
                                <button type="button" onclick="formatText('${contentId}', 'h3')" class="html-btn" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3">H3</button>
                                <button type="button" onclick="formatText('${contentId}', 'h4')" class="html-btn" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ 4">H4</button>
                                <button type="button" onclick="formatText('${contentId}', 'p')" class="html-btn" title="–ü–∞—Ä–∞–≥—Ä–∞—Ñ">P</button>
                            </div>
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText('${contentId}', 'ul')" class="html-btn" title="–ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">UL</button>
                                <button type="button" onclick="formatText('${contentId}', 'ol')" class="html-btn" title="–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫">OL</button>
                                <button type="button" onclick="formatText('${contentId}', 'li')" class="html-btn" title="–≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞">LI</button>
                            </div>
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText('${contentId}', 'align-left')" class="html-btn" title="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é">‚¨Ö</button>
                                <button type="button" onclick="formatText('${contentId}', 'align-center')" class="html-btn" title="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ —Ü–µ–Ω—Ç—Ä—É">‚¨å</button>
                                <button type="button" onclick="formatText('${contentId}', 'align-right')" class="html-btn" title="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é">‚û°</button>
                                <button type="button" onclick="formatText('${contentId}', 'align-justify')" class="html-btn" title="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ —à–∏—Ä–∏–Ω–µ">‚¨å‚¨å</button>
                            </div>
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText('${contentId}', 'br')" class="html-btn" title="–ü–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏">BR</button>
                                <button type="button" onclick="formatText('${contentId}', 'hr')" class="html-btn" title="–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è">HR</button>
                            </div>
                            <div class="toolbar-group">
                                <button type="button" onclick="insertLink('${contentId}')" class="html-btn" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É">üîó</button>
                                <button type="button" onclick="showEmojiPicker('${contentId}', event)" class="html-btn" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å–º–∞–π–ª">üòä</button>
                            </div>
                            <div class="toolbar-group">
                                <button type="button" onclick="formatText('${contentId}', 'code')" class="html-btn" title="–ö–æ–¥"><code>Code</code></button>
                                <button type="button" onclick="formatText('${contentId}', 'mark')" class="html-btn" title="–í—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç"><mark>Mark</mark></button>
                                <button type="button" onclick="formatText('${contentId}', 'small')" class="html-btn" title="–ú–∞–ª–µ–Ω—å–∫–∏–π —Ç–µ–∫—Å—Ç"><small>Small</small></button>
                            </div>
                        </div>
                        <textarea id="${contentId}" name="${contentId}" class="wizard-input html-editor-textarea" rows="12" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç...">${block.content || ''}</textarea>
                        <div class="html-preview" id="${contentId}_preview" style="margin-top: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                            <h4 style="margin: 0 0 10px 0; font-size: 12px; color: #6b7280;">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä:</h4>
                            <div class="html-preview-content" style="min-height: 50px; color: #374151;"></div>
                        </div>
                    </div>
                </div>
                <div class="wizard-block-edit-field">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <div class="block-photos-upload-container" id="block-photos-upload-${stepId}-${blockIndex}">
                        <div class="file-drop-zone block-photos-drop-zone" 
                             ondrop="handleBlockPhotosDrop(event, '${stepId}', ${blockIndex})" 
                             ondragover="handleBlockPhotosDragOver(event)" 
                             ondragleave="handleBlockPhotosDragLeave(event)">
                            <div class="drop-zone-content">
                                <i class="icon">üñºÔ∏è</i>
                                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—é–¥–∞ –∏–ª–∏ <span class="file-select-link" onclick="document.getElementById('block-photos-input-${stepId}-${blockIndex}').click()">–≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span></p>
                                <p class="file-types">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, JPEG, PNG, GIF</p>
                            </div>
                        </div>
                        <input type="file" id="block-photos-input-${stepId}-${blockIndex}" accept="image/*" multiple style="display: none;" onchange="handleBlockPhotosSelect(event, '${stepId}', ${blockIndex})">
                        <div class="block-photos-list" id="block-photos-list-${stepId}-${blockIndex}"></div>
                    </div>
                </div>
                <div class="wizard-block-edit-field">
                    <label>–î–æ–∫—É–º–µ–Ω—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <div class="block-documents-upload-container" id="block-documents-upload-${stepId}-${blockIndex}">
                        <div class="file-drop-zone block-documents-drop-zone" 
                             ondrop="handleBlockDocumentsDrop(event, '${stepId}', ${blockIndex})" 
                             ondragover="handleBlockDocumentsDragOver(event)" 
                             ondragleave="handleBlockDocumentsDragLeave(event)">
                            <div class="drop-zone-content">
                                <i class="icon">üìÑ</i>
                                <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å—é–¥–∞ –∏–ª–∏ <span class="file-select-link" onclick="document.getElementById('block-documents-input-${stepId}-${blockIndex}').click()">–≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</span></p>
                                <p class="file-types">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: PDF, DOC, DOCX, TXT, XLS, XLSX, PPT, PPTX, RTF, ODT, ODS, ODP, SIG, ZIP, RAR, 7Z, TAR, GZ –∏ –¥—Ä—É–≥–∏–µ</p>
                            </div>
                        </div>
                        <input type="file" id="block-documents-input-${stepId}-${blockIndex}" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx,.rtf,.odt,.ods,.odp,.zip,.rar,.7z,.tar,.gz,.tgz" multiple style="display: none;" onchange="handleBlockDocumentsSelect(event, '${stepId}', ${blockIndex})">
                        <div class="block-documents-list" id="block-documents-list-${stepId}-${blockIndex}"></div>
                    </div>
                </div>
            `;
            break;
        case 'table':
            formHtml += generateTableEditForm(stepId, blockIndex, block);
            break;
        case 'list':
            formHtml += generateListEditForm(stepId, blockIndex, block);
            break;
        case 'photos':
            formHtml += generatePhotosEditForm(stepId, blockIndex, block);
            break;
        case 'documents':
            formHtml += generateDocumentsEditForm(stepId, blockIndex, block);
            break;
        case 'person':
            formHtml += generatePersonEditForm(stepId, blockIndex, block);
            break;
        case 'dishes':
            formHtml += generateDishesEditForm(stepId, blockIndex, block);
            break;
        case 'daily-dish':
            formHtml += generateDailyDishEditForm(stepId, blockIndex, block);
            break;
    }
    
    return formHtml;
}

// –†–µ–¥–∞–∫—Ç–æ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (—Å–ø–∏—Å–æ–∫ URL —Å—Ç—Ä–æ–∫–∞–º–∏)
function generatePhotosEditForm(stepId, blockIndex, block){
    const photos = Array.isArray(block.photos) ? block.photos : [];
    return `
        <div class="wizard-block-edit-field">
            <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</label>
            <div class="block-photos-upload-container" id="block-photos-upload-${stepId}-${blockIndex}">
                <div class="file-drop-zone block-photos-drop-zone" 
                     ondrop="handleBlockPhotosDrop(event, '${stepId}', ${blockIndex})" 
                     ondragover="handleBlockPhotosDragOver(event)" 
                     ondragleave="handleBlockPhotosDragLeave(event)">
                    <div class="drop-zone-content">
                        <i class="icon">üñºÔ∏è</i>
                        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—é–¥–∞ –∏–ª–∏ <span class="file-select-link" onclick="document.getElementById('block-photos-input-${stepId}-${blockIndex}').click()">–≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span></p>
                        <p class="file-types">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, JPEG, PNG, GIF</p>
                    </div>
                </div>
                <input type="file" id="block-photos-input-${stepId}-${blockIndex}" accept="image/*" multiple style="display: none;" onchange="handleBlockPhotosSelect(event, '${stepId}', ${blockIndex})">
                <div class="block-photos-list" id="block-photos-list-${stepId}-${blockIndex}"></div>
            </div>
            <div style="margin-top: 12px;">
                <label style="margin-bottom: 6px;">–°—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ –æ–¥–Ω–æ–π –≤ —Å—Ç—Ä–æ–∫–µ)</label>
                <textarea id="block-photos-${stepId}-${blockIndex}" rows="6" placeholder="https://...\nhttps://...">${photos.join('\n')}</textarea>
                <small>–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫–∏ –≤—Ä—É—á–Ω—É—é. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å—Å—ã–ª–∫–∏ –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</small>
            </div>
        </div>
    `;
}

// –†–µ–¥–∞–∫—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤
function generateDocumentsEditForm(stepId, blockIndex, block){
    return `
        <div class="wizard-block-edit-field">
            <label>–î–æ–∫—É–º–µ–Ω—Ç—ã</label>
            <div class="block-documents-upload-container" id="block-documents-upload-${stepId}-${blockIndex}">
                <div class="file-drop-zone block-documents-drop-zone" 
                     ondrop="handleBlockDocumentsDrop(event, '${stepId}', ${blockIndex})" 
                     ondragover="handleBlockDocumentsDragOver(event)" 
                     ondragleave="handleBlockDocumentsDragLeave(event)">
                    <div class="drop-zone-content">
                        <i class="icon">üìÑ</i>
                        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å—é–¥–∞ –∏–ª–∏ <span class="file-select-link" onclick="document.getElementById('block-documents-input-${stepId}-${blockIndex}').click()">–≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</span></p>
                        <p class="file-types">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: PDF, DOC, DOCX, TXT, XLS, XLSX, PPT, PPTX, RTF, ODT, ODS, ODP, ZIP, RAR, 7Z, TAR, GZ –∏ –¥—Ä—É–≥–∏–µ</p>
                    </div>
                </div>
                <input type="file" id="block-documents-input-${stepId}-${blockIndex}" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx,.rtf,.odt,.ods,.odp,.zip,.rar,.7z,.tar,.gz,.tgz" multiple style="display: none;" onchange="handleBlockDocumentsSelect(event, '${stepId}', ${blockIndex})">
                <div class="block-documents-list" id="block-documents-list-${stepId}-${blockIndex}"></div>
            </div>
        </div>
    `;
}

// –†–µ–¥–∞–∫—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫)
function generatePersonEditForm(stepId, blockIndex, block){
    const persons = Array.isArray(block.persons) ? block.persons : [];
    const listId = `person-list-${stepId}-${blockIndex}`;
    const renderItem = (p, idx) => `
        <div class="person-item" data-index="${idx}" style="display:flex; gap:12px; align-items:flex-start; border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-bottom:10px;">
            <div style="flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="wizard-block-edit-field" style="grid-column: span 2;">
                    <label>–§–ò–û</label>
                    <input type="text" value="${p.name || ''}" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" class="person-name">
                </div>
                <div class="wizard-block-edit-field">
                    <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <input type="text" value="${p.position || ''}" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å" class="person-position">
                </div>
                <div class="wizard-block-edit-field" style="grid-column: span 2;">
                    <label>–§–æ—Ç–æ (URL, –∑–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ)</label>
                    <div class="person-photo-upload-container" id="person-photo-upload-${stepId}-${blockIndex}-${idx}" ondrop="handlePersonPhotoDrop(event, '${stepId}', ${blockIndex}, ${idx})" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="file-drop-zone person-photo-drop-zone" style="min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc; padding: 16px; cursor: pointer; transition: all 0.2s ease;" onclick="document.getElementById('person-photo-file-${stepId}-${blockIndex}-${idx}').click()">
                            <i class="icon" style="font-size: 2rem; margin-bottom: 8px;">üñºÔ∏è</i>
                            <p style="margin: 0; color: #64748b; font-size: 0.9rem; text-align: center;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞<br>–∏–ª–∏ <span style="color: #3b82f6; text-decoration: underline;">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span></p>
                            <p style="margin: 4px 0 0 0; color: #94a3b8; font-size: 0.75rem;">JPG, PNG, GIF</p>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: flex-start; margin-top: 8px;">
                            <input type="text" value="${p.photo || ''}" placeholder="https://..." class="person-photo" id="person-photo-${stepId}-${blockIndex}-${idx}" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;" oninput="updatePersonPhotoPreview('${stepId}', ${blockIndex}, ${idx})">
                            <button type="button" onclick="removePersonPhoto('${stepId}', ${blockIndex}, ${idx})" style="display: ${p.photo ? 'block' : 'none'}; background: #dc3545; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 14px; white-space: nowrap;" id="person-photo-remove-${stepId}-${blockIndex}-${idx}" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                        <input type="file" id="person-photo-file-${stepId}-${blockIndex}-${idx}" accept="image/*" style="display: none;" onchange="handlePersonPhotoSelect(event, '${stepId}', ${blockIndex}, ${idx})">
                        <div class="person-photo-preview" id="person-photo-preview-${stepId}-${blockIndex}-${idx}" style="margin-top: 8px; ${p.photo ? '' : 'display: none;'}">
                            ${p.photo ? `<img src="${p.photo}" alt="–§–æ—Ç–æ" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb; object-fit: cover;" onerror="this.style.display='none'">` : ''}
                        </div>
                    </div>
                </div>
                <div class="wizard-block-edit-field" style="grid-column: span 2;">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea rows="4" placeholder="–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" class="person-description">${p.description || ''}</textarea>
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removePerson('${stepId}', ${blockIndex}, ${idx})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>`;
    const itemsHtml = persons.map(renderItem).join('');
    return `
        <div class="wizard-block-edit-field">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label>–ü–µ—Ä—Å–æ–Ω—ã</label>
                <button type="button" class="btn btn-sm btn-primary" onclick="addPerson('${stepId}', ${blockIndex})">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div id="${listId}">${itemsHtml}</div>
        </div>
    `;
}

function addPerson(stepId, blockIndex){
    const list = document.getElementById(`person-list-${stepId}-${blockIndex}`);
    if(!list) return;
    const idx = list.children.length;
    const newPersonHtml = generatePersonEditForm(stepId, blockIndex, { persons: [{}] });
    const match = newPersonHtml.match(/<div id="person-list-[^>]+>([\s\S]*)<\/div>/);
    if (match && match[1]) {
        list.insertAdjacentHTML('beforeend', match[1]);
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        setTimeout(() => {
            const photoInput = document.getElementById(`person-photo-${stepId}-${blockIndex}-${idx}`);
            if (photoInput && photoInput.value) {
                updatePersonPhotoPreview(stepId, blockIndex, idx);
            }
        }, 100);
    }
}

function removePerson(stepId, blockIndex, idx){
    const list = document.getElementById(`person-list-${stepId}-${blockIndex}`);
    if(!list) return;
    const item = list.querySelector(`.person-item[data-index="${idx}"]`);
    if(item) item.remove();
}

// –†–µ–¥–∞–∫—Ç–æ—Ä –±–ª—é–¥
function generateDishesEditForm(stepId, blockIndex, block){
    const dishes = Array.isArray(block.dishes) ? block.dishes : [];
    const listId = `dishes-list-${stepId}-${blockIndex}`;
    const renderItem = (d, idx) => {
        const today = new Date().toISOString().split('T')[0];
        return `
        <div class="dish-item" data-index="${idx}" style="border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-bottom:10px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="wizard-block-edit-field" style="grid-column: span 2;">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª—é–¥–∞</label>
                    <input type="text" value="${d.title || ''}" placeholder="–ë–ª—é–¥–æ –Ω–∞ 07.11.2025" class="dish-title">
                </div>
                <div class="wizard-block-edit-field">
                    <label>–î–∞—Ç–∞ –±–ª—é–¥–∞</label>
                    <input type="date" value="${d.date || today}" class="dish-date">
                </div>
                <div class="wizard-block-edit-field">
                    <label>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                    <input type="date" value="${d.publish_date || today}" class="dish-publish-date">
                </div>
                <div class="wizard-block-edit-field" style="grid-column: span 2;">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <input type="text" value="${d.photo || ''}" placeholder="/static/uploads/nutrition/dishes/dish-2025-11-07.jpg" class="dish-photo" style="flex: 1;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="uploadDishPhoto('${stepId}', ${blockIndex}, ${idx})" style="white-space: nowrap;">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                    <div class="dish-photo-preview" id="dish-photo-preview-${stepId}-${blockIndex}-${idx}" style="margin-top: 10px; ${d.photo ? '' : 'display: none;'}">
                        ${d.photo ? `<img src="${d.photo}" alt="–§–æ—Ç–æ –±–ª—é–¥–∞" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb;">` : ''}
                    </div>
                    <input type="file" id="dish-photo-input-${stepId}-${blockIndex}-${idx}" accept="image/*" style="display: none;" onchange="handleDishPhotoSelect(event, '${stepId}', ${blockIndex}, ${idx})">
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeDish('${stepId}', ${blockIndex}, ${idx})" style="margin-top:10px;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>`;
    };
    const itemsHtml = dishes.map(renderItem).join('');
    return `
        <div class="wizard-block-edit-field">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label>–ë–ª—é–¥–∞</label>
                <button type="button" class="btn btn-sm btn-primary" onclick="addDish('${stepId}', ${blockIndex})">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>
            </div>
            <div id="${listId}">${itemsHtml}</div>
        </div>
    `;
}

function addDish(stepId, blockIndex){
    const list = document.getElementById(`dishes-list-${stepId}-${blockIndex}`);
    if(!list) return;
    const idx = list.children.length;
    const today = new Date().toISOString().split('T')[0];
    const newDishHtml = `
        <div class="dish-item" data-index="${idx}" style="border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-bottom:10px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="wizard-block-edit-field" style="grid-column: span 2;">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª—é–¥–∞</label>
                    <input type="text" value="" placeholder="–ë–ª—é–¥–æ –Ω–∞ 07.11.2025" class="dish-title">
                </div>
                <div class="wizard-block-edit-field">
                    <label>–î–∞—Ç–∞ –±–ª—é–¥–∞</label>
                    <input type="date" value="${today}" class="dish-date">
                </div>
                <div class="wizard-block-edit-field">
                    <label>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                    <input type="date" value="${today}" class="dish-publish-date">
                </div>
                <div class="wizard-block-edit-field" style="grid-column: span 2;">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <input type="text" value="" placeholder="/static/uploads/nutrition/dishes/dish-2025-11-07.jpg" class="dish-photo" style="flex: 1;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="uploadDishPhoto('${stepId}', ${blockIndex}, ${idx})" style="white-space: nowrap;">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                    <div class="dish-photo-preview" id="dish-photo-preview-${stepId}-${blockIndex}-${idx}" style="margin-top: 10px; display: none;">
                    </div>
                    <input type="file" id="dish-photo-input-${stepId}-${blockIndex}-${idx}" accept="image/*" style="display: none;" onchange="handleDishPhotoSelect(event, '${stepId}', ${blockIndex}, ${idx})">
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeDish('${stepId}', ${blockIndex}, ${idx})" style="margin-top:10px;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>`;
    list.insertAdjacentHTML('beforeend', newDishHtml);
}

function removeDish(stepId, blockIndex, idx){
    const list = document.getElementById(`dishes-list-${stepId}-${blockIndex}`);
    if(!list) return;
    const item = list.querySelector(`.dish-item[data-index="${idx}"]`);
    if(item) item.remove();
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –±–ª—é–¥
function uploadDishPhoto(stepId, blockIndex, dishIndex) {
    const input = document.getElementById(`dish-photo-input-${stepId}-${blockIndex}-${dishIndex}`);
    if (input) {
        input.click();
    }
}

function updatePersonPhotoPreview(stepId, blockIndex, personIndex) {
    const photoInput = document.getElementById(`person-photo-${stepId}-${blockIndex}-${personIndex}`);
    const preview = document.getElementById(`person-photo-preview-${stepId}-${blockIndex}-${personIndex}`);
    const removeButton = document.getElementById(`person-photo-remove-${stepId}-${blockIndex}-${personIndex}`);
    if (photoInput && preview) {
        const url = photoInput.value.trim();
        if (url) {
            preview.innerHTML = `<img src="${url}" alt="–§–æ—Ç–æ" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb; object-fit: cover;" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27400%27%20height%3D%27400%27%3E%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27%23f1f5f9%27/%3E%3Ctext%20x%3D%2750%25%27%20y%3D%2750%25%27%20dominant-baseline%3D%27middle%27%20text-anchor%3D%27middle%27%20fill%3D%27%2394a3b8%27%20font-family%3D%27Arial%27%20font-size%3D%2718%27%3E%D0%A4%D0%BE%D1%82%D0%BE%3C/text%3E%3C/svg%3E';">`;
            preview.style.display = 'block';
            if (removeButton) {
                removeButton.style.display = 'block';
            }
        } else {
            preview.style.display = 'none';
            preview.innerHTML = '';
            if (removeButton) {
                removeButton.style.display = 'none';
            }
        }
    }
}

function removePersonPhoto(stepId, blockIndex, personIndex) {
    const photoInput = document.getElementById(`person-photo-${stepId}-${blockIndex}-${personIndex}`);
    const preview = document.getElementById(`person-photo-preview-${stepId}-${blockIndex}-${personIndex}`);
    const removeButton = document.getElementById(`person-photo-remove-${stepId}-${blockIndex}-${personIndex}`);
    const fileInput = document.getElementById(`person-photo-file-${stepId}-${blockIndex}-${personIndex}`);
    
    if (photoInput) {
        photoInput.value = '';
    }
    if (preview) {
        preview.style.display = 'none';
        preview.innerHTML = '';
    }
    if (removeButton) {
        removeButton.style.display = 'none';
    }
    if (fileInput) {
        fileInput.value = '';
    }
}

async function handlePersonPhotoSelect(event, stepId, blockIndex, personIndex) {
    const file = event.target.files[0];
    if (!file || !file.type.startsWith('image/')) {
        return;
    }
    await uploadPersonPhoto(file, stepId, blockIndex, personIndex);
    event.target.value = '';
}

async function handlePersonPhotoDrop(event, stepId, blockIndex, personIndex) {
    event.preventDefault();
    event.stopPropagation();
    
    const dropZone = event.currentTarget;
    dropZone.classList.remove('drag-over');
    
    const files = event.dataTransfer.files;
    if (files && files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
            await uploadPersonPhoto(file, stepId, blockIndex, personIndex);
        }
    }
}

async function uploadPersonPhoto(file, stepId, blockIndex, personIndex) {
    if (!file || !file.type.startsWith('image/')) {
        return;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –º–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω
    const isSidebar = window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager;
    let step;
    if (isSidebar) {
        step = window.sidebarWizardManager.wizardSteps.find(s => s.id === stepId);
    } else {
        step = wizardSteps.find(s => s.id === stepId);
    }
    
    if (!step) {
        console.error('Step not found:', stepId);
        return;
    }
    
    const section = step.endpoint || 'general';
    const uploadEndpoint = isSidebar ? '/sidebar/upload_file' : '/info/upload_file';
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('section', section);
    formData.append('field_name', `block_${blockIndex}_person_${personIndex}_photo`);
    
    try {
        const res = await fetch(uploadEndpoint, { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            const photoInput = document.getElementById(`person-photo-${stepId}-${blockIndex}-${personIndex}`);
            if (photoInput) {
                photoInput.value = result.url;
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                const preview = document.getElementById(`person-photo-preview-${stepId}-${blockIndex}-${personIndex}`);
                const removeButton = document.getElementById(`person-photo-remove-${stepId}-${blockIndex}-${personIndex}`);
                if (preview) {
                    preview.innerHTML = `<img src="${result.url}" alt="–§–æ—Ç–æ" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb; object-fit: cover;" onerror="this.style.display='none'">`;
                    preview.style.display = 'block';
                }
                if (removeButton) {
                    removeButton.style.display = 'block';
                }
            }
        } else {
            if (window.errorHandler && window.errorHandler.showError) {
                window.errorHandler.showError(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', result.instructions || []);
            }
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e);
        if (window.errorHandler && window.errorHandler.showError) {
            window.errorHandler.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', ['–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞']);
        }
    }
}

async function handleDishPhotoSelect(event, stepId, blockIndex, dishIndex) {
    const file = event.target.files[0];
    if (!file || !file.type.startsWith('image/')) {
        return;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –º–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω
    const isSidebar = window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager;
    let step;
    if (isSidebar) {
        step = window.sidebarWizardManager.wizardSteps.find(s => s.id === stepId);
    } else {
        step = wizardSteps.find(s => s.id === stepId);
    }
    
    if (!step) {
        console.error('Step not found:', stepId);
        return;
    }
    
    const section = step.endpoint || 'general';
    const uploadEndpoint = isSidebar ? '/sidebar/upload_file' : '/info/upload_file';
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('section', section);
    formData.append('field_name', `block_${blockIndex}_dish_${dishIndex}_photo`);
    
    try {
        const res = await fetch(uploadEndpoint, { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            const dishItem = document.querySelector(`#dishes-list-${stepId}-${blockIndex} .dish-item[data-index="${dishIndex}"]`);
            if (dishItem) {
                const photoInput = dishItem.querySelector('.dish-photo');
                if (photoInput) {
                    photoInput.value = result.url;
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                    const preview = dishItem.querySelector(`#dish-photo-preview-${stepId}-${blockIndex}-${dishIndex}`);
                    if (preview) {
                        preview.innerHTML = `<img src="${result.url}" alt="–§–æ—Ç–æ –±–ª—é–¥–∞" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb;">`;
                        preview.style.display = 'block';
                    }
                }
            }
        } else {
            if (window.errorHandler && window.errorHandler.showError) {
                window.errorHandler.showError(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', result.instructions || []);
            }
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e);
        if (window.errorHandler && window.errorHandler.showError) {
            window.errorHandler.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', ['–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞']);
        }
    }
    
    // –û—á–∏—â–∞–µ–º input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
    event.target.value = '';
}

function initializeDishesPhotos(stepId, blockIndex, block) {
    const dishes = Array.isArray(block.dishes) ? block.dishes : [];
    dishes.forEach((dish, idx) => {
        if (dish.photo) {
            const preview = document.getElementById(`dish-photo-preview-${stepId}-${blockIndex}-${idx}`);
            if (preview) {
                preview.innerHTML = `<img src="${dish.photo}" alt="–§–æ—Ç–æ –±–ª—é–¥–∞" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb;">`;
                preview.style.display = 'block';
            }
        }
    });
}

// –†–µ–¥–∞–∫—Ç–æ—Ä –±–ª—é–¥–∞ –Ω–∞ –¥–µ–Ω—å
function generateDailyDishEditForm(stepId, blockIndex, block) {
    const dish = block.dish || {
        title: '',
        date: new Date().toISOString().split('T')[0],
        publish_date: new Date().toISOString().split('T')[0],
        photo: ''
    };
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ DD.MM.YYYY –≤ YYYY-MM-DD –¥–ª—è input type="date"
    let dateValue = dish.date || new Date().toISOString().split('T')[0];
    if (dateValue.includes('.')) {
        const parts = dateValue.split('.');
        if (parts.length === 3) {
            dateValue = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
    }
    
    let publishDateValue = dish.publish_date || new Date().toISOString().split('T')[0];
    if (publishDateValue.includes('.')) {
        const parts = publishDateValue.split('.');
        if (parts.length === 3) {
            publishDateValue = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
    }
    
    return `
        <div class="wizard-block-edit-field">
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª—é–¥–∞</label>
            <input type="text" id="daily-dish-title-${stepId}-${blockIndex}" value="${dish.title || ''}" placeholder="–ë–ª—é–¥–æ –Ω–∞ –¥–µ–Ω—å" class="wizard-input">
        </div>
        <div class="wizard-block-edit-field">
            <label>–î–∞—Ç–∞ –±–ª—é–¥–∞</label>
            <input type="date" id="daily-dish-date-${stepId}-${blockIndex}" value="${dateValue}" class="wizard-input">
        </div>
        <div class="wizard-block-edit-field">
            <label>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
            <input type="date" id="daily-dish-publish-date-${stepId}-${blockIndex}" value="${publishDateValue}" class="wizard-input">
        </div>
        <div class="wizard-block-edit-field">
            <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <input type="text" id="daily-dish-photo-${stepId}-${blockIndex}" value="${dish.photo || ''}" placeholder="/static/uploads/nutrition/dishes/dish.jpg" class="wizard-input" style="flex: 1;">
                <button type="button" class="btn btn-sm btn-secondary" onclick="uploadDailyDishPhoto('${stepId}', ${blockIndex})" style="white-space: nowrap;">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            <div class="dish-photo-preview" id="daily-dish-photo-preview-${stepId}-${blockIndex}" style="margin-top: 10px; ${dish.photo ? '' : 'display: none;'}">
                ${dish.photo ? `<img src="${dish.photo}" alt="–§–æ—Ç–æ –±–ª—é–¥–∞" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb;">` : ''}
            </div>
            <input type="file" id="daily-dish-photo-input-${stepId}-${blockIndex}" accept="image/*" style="display: none;" onchange="handleDailyDishPhotoSelect(event, '${stepId}', ${blockIndex})">
        </div>
    `;
}

async function handleDailyDishPhotoSelect(event, stepId, blockIndex) {
    const file = event.target.files[0];
    if (!file || !file.type.startsWith('image/')) {
        return;
    }
    
    const isSidebar = window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager;
    let step;
    if (isSidebar) {
        step = window.sidebarWizardManager.wizardSteps.find(s => s.id === stepId);
    } else {
        step = wizardSteps.find(s => s.id === stepId);
    }
    
    if (!step) {
        console.error('Step not found:', stepId);
        return;
    }
    
    const section = step.endpoint || 'general';
    const uploadEndpoint = isSidebar ? '/sidebar/upload_file' : '/info/upload_file';
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('section', section);
    formData.append('field_name', `block_${blockIndex}_daily_dish_photo`);
    
    try {
        const res = await fetch(uploadEndpoint, { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
            const photoInput = document.getElementById(`daily-dish-photo-${stepId}-${blockIndex}`);
            if (photoInput) {
                photoInput.value = result.url;
            }
            const preview = document.getElementById(`daily-dish-photo-preview-${stepId}-${blockIndex}`);
            if (preview) {
                preview.innerHTML = `<img src="${result.url}" alt="–§–æ—Ç–æ –±–ª—é–¥–∞" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid #e5e7eb;">`;
                preview.style.display = 'block';
            }
        } else {
            if (window.errorHandler && window.errorHandler.showError) {
                window.errorHandler.showError(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', result.instructions || []);
            }
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e);
        if (window.errorHandler && window.errorHandler.showError) {
            window.errorHandler.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', ['–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞']);
        }
    }
    
    event.target.value = '';
}

function uploadDailyDishPhoto(stepId, blockIndex) {
    const input = document.getElementById(`daily-dish-photo-input-${stepId}-${blockIndex}`);
    if (input) {
        input.click();
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
function generateTableEditForm(stepId, blockIndex, block) {
    const headers = block.headers || [];
    const rows = block.rows || [];
    
    let headersHtml = '';
    for (let i = 0; i < Math.max(headers.length, 3); i++) {
        headersHtml += `
            <div class="table-header-input">
                <input type="text" id="header-${stepId}-${blockIndex}-${i}" value="${headers[i] || ''}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ ${i + 1}" oninput="updateTablePreview('${stepId}', ${blockIndex})">
                <button type="button" onclick="removeTableHeader('${stepId}', ${blockIndex}, ${i})" class="btn-remove-header" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫">√ó</button>
            </div>
        `;
    }
    
    let rowsHtml = '';
    for (let i = 0; i < Math.max(rows.length, 2); i++) {
        const row = rows[i] || [];
        let cellsHtml = '';
        for (let j = 0; j < Math.max(row.length, headers.length, 3); j++) {
            cellsHtml += `
                <input type="text" id="cell-${stepId}-${blockIndex}-${i}-${j}" value="${row[j] || ''}" placeholder="–Ø—á–µ–π–∫–∞ ${i + 1},${j + 1}" oninput="updateTablePreview('${stepId}', ${blockIndex})">
            `;
        }
        rowsHtml += `
            <div class="table-row-input">
                <div class="table-row-cells">
                    ${cellsHtml}
                </div>
                <button type="button" onclick="removeTableRow('${stepId}', ${blockIndex}, ${i})" class="btn-remove-row" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É">√ó</button>
            </div>
        `;
    }
    
    return `
        <div class="table-editor">
            <div class="table-editor-section">
                <div class="table-editor-header">
                    <h4>–ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã</h4>
                    <button type="button" onclick="addTableHeader('${stepId}', ${blockIndex})" class="btn btn-sm btn-primary">
                        <i class="icon">‚ûï</i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    </button>
                </div>
                <div class="table-headers-input" id="headers-${stepId}-${blockIndex}">
                    ${headersHtml}
                </div>
            </div>
            
            <div class="table-editor-section">
                <div class="table-editor-header">
                    <h4>–°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã</h4>
                    <button type="button" onclick="addTableRow('${stepId}', ${blockIndex})" class="btn btn-sm btn-primary">
                        <i class="icon">‚ûï</i> –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                    </button>
                </div>
                <div class="table-rows-input" id="rows-${stepId}-${blockIndex}">
                    ${rowsHtml}
                </div>
            </div>
            
            <div class="table-editor-section">
                <h4>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü—ã</h4>
                <div class="table-preview-container" id="table-preview-${stepId}-${blockIndex}">
                    ${generateTablePreview(stepId, blockIndex, block)}
                </div>
            </div>
        </div>
    `;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞
function generateListEditForm(stepId, blockIndex, block) {
    return `
        <div class="wizard-block-edit-field">
            <label>–≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ (–∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
            <textarea id="block-items-${stepId}-${blockIndex}-${Date.now()}" rows="6" placeholder="–≠–ª–µ–º–µ–Ω—Ç 1&#10;–≠–ª–µ–º–µ–Ω—Ç 2&#10;...">${block.items ? block.items.join('\n') : ''}</textarea>
        </div>
    `;
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
function closeBlockEditModal() {
    const modal = document.querySelector('.wizard-block-edit-modal');
    if (modal) {
        modal.remove();
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
function addTableHeader(stepId, blockIndex) {
    const headersContainer = document.getElementById(`headers-${stepId}-${blockIndex}`);
    const rowsContainer = document.getElementById(`rows-${stepId}-${blockIndex}`);
    const headerCount = headersContainer.children.length;
    
    const headerHtml = `
        <div class="table-header-input">
            <input type="text" id="header-${stepId}-${blockIndex}-${headerCount}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ ${headerCount + 1}" oninput="updateTablePreview('${stepId}', ${blockIndex})">
            <button type="button" onclick="removeTableHeader('${stepId}', ${blockIndex}, ${headerCount})" class="btn-remove-header" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫">√ó</button>
        </div>
    `;
    
    headersContainer.insertAdjacentHTML('beforeend', headerHtml);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —è—á–µ–π–∫—É –≤–æ –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏
    if (rowsContainer) {
        const rowInputs = rowsContainer.querySelectorAll('.table-row-input');
        rowInputs.forEach((rowInput, rowIndex) => {
            const cellsContainer = rowInput.querySelector('.table-row-cells');
            if (cellsContainer) {
                const cellHtml = `
                    <input type="text" id="cell-${stepId}-${blockIndex}-${rowIndex}-${headerCount}" placeholder="–Ø—á–µ–π–∫–∞ ${rowIndex + 1},${headerCount + 1}" oninput="updateTablePreview('${stepId}', ${blockIndex})">
                `;
                cellsContainer.insertAdjacentHTML('beforeend', cellHtml);
            }
        });
    }
    
    updateTablePreview(stepId, blockIndex);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
function removeTableHeader(stepId, blockIndex, headerIndex) {
    const headerElement = document.getElementById(`header-${stepId}-${blockIndex}-${headerIndex}`);
    const rowsContainer = document.getElementById(`rows-${stepId}-${blockIndex}`);
    
    if (headerElement) {
        headerElement.parentElement.remove();
        
        // –£–¥–∞–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —è—á–µ–π–∫—É –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
        if (rowsContainer) {
            const rowInputs = rowsContainer.querySelectorAll('.table-row-input');
            rowInputs.forEach((rowInput, rowIndex) => {
                const cellsContainer = rowInput.querySelector('.table-row-cells');
                if (cellsContainer) {
                    // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ —Ç–æ—á–Ω–æ–º—É ID
                    const cellToRemove = document.getElementById(`cell-${stepId}-${blockIndex}-${rowIndex}-${headerIndex}`);
                    if (cellToRemove) {
                        cellToRemove.remove();
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ ID, —É–¥–∞–ª—è–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É –≤ –º–∞—Å—Å–∏–≤–µ
                        const cellInputs = Array.from(cellsContainer.querySelectorAll('input'));
                        if (cellInputs[headerIndex]) {
                            cellInputs[headerIndex].remove();
                        }
                    }
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ —è—á–µ–µ–∫
        const headersContainer = document.getElementById(`headers-${stepId}-${blockIndex}`);
        if (headersContainer) {
            const headerInputs = headersContainer.querySelectorAll('input');
            headerInputs.forEach((input, newIndex) => {
                const oldId = input.id;
                const newId = `header-${stepId}-${blockIndex}-${newIndex}`;
                if (oldId !== newId) {
                    input.id = newId;
                    const removeBtn = input.parentElement.querySelector('button');
                    if (removeBtn) {
                        removeBtn.setAttribute('onclick', `removeTableHeader('${stepId}', ${blockIndex}, ${newIndex})`);
                    }
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã —è—á–µ–µ–∫ –≤ —Å—Ç—Ä–æ–∫–∞—Ö
        if (rowsContainer) {
            const rowInputs = rowsContainer.querySelectorAll('.table-row-input');
            rowInputs.forEach((rowInput, rowIndex) => {
                const cellsContainer = rowInput.querySelector('.table-row-cells');
                if (cellsContainer) {
                    const cellInputs = cellsContainer.querySelectorAll('input');
                    cellInputs.forEach((cellInput, cellIndex) => {
                        const oldId = cellInput.id;
                        const newId = `cell-${stepId}-${blockIndex}-${rowIndex}-${cellIndex}`;
                        if (oldId !== newId) {
                            cellInput.id = newId;
                            const placeholderMatch = cellInput.placeholder.match(/–Ø—á–µ–π–∫–∞ \d+,(\d+)/);
                            if (placeholderMatch) {
                                cellInput.placeholder = `–Ø—á–µ–π–∫–∞ ${rowIndex + 1},${cellIndex + 1}`;
                            }
                        }
                    });
                }
            });
        }
        
        updateTablePreview(stepId, blockIndex);
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
function addTableRow(stepId, blockIndex) {
    const rowsContainer = document.getElementById(`rows-${stepId}-${blockIndex}`);
    const headersContainer = document.getElementById(`headers-${stepId}-${blockIndex}`);
    const rowCount = rowsContainer.children.length;
    const headerCount = headersContainer.children.length;
    
    let cellsHtml = '';
    for (let j = 0; j < Math.max(headerCount, 3); j++) {
        cellsHtml += `
            <input type="text" id="cell-${stepId}-${blockIndex}-${rowCount}-${j}" placeholder="–Ø—á–µ–π–∫–∞ ${rowCount + 1},${j + 1}" oninput="updateTablePreview('${stepId}', ${blockIndex})">
        `;
    }
    
    const rowHtml = `
        <div class="table-row-input">
            <div class="table-row-cells">
                ${cellsHtml}
            </div>
            <button type="button" onclick="removeTableRow('${stepId}', ${blockIndex}, ${rowCount})" class="btn-remove-row" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É">√ó</button>
        </div>
    `;
    
    rowsContainer.insertAdjacentHTML('beforeend', rowHtml);
    updateTablePreview(stepId, blockIndex);
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
function removeTableRow(stepId, blockIndex, rowIndex) {
    const rowElement = document.querySelector(`#rows-${stepId}-${blockIndex} .table-row-input:nth-child(${rowIndex + 1})`);
    if (rowElement) {
        rowElement.remove();
        updateTablePreview(stepId, blockIndex);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
function updateTablePreview(stepId, blockIndex) {
    const previewContainer = document.getElementById(`table-preview-${stepId}-${blockIndex}`);
    if (!previewContainer) return;
    
    // –°–æ–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [];
    const headersContainer = document.getElementById(`headers-${stepId}-${blockIndex}`);
    if (headersContainer) {
        const headerInputs = headersContainer.querySelectorAll('input');
        headerInputs.forEach(input => {
            if (input.value.trim()) {
                headers.push(input.value.trim());
            }
        });
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏
    const rows = [];
    const rowsContainer = document.getElementById(`rows-${stepId}-${blockIndex}`);
    if (rowsContainer) {
        const rowInputs = rowsContainer.querySelectorAll('.table-row-input');
        rowInputs.forEach(rowInput => {
            const cellInputs = rowInput.querySelectorAll('.table-row-cells input');
            const row = [];
            cellInputs.forEach(cellInput => {
                if (cellInput.value.trim()) {
                    row.push(cellInput.value.trim());
                }
            });
            if (row.length > 0) {
                rows.push(row);
            }
        });
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Ç–∞–±–ª–∏—Ü—ã
    let tableHtml = '<div class="table-preview-table">';
    
    if (headers.length > 0) {
        tableHtml += '<div class="table-preview-header">';
        headers.forEach(header => {
            tableHtml += `<div class="table-preview-cell table-preview-header-cell">${header}</div>`;
        });
        tableHtml += '</div>';
    }
    
    if (rows.length > 0) {
        rows.forEach(row => {
            tableHtml += '<div class="table-preview-row">';
            for (let i = 0; i < Math.max(headers.length, row.length); i++) {
                const cellValue = row[i] || '';
                tableHtml += `<div class="table-preview-cell table-preview-data-cell">${cellValue}</div>`;
            }
            tableHtml += '</div>';
        });
    }
    
    if (headers.length === 0 && rows.length === 0) {
        tableHtml += '<div class="table-preview-empty">–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏.</div>';
    }
    
    tableHtml += '</div>';
    previewContainer.innerHTML = tableHtml;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –±–ª–æ–∫–∞
function generateTablePreview(stepId, blockIndex, block) {
    const headers = block.headers || [];
    const rows = block.rows || [];
    
    let tableHtml = '<div class="table-preview-table">';
    
    if (headers.length > 0) {
        tableHtml += '<div class="table-preview-header">';
        headers.forEach(header => {
            tableHtml += `<div class="table-preview-cell table-preview-header-cell">${header}</div>`;
        });
        tableHtml += '</div>';
    }
    
    if (rows.length > 0) {
        rows.forEach(row => {
            tableHtml += '<div class="table-preview-row">';
            for (let i = 0; i < Math.max(headers.length, row.length); i++) {
                const cellValue = row[i] || '';
                tableHtml += `<div class="table-preview-cell table-preview-data-cell">${cellValue}</div>`;
            }
            tableHtml += '</div>';
        });
    }
    
    if (headers.length === 0 && rows.length === 0) {
        tableHtml += '<div class="table-preview-empty">–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏.</div>';
    }
    
    tableHtml += '</div>';
    return tableHtml;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
function saveBlockEdit(stepId, blockIndex) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ sidebar wizard
    let stepData, updateDisplay;
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        stepData = window.sidebarWizardManager.wizardData[stepId];
        updateDisplay = () => window.sidebarWizardManager.renderCurrentStep();
    } else {
        stepData = wizardData[stepId];
        updateDisplay = () => {
            const step = wizardSteps.find(s => s.id === stepId);
            loadStepContent(step);
        };
    }
    
    if (!stepData || !stepData.content_blocks || !stepData.content_blocks[blockIndex]) {
        console.error('Block not found for saving:', stepId, blockIndex);
        return;
    }
    
    const block = stepData.content_blocks[blockIndex];
    // saveBlockEdit –≤—ã–∑–≤–∞–Ω
    
    const titleInput = document.querySelector(`input[id*="block-title-${stepId}-${blockIndex}"]`);
    if (titleInput) block.title = titleInput.value;
    const showTitleCheckbox = document.querySelector(`input[id*="block-show-title-${stepId}-${blockIndex}"]`);
    block.show_title = showTitleCheckbox ? showTitleCheckbox.checked : true;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    switch (block.type) {
        case 'text': {
            const contentInput = document.querySelector(`textarea[id*="block-content-${stepId}-${blockIndex}"]`);
            if (contentInput) {
                block.content = contentInput.value;
                // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
            } else {
                console.error('Content input not found');
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
            const photosList = document.getElementById(`block-photos-list-${stepId}-${blockIndex}`);
            if (photosList) {
                const photoItems = photosList.querySelectorAll('.block-photo-item');
                const photos = [];
                photoItems.forEach(item => {
                    const photoUrl = item.dataset.photoUrl;
                    if (photoUrl) {
                        photos.push(photoUrl);
                    }
                });
                block.photos = photos;
            } else if (!block.photos) {
                block.photos = [];
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞
            const documentsList = document.getElementById(`block-documents-list-${stepId}-${blockIndex}`);
            if (documentsList) {
                const documentItems = documentsList.querySelectorAll('.block-document-item');
                const documents = [];
                documentItems.forEach(item => {
                    const docUrl = item.dataset.docUrl;
                    const docName = item.dataset.docName || '';
                    if (docUrl) {
                        // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –∫–∞–∫ –æ–±—ä–µ–∫—Ç—ã —Å url –∏ name –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–º–µ–Ω–∏
                        documents.push({ url: docUrl, name: docName || docUrl.split('/').pop() || '–î–æ–∫—É–º–µ–Ω—Ç' });
                    }
                });
                block.documents = documents;
            } else if (!block.documents) {
                block.documents = [];
            }
            break;
        }
        case 'table':
            // –°–æ–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            const headers = [];
            const headersContainer = document.querySelector(`div[id*="headers-${stepId}-${blockIndex}"]`);
            if (headersContainer) {
                const headerInputs = headersContainer.querySelectorAll('input');
                headerInputs.forEach(input => {
                    if (input.value.trim()) {
                        headers.push(input.value.trim());
                    }
                });
            }
            block.headers = headers;
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
            
            // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏
            const rows = [];
            const rowsContainer = document.querySelector(`div[id*="rows-${stepId}-${blockIndex}"]`);
            if (rowsContainer) {
                const rowInputs = rowsContainer.querySelectorAll('.table-row-input');
                rowInputs.forEach(rowInput => {
                    const cellInputs = rowInput.querySelectorAll('.table-row-cells input');
                    const row = [];
                    cellInputs.forEach(cellInput => {
                        if (cellInput.value.trim()) {
                            row.push(cellInput.value.trim());
                        }
                    });
                    if (row.length > 0) {
                        rows.push(row);
                    }
                });
            }
            block.rows = rows;
            // –°—Ç—Ä–æ–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
            break;
        case 'list':
            const itemsInput = document.querySelector(`textarea[id*="block-items-${stepId}-${blockIndex}"]`);
            if (itemsInput) {
                const itemsText = itemsInput.value;
                block.items = itemsText ? itemsText.split('\n').filter(item => item.trim()) : [];
                // –≠–ª–µ–º–µ–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
            } else {
                console.error('Items input not found');
            }
            break;
        case 'photos':
            // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–≤—å—é (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å), –∏–Ω–∞—á–µ textarea —Å–æ —Å—Å—ã–ª–∫–∞–º–∏
            const photosList = document.getElementById(`block-photos-list-${stepId}-${blockIndex}`);
            if (photosList) {
                const photoItems = photosList.querySelectorAll('.block-photo-item');
                const photos = [];
                photoItems.forEach(item => {
                    const photoUrl = item.dataset.photoUrl;
                    if (photoUrl) photos.push(photoUrl);
                });
                block.photos = photos;
            } else {
                const photosInput = document.getElementById(`block-photos-${stepId}-${blockIndex}`);
                if (photosInput) {
                    const lines = photosInput.value.split('\n').map(s => s.trim()).filter(Boolean);
                    block.photos = lines;
                }
            }
            break;
        case 'documents': {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞
            const documentsList = document.getElementById(`block-documents-list-${stepId}-${blockIndex}`);
            if (documentsList) {
                const documentItems = documentsList.querySelectorAll('.block-document-item');
                const documents = [];
                documentItems.forEach(item => {
                    const docUrl = item.dataset.docUrl;
                    const docName = item.dataset.docName;
                    if (docUrl) {
                        documents.push({
                            url: docUrl,
                            name: docName || docUrl.split('/').pop() || '–î–æ–∫—É–º–µ–Ω—Ç'
                        });
                    }
                });
                block.documents = documents;
            } else if (!block.documents) {
                block.documents = [];
            }
            break;
        }
        case 'person':
            const listEl = document.getElementById(`person-list-${stepId}-${blockIndex}`);
            if (listEl) {
                const persons = [];
                listEl.querySelectorAll('.person-item').forEach(item => {
                    persons.push({
                        name: item.querySelector('.person-name')?.value || '',
                        position: item.querySelector('.person-position')?.value || '',
                        photo: item.querySelector('.person-photo')?.value || '',
                        description: item.querySelector('.person-description')?.value || ''
                    });
                });
                block.persons = persons;
                // –ü–µ—Ä—Å–æ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
            }
            break;
        case 'dishes':
            const dishesListEl = document.getElementById(`dishes-list-${stepId}-${blockIndex}`);
            if (dishesListEl) {
                const dishes = [];
                dishesListEl.querySelectorAll('.dish-item').forEach(item => {
                    const dateValue = item.querySelector('.dish-date')?.value || '';
                    const publishDateValue = item.querySelector('.dish-publish-date')?.value || '';
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DD –≤ DD.MM.YYYY –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    let dateDisplay = dateValue;
                    if (dateValue) {
                        const dateParts = dateValue.split('-');
                        if (dateParts.length === 3) {
                            dateDisplay = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
                        }
                    }
                    dishes.push({
                        title: item.querySelector('.dish-title')?.value || '',
                        date: dateDisplay,
                        publish_date: publishDateValue,
                        photo: item.querySelector('.dish-photo')?.value || ''
                    });
                });
                block.dishes = dishes;
                // –ë–ª—é–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
            }
            break;
        case 'daily-dish':
            const titleInput = document.getElementById(`daily-dish-title-${stepId}-${blockIndex}`);
            const dateInput = document.getElementById(`daily-dish-date-${stepId}-${blockIndex}`);
            const publishDateInput = document.getElementById(`daily-dish-publish-date-${stepId}-${blockIndex}`);
            const photoInput = document.getElementById(`daily-dish-photo-${stepId}-${blockIndex}`);
            
            let dateDisplay = dateInput?.value || '';
            if (dateDisplay) {
                const dateParts = dateDisplay.split('-');
                if (dateParts.length === 3) {
                    dateDisplay = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
                }
            }
            
            block.dish = {
                title: titleInput?.value || '',
                date: dateDisplay,
                publish_date: publishDateInput?.value || '',
                photo: photoInput?.value || ''
            };
            // –ë–ª—é–¥–æ –Ω–∞ –¥–µ–Ω—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
            break;
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –¥–ª—è sidebar wizard
    if (window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager) {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ wizardData
        if (!window.sidebarWizardManager.wizardData[stepId]) {
            window.sidebarWizardManager.wizardData[stepId] = {};
        }
        if (!window.sidebarWizardManager.wizardData[stepId].content_blocks) {
            window.sidebarWizardManager.wizardData[stepId].content_blocks = [];
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ –≤ –º–∞—Å—Å–∏–≤–µ
        if (window.sidebarWizardManager.wizardData[stepId].content_blocks[blockIndex]) {
            window.sidebarWizardManager.wizardData[stepId].content_blocks[blockIndex] = block;
        }
        window.wizardData = window.sidebarWizardManager.wizardData;
    }
    
    // –ë–ª–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
    closeBlockEditModal();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    updateDisplay();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–∞—Ö
function handleBlockPhotosDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.add('drag-over');
}

function handleBlockPhotosDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.remove('drag-over');
}

async function handleBlockPhotosDrop(event, stepId, blockIndex) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.remove('drag-over');
    
    const files = Array.from(event.dataTransfer.files || []);
    if (files.length === 0) return;
    
    await uploadBlockPhotos(files, stepId, blockIndex);
}

async function handleBlockPhotosSelect(event, stepId, blockIndex) {
    const files = Array.from(event.target.files || []);
    if (files.length === 0) return;
    
    await uploadBlockPhotos(files, stepId, blockIndex);
    // –û—á–∏—â–∞–µ–º input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
    event.target.value = '';
}

async function uploadBlockPhotos(files, stepId, blockIndex) {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –º–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω
    const isSidebar = window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager;
    let step;
    if (isSidebar) {
        step = window.sidebarWizardManager.wizardSteps.find(s => s.id === stepId);
    } else {
        step = wizardSteps.find(s => s.id === stepId);
    }
    
    if (!step) {
        console.error('Step not found:', stepId);
        return;
    }
    
    const section = step.endpoint || 'general';
    const uploadEndpoint = isSidebar ? '/sidebar/upload_file' : '/info/upload_file';
    
    const photosList = document.getElementById(`block-photos-list-${stepId}-${blockIndex}`);
    if (!photosList) return;
    
    for (const file of files) {
        if (!file.type.startsWith('image/')) {
            continue;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('section', section);
        formData.append('field_name', `block_${blockIndex}_photos`);
        
        try {
            const res = await fetch(uploadEndpoint, { method: 'POST', body: formData });
            const result = await res.json();
            if (result.success) {
                addBlockPhotoToList(stepId, blockIndex, result.url, result.original_name || result.filename);
            } else {
                if (window.errorHandler && window.errorHandler.showError) {
                    window.errorHandler.showError(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', result.instructions || []);
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e);
            if (window.errorHandler && window.errorHandler.showError) {
                window.errorHandler.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', ['–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞']);
            }
        }
    }
}

function addBlockPhotoToList(stepId, blockIndex, photoUrl, photoName) {
    const photosList = document.getElementById(`block-photos-list-${stepId}-${blockIndex}`);
    if (!photosList) return;
    
    const photoItem = document.createElement('div');
    photoItem.className = 'block-photo-item';
    photoItem.dataset.photoUrl = photoUrl;
    photoItem.innerHTML = `
        <div class="block-photo-preview">
            <img src="${photoUrl}" alt="${photoName}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27400%27%20height%3D%27400%27%3E%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27%23f1f5f9%27/%3E%3Ctext%20x%3D%2750%25%27%20y%3D%2750%25%27%20dominant-baseline%3D%27middle%27%20text-anchor%3D%27middle%27%20fill%3D%27%2394a3b8%27%20font-family%3D%27Arial%27%20font-size%3D%2718%27%3E%D0%A4%D0%BE%D1%82%D0%BE%3C/text%3E%3C/svg%3E';">
        </div>
        <div class="block-photo-info">
            <span class="block-photo-name">${photoName}</span>
        </div>
        <button type="button" class="block-photo-remove" onclick="removeBlockPhoto('${stepId}', ${blockIndex}, '${photoUrl}')">‚úï</button>
    `;
    photosList.appendChild(photoItem);

    // –ï—Å–ª–∏ –µ—Å—Ç—å textarea —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –±–ª–æ–∫–µ —Ç–∏–ø–∞ "photos") ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
    try {
        const textarea = document.getElementById(`block-photos-${stepId}-${blockIndex}`);
        if (textarea) {
            const urls = Array.from(photosList.querySelectorAll('.block-photo-item'))
                .map(el => el.dataset.photoUrl)
                .filter(Boolean);
            textarea.value = urls.join('\n');
        }
    } catch (e) {}
}

function removeBlockPhoto(stepId, blockIndex, photoUrl) {
    const photosList = document.getElementById(`block-photos-list-${stepId}-${blockIndex}`);
    if (!photosList) return;
    
    const photoItem = photosList.querySelector(`[data-photo-url="${photoUrl}"]`);
    if (photoItem) {
        photoItem.remove();
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è textarea, –µ—Å–ª–∏ –µ—Å—Ç—å
    try {
        const textarea = document.getElementById(`block-photos-${stepId}-${blockIndex}`);
        if (textarea) {
            const urls = Array.from(photosList.querySelectorAll('.block-photo-item'))
                .map(el => el.dataset.photoUrl)
                .filter(Boolean);
            textarea.value = urls.join('\n');
        }
    } catch (e) {}
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function initializeBlockPhotos(stepId, blockIndex, block) {
    const photosList = document.getElementById(`block-photos-list-${stepId}-${blockIndex}`);
    if (!photosList) return;
    
    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    photosList.innerHTML = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    const photos = Array.isArray(block.photos) ? block.photos : [];
    photos.forEach(photoUrl => {
        if (photoUrl) {
            const photoName = photoUrl.split('/').pop() || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            addBlockPhotoToList(stepId, blockIndex, photoUrl, photoName);
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º textarea, –µ—Å–ª–∏ –µ—Å—Ç—å (–¥–ª—è –±–ª–æ–∫–∞ —Ç–∏–ø–∞ "photos")
    try {
        const textarea = document.getElementById(`block-photos-${stepId}-${blockIndex}`);
        if (textarea) {
            textarea.value = photos.filter(Boolean).join('\n');
        }
    } catch (e) {}
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–ª–æ–∫–∞—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
function handleBlockDocumentsDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.add('drag-over');
}

function handleBlockDocumentsDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.remove('drag-over');
}

async function handleBlockDocumentsDrop(event, stepId, blockIndex) {
    event.preventDefault();
    event.stopPropagation();
    event.currentTarget.classList.remove('drag-over');
    
    const files = Array.from(event.dataTransfer.files || []);
    if (files.length === 0) return;
    
    await uploadBlockDocuments(files, stepId, blockIndex);
}

async function handleBlockDocumentsSelect(event, stepId, blockIndex) {
    const files = Array.from(event.target.files || []);
    if (files.length === 0) return;
    
    await uploadBlockDocuments(files, stepId, blockIndex);
    // –û—á–∏—â–∞–µ–º input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
    event.target.value = '';
}

async function uploadBlockDocuments(files, stepId, blockIndex) {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –º–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω
    const isSidebar = window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager;
    let step;
    if (isSidebar) {
        step = window.sidebarWizardManager.wizardSteps.find(s => s.id === stepId);
    } else {
        step = wizardSteps.find(s => s.id === stepId);
    }
    
    if (!step) {
        console.error('Step not found:', stepId);
        return;
    }
    
    const section = step.endpoint || 'general';
    const uploadEndpoint = isSidebar ? '/sidebar/upload_file' : '/info/upload_file';
    
    const documentsList = document.getElementById(`block-documents-list-${stepId}-${blockIndex}`);
    if (!documentsList) return;
    
    for (const file of files) {
        const allowedTypes = ['.pdf', '.doc', '.docx', '.txt', '.xls', '.xlsx', '.ppt', '.pptx', '.rtf', '.odt', '.ods', '.odp', '.sig', '.zip', '.rar', '.7z', '.tar', '.gz', '.tgz'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(fileExtension)) {
            if (window.errorHandler && window.errorHandler.showError) {
                window.errorHandler.showError(`–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞: ${fileExtension}`, ['–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: PDF, DOC, DOCX, TXT, XLS, XLSX, PPT, PPTX, RTF, ODT, ODS, ODP, SIG']);
            }
            continue;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('section', section);
        formData.append('field_name', `block_${blockIndex}_documents`);
        
        try {
            const res = await fetch(uploadEndpoint, { method: 'POST', body: formData });
            const result = await res.json();
            if (result.success) {
                addBlockDocumentToList(stepId, blockIndex, result.url, result.original_name || result.filename);
            } else {
                if (window.errorHandler && window.errorHandler.showError) {
                    window.errorHandler.showError(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞', result.instructions || []);
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', e);
            if (window.errorHandler && window.errorHandler.showError) {
                window.errorHandler.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞', ['–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞']);
            }
        }
    }
}

function addBlockDocumentToList(stepId, blockIndex, docUrl, docName) {
    const documentsList = document.getElementById(`block-documents-list-${stepId}-${blockIndex}`);
    if (!documentsList) return;
    
    const docItem = document.createElement('div');
    docItem.className = 'block-document-item';
    docItem.dataset.docUrl = docUrl;
    docItem.dataset.docName = docName;
    docItem.innerHTML = `
        <div class="block-document-info">
            <span class="block-document-icon">üìÑ</span>
            <span class="block-document-name">${docName}</span>
        </div>
        <button type="button" class="block-document-remove" onclick="removeBlockDocument('${stepId}', ${blockIndex}, '${docUrl}')">‚úï</button>
    `;
    documentsList.appendChild(docItem);
}

async function removeBlockDocument(stepId, blockIndex, docUrl) {
    const documentsList = document.getElementById(`block-documents-list-${stepId}-${blockIndex}`);
    if (!documentsList) return;
    
    const docItem = documentsList.querySelector(`[data-doc-url="${docUrl}"]`);
    if (!docItem) return;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –º–∞—Å—Ç–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω
    const isSidebar = window.IS_SIDEBAR_WIZARD && window.sidebarWizardManager;
    let step;
    if (isSidebar) {
        step = window.sidebarWizardManager.wizardSteps.find(s => s.id === stepId);
    } else {
        step = wizardSteps.find(s => s.id === stepId);
    }
    
    if (!step) {
        console.error('Step not found:', stepId);
        return;
    }
    
    const section = step.endpoint || 'general';
    const deleteEndpoint = isSidebar ? '/sidebar/delete_file' : '/info/delete_file';
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ URL
    const filename = docUrl.split('/').pop();
    
    try {
        // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª —Å —Å–µ—Ä–≤–µ—Ä–∞
        const res = await fetch(deleteEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                filename: filename,
                section: section,
                field_name: `block_${blockIndex}_documents`
            })
        });
        
        const result = await res.json();
        
        if (result.success) {
            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
            docItem.remove();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏
            if (window.errorHandler && window.errorHandler.showSuccess) {
                window.errorHandler.showSuccess('–î–æ–∫—É–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω');
            }
        } else {
            // –î–∞–∂–µ –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —É–¥–∞–ª—è–µ–º –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            docItem.remove();
            
            if (window.errorHandler && window.errorHandler.showError) {
                window.errorHandler.showError(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞', result.instructions || []);
            }
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:', e);
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        docItem.remove();
        
        if (window.errorHandler && window.errorHandler.showError) {
            window.errorHandler.showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞', ['–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞']);
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function initializeBlockDocuments(stepId, blockIndex, block) {
    const documentsList = document.getElementById(`block-documents-list-${stepId}-${blockIndex}`);
    if (!documentsList) return;
    
    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    documentsList.innerHTML = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
    const documents = Array.isArray(block.documents) ? block.documents : [];
    documents.forEach(doc => {
        if (doc) {
            let docUrl, docName;
            if (typeof doc === 'string') {
                docUrl = doc;
                docName = doc.split('/').pop() || '–î–æ–∫—É–º–µ–Ω—Ç';
            } else {
                docUrl = doc.url || (doc.get && doc.get('url', '')) || '';
                docName = doc.name || (doc.get && doc.get('name', '')) || docUrl.split('/').pop() || '–î–æ–∫—É–º–µ–Ω—Ç';
            }
            if (docUrl) {
                addBlockDocumentToList(stepId, blockIndex, docUrl, docName);
            }
        }
    });
}




// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
async function saveCurrentStep() {
    // saveCurrentStep –≤—ã–∑–≤–∞–Ω
    const step = wizardSteps[currentWizardStep];
    if (!step) {
        console.error('Step not found:', currentWizardStep);
        return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–≥–∞
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
    await saveCurrentStepData();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    showSaveStatus('saving', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const formData = new FormData();
    const dataToSend = {[step.id]: wizardData[step.id]};
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    formData.append('wizard_data', JSON.stringify(dataToSend));
    formData.append('save_single', 'true');
    
    fetch('/info/wizard_save', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        }
    })
    .then(response => {
        // –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—É—á–µ–Ω
        return response.json();
    })
    .then(data => {
        // –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—É—á–µ–Ω—ã
        if (data.success) {
            showSaveStatus('success', '–®–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —à–∞–≥–∞ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ
            updateStepStatus(currentWizardStep, true);
        } else {
            console.error('Save failed:', data.error);
            showSaveStatus('error', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showSaveStatus('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    });
}

// –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function showSaveStatus(type, message) {
    const statusElement = document.getElementById('wizard-save-status');
    if (!statusElement) return;
    
    // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã
    statusElement.className = 'wizard-save-status';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –∏ —Ç–µ–∫—Å—Ç
    statusElement.classList.add(type);
    statusElement.textContent = message;
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã (–∫—Ä–æ–º–µ –æ—à–∏–±–æ–∫)
    if (type !== 'error') {
        setTimeout(() => {
            statusElement.className = 'wizard-save-status';
            statusElement.textContent = '';
        }, 3000);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —à–∞–≥–∞
function updateStepStatus(stepIndex, completed) {
    const stepElement = document.querySelector(`.wizard-step:nth-child(${stepIndex + 1})`);
    if (stepElement) {
        if (completed) {
            stepElement.classList.add('completed');
            stepElement.classList.remove('active');
        }
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
async function wizardSave() {
    // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
    await cleanOrphanedFiles();
    
    await saveCurrentStepData();
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const formData = new FormData();
    formData.append('wizard_data', JSON.stringify(wizardData));
    
    fetch('/info/wizard_save', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            closeWizardModal();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
async function cleanMissingFiles() {
    if (!confirm('–í–´ –£–í–ï–†–ï–ù–´? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –∏–∑ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤!')) {
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ—á–∏—Å—Ç–∫–∏
    const statusElement = document.getElementById('wizard-save-status');
    if (statusElement) {
        statusElement.innerHTML = 'üßπ –û—á–∏—â–∞–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã...';
        statusElement.style.color = '#f59e0b';
    }
    
    try {
        const response = await fetch('/info/clean_missing_files', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (statusElement) {
                statusElement.innerHTML = '‚úÖ ' + data.message;
                statusElement.style.color = '#10b981';
            }
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            await loadWizardData();
            alert('‚úÖ ' + data.message + '\n\n–§–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.');
        } else {
            if (statusElement) {
                statusElement.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ' + data.error;
                statusElement.style.color = '#ef4444';
            }
            alert('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ' + data.error);
        }
    } catch (error) {
        if (statusElement) {
            statusElement.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ' + error.message;
            statusElement.style.color = '#ef4444';
        }
        alert('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ' + error.message);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Ñ–æ–Ω—É
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('wizard-backdrop')) {
        closeWizardModal();
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('wizard-modal').style.display === 'flex') {
        closeWizardModal();
    }
});



// –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏

// –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ
window.openWizard = openWizard;
window.openWizardModal = openWizardModal;
window.closeWizardModal = closeWizardModal;
window.wizardNext = wizardNext;
window.wizardPrevious = wizardPrevious;
window.saveCurrentStep = saveCurrentStep;
window.goToStep = goToStep;
window.loadStep = loadStep;
window.loadStepContent = loadStepContent;
window.setWizardMode = setWizardMode;
window.addContentBlock = addContentBlock;
window.showBlockTypeModal = showBlockTypeModal;
window.closeBlockTypeModal = closeBlockTypeModal;
window.selectBlockType = selectBlockType;
window.editContentBlock = editContentBlock;
window.removeContentBlock = removeContentBlock;
window.moveBlockUp = moveBlockUp;
window.moveBlockDown = moveBlockDown;
window.generateBlocksHtml = generateBlocksHtml;
// window.toggleInputType = toggleInputType; // –¢–µ–ø–µ—Ä—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ wizard.js
window.handleDragOver = handleDragOver;
window.handleDragLeave = handleDragLeave;
window.handleFileDrop = handleFileDrop;
window.handleFileSelect = handleFileSelect;
window.handleFiles = handleFiles;
window.removeFile = removeFile;
window.uploadFiles = uploadFiles;
window.getFileIconFromUrl = getFileIconFromUrl;
window.handleBlockPhotosDragOver = handleBlockPhotosDragOver;
window.handleBlockPhotosDragLeave = handleBlockPhotosDragLeave;
window.handleBlockPhotosDrop = handleBlockPhotosDrop;
window.handleBlockPhotosSelect = handleBlockPhotosSelect;
window.uploadBlockPhotos = uploadBlockPhotos;
window.addBlockPhotoToList = addBlockPhotoToList;
window.removeBlockPhoto = removeBlockPhoto;
window.initializeBlockPhotos = initializeBlockPhotos;
window.handleBlockDocumentsDragOver = handleBlockDocumentsDragOver;
window.handleBlockDocumentsDragLeave = handleBlockDocumentsDragLeave;
window.handleBlockDocumentsDrop = handleBlockDocumentsDrop;
window.handleBlockDocumentsSelect = handleBlockDocumentsSelect;
window.uploadBlockDocuments = uploadBlockDocuments;
window.addBlockDocumentToList = addBlockDocumentToList;
window.removeBlockDocument = removeBlockDocument;
window.initializeBlockDocuments = initializeBlockDocuments;
window.addDish = addDish;
window.removeDish = removeDish;
window.uploadDishPhoto = uploadDishPhoto;
window.handleDishPhotoSelect = handleDishPhotoSelect;

// –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.wizardSteps = wizardSteps;
window.wizardData = wizardData;
window.currentWizardStep = currentWizardStep;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è HTML —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
function insertHtmlTag(fieldName, tag) {
    const textarea = document.querySelector(`textarea[name="${fieldName}"]`);
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let htmlTag = '';
    switch(tag) {
        case 'h3':
            htmlTag = `<h3>${selectedText || '–ó–∞–≥–æ–ª–æ–≤–æ–∫'}</h3>`;
            break;
        case 'p':
            htmlTag = `<p>${selectedText || '–¢–µ–∫—Å—Ç –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞'}</p>`;
            break;
        case 'br':
            htmlTag = '<br>';
            break;
        case 'strong':
            htmlTag = `<strong>${selectedText || '–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç'}</strong>`;
            break;
        case 'em':
            htmlTag = `<em>${selectedText || '–ö—É—Ä—Å–∏–≤'}</em>`;
            break;
        case 'ul':
            htmlTag = `<ul>\n<li>${selectedText || '–≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞'}</li>\n</ul>`;
            break;
        case 'ol':
            htmlTag = `<ol>\n<li>${selectedText || '–≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞'}</li>\n</ol>`;
            break;
        case 'li':
            htmlTag = `<li>${selectedText || '–≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞'}</li>`;
            break;
        default:
            return;
    }
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º HTML —Ç–µ–≥
    textarea.value = textarea.value.substring(0, start) + htmlTag + textarea.value.substring(end);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞
    const newPosition = start + htmlTag.length;
    textarea.setSelectionRange(newPosition, newPosition);
    textarea.focus();
}

window.insertHtmlTag = insertHtmlTag;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ textarea (–¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤)
function formatText(textareaId, format) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let formattedText = '';
    switch(format) {
        case 'bold':
            formattedText = `<strong>${selectedText || '–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç'}</strong>`;
            break;
        case 'italic':
            formattedText = `<em>${selectedText || '–ö—É—Ä—Å–∏–≤'}</em>`;
            break;
        case 'underline':
            formattedText = `<u>${selectedText || '–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç'}</u>`;
            break;
        case 'strike':
            formattedText = `<s>${selectedText || '–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç'}</s>`;
            break;
        case 'h1':
            formattedText = `<h1>${selectedText || '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1'}</h1>`;
            break;
        case 'h2':
            formattedText = `<h2>${selectedText || '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2'}</h2>`;
            break;
        case 'h3':
            formattedText = `<h3>${selectedText || '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3'}</h3>`;
            break;
        case 'h4':
            formattedText = `<h4>${selectedText || '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 4'}</h4>`;
            break;
        case 'p':
            formattedText = `<p>${selectedText || '–¢–µ–∫—Å—Ç –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞'}</p>`;
            break;
        case 'ul':
            formattedText = `<ul>\n<li>${selectedText || '–≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞'}</li>\n</ul>`;
            break;
        case 'ol':
            formattedText = `<ol>\n<li>${selectedText || '–≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞'}</li>\n</ol>`;
            break;
        case 'li':
            formattedText = `<li>${selectedText || '–≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞'}</li>`;
            break;
        case 'align-left':
            formattedText = `<div style="text-align: left;">${selectedText || '–¢–µ–∫—Å—Ç –≤—ã—Ä–æ–≤–Ω–µ–Ω –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é'}</div>`;
            break;
        case 'align-center':
            formattedText = `<div style="text-align: center;">${selectedText || '–¢–µ–∫—Å—Ç –≤—ã—Ä–æ–≤–Ω–µ–Ω –ø–æ —Ü–µ–Ω—Ç—Ä—É'}</div>`;
            break;
        case 'align-right':
            formattedText = `<div style="text-align: right;">${selectedText || '–¢–µ–∫—Å—Ç –≤—ã—Ä–æ–≤–Ω–µ–Ω –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é'}</div>`;
            break;
        case 'align-justify':
            formattedText = `<div style="text-align: justify;">${selectedText || '–¢–µ–∫—Å—Ç –≤—ã—Ä–æ–≤–Ω–µ–Ω –ø–æ —à–∏—Ä–∏–Ω–µ'}</div>`;
            break;
        case 'br':
            formattedText = '<br>';
            break;
        case 'hr':
            formattedText = '<hr>';
            break;
        case 'code':
            formattedText = `<code>${selectedText || '–∫–æ–¥'}</code>`;
            break;
        case 'mark':
            formattedText = `<mark>${selectedText || '–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç'}</mark>`;
            break;
        case 'small':
            formattedText = `<small>${selectedText || '–º–∞–ª–µ–Ω—å–∫–∏–π —Ç–µ–∫—Å—Ç'}</small>`;
            break;
        default:
            return;
    }
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    const newPosition = start + formattedText.length;
    textarea.setSelectionRange(newPosition, newPosition);
    textarea.focus();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
    updateBlockContentPreview(textareaId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Å—Å—ã–ª–∫–∏
function insertLink(textareaId) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL —Å—Å—ã–ª–∫–∏:', 'https://');
    if (!url) return;
    
    const linkText = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏:', selectedText || '–°—Å—ã–ª–∫–∞');
    if (linkText === null) return;
    
    const linkHtml = `<a href="${url}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
    
    textarea.value = textarea.value.substring(0, start) + linkHtml + textarea.value.substring(end);
    
    const newPosition = start + linkHtml.length;
    textarea.setSelectionRange(newPosition, newPosition);
    textarea.focus();
    
    updateBlockContentPreview(textareaId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–∞–ª–∏—Ç—Ä—ã —Å–º–∞–π–ª–æ–≤
function showEmojiPicker(textareaId, event) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–∞–ª–∏—Ç—Ä—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    const existingPicker = document.getElementById('emoji-picker');
    if (existingPicker) {
        existingPicker.remove();
        return;
    }
    
    // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–º–∞–π–ª—ã
    const emojis = [
        'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá',
        'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö',
        'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©',
        'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
        'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨',
        'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó',
        'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ',
        'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
        'üëç', 'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëè', 'üôå',
        'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂',
        '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî',
        '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è',
        '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâ', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê',
        '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê',
        '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥',
        'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è',
        '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è',
        'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è',
        'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì',
        '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è',
        'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†',
        '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ',
        'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂',
        'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí',
        'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£',
        '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî¢', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚ñ∂Ô∏è', '‚è∏', '‚èØ', '‚èπ',
        '‚è∫', '‚è≠', '‚èÆ', '‚è©', '‚è™', '‚è´', '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ',
        '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è',
        '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÑ', 'üîÉ', 'üéµ',
        'üé∂', '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', 'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è',
        '„Ä∞Ô∏è', '‚û∞', '‚ûø', 'üîö', 'üîô', 'üîõ', 'üîú', 'üîù', '‚úîÔ∏è', '‚òëÔ∏è',
        'üîò', '‚ö™', '‚ö´', 'üî¥', 'üîµ', 'üü†', 'üü°', 'üü¢', 'üü£', 'üü§',
        '‚¨õ', '‚¨ú', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', 'üü´', 'üî∂',
        'üî∑', 'üî∏', 'üîπ', 'üî∫', 'üîª', 'üí†', 'üîò', 'üî≥', 'üî≤', '‚óºÔ∏è',
        '‚óªÔ∏è', '‚óæ', '‚óΩ', '‚ñ™Ô∏è', '‚ñ´Ô∏è'
    ];
    
    const picker = document.createElement('div');
    picker.id = 'emoji-picker';
    picker.style.cssText = `
        position: fixed;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        max-width: 400px;
        max-height: 400px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 8px;
    `;
    
    emojis.forEach(emoji => {
        const emojiBtn = document.createElement('button');
        emojiBtn.textContent = emoji;
        emojiBtn.type = 'button';
        emojiBtn.style.cssText = `
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        `;
        emojiBtn.onmouseover = function() {
            this.style.background = '#3b82f6';
            this.style.transform = 'scale(1.2)';
        };
        emojiBtn.onmouseout = function() {
            this.style.background = '#f8f9fa';
            this.style.transform = 'scale(1)';
        };
        emojiBtn.onclick = function() {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + emoji + textarea.value.substring(end);
            textarea.setSelectionRange(start + emoji.length, start + emoji.length);
            textarea.focus();
            updateBlockContentPreview(textareaId);
            picker.remove();
        };
        picker.appendChild(emojiBtn);
    });
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∞–ª–∏—Ç—Ä—É —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π
    let button = null;
    if (event && event.currentTarget) {
        button = event.currentTarget;
    } else if (window.event && window.event.currentTarget) {
        button = window.event.currentTarget;
    } else {
        button = document.querySelector(`button[onclick*="showEmojiPicker('${textareaId}')"]`);
    }
    
    if (button) {
        const rect = button.getBoundingClientRect();
        picker.style.top = (rect.bottom + 5) + 'px';
        picker.style.left = Math.max(10, rect.left - 100) + 'px';
    } else {
        picker.style.top = '50%';
        picker.style.left = '50%';
        picker.style.transform = 'translate(-50%, -50%)';
    }
    
    document.body.appendChild(picker);
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    setTimeout(() => {
        const closePicker = (e) => {
            if (!picker.contains(e.target) && (!button || e.target !== button)) {
                picker.remove();
                document.removeEventListener('click', closePicker);
            }
        };
        document.addEventListener('click', closePicker);
    }, 100);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ HTML-—Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤
function initializeBlockContentEditor(textareaId) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    textarea.addEventListener('input', function() {
        updateBlockContentPreview(textareaId);
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
    updateBlockContentPreview(textareaId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –±–ª–æ–∫–∞
function updateBlockContentPreview(textareaId) {
    const textarea = document.getElementById(textareaId);
    const preview = document.getElementById(`${textareaId}_preview`);
    
    if (!textarea || !preview) return;
    
    const previewContent = preview.querySelector('.html-preview-content');
    if (!previewContent) return;
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º HTML
    previewContent.innerHTML = textarea.value || '<em>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</em>';
}

window.formatText = formatText;
window.insertLink = insertLink;
window.showEmojiPicker = showEmojiPicker;
window.initializeBlockContentEditor = initializeBlockContentEditor;
window.updateBlockContentPreview = updateBlockContentPreview;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ HTML
function updateHtmlPreview(fieldName) {
    const textarea = document.querySelector(`textarea[name="${fieldName}"]`);
    const preview = document.getElementById(`${fieldName}_preview`);
    
    if (!textarea || !preview) return;
    
    const previewContent = preview.querySelector('.html-preview-content');
    if (!previewContent) return;
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º HTML
    previewContent.innerHTML = textarea.value || '<em>–í–≤–µ–¥–∏—Ç–µ HTML-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</em>';
}

window.updateHtmlPreview = updateHtmlPreview;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ HTML —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
function initializeHtmlEditors() {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö HTML-—Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
    document.querySelectorAll('.html-editor-textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
            updateHtmlPreview(this.name);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
        updateHtmlPreview(textarea.name);
    });
}

window.initializeHtmlEditors = initializeHtmlEditors;

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
window.addTableHeader = addTableHeader;
window.removeTableHeader = removeTableHeader;
window.addTableRow = addTableRow;
window.removeTableRow = removeTableRow;
window.updateTablePreview = updateTablePreview;
window.saveBlockEdit = saveBlockEdit;
window.closeBlockEditModal = closeBlockEditModal;
window.showBlockEditModal = showBlockEditModal;
window.editContentBlock = editContentBlock;
window.removeContentBlock = removeContentBlock;
window.moveBlockUp = moveBlockUp;
window.moveBlockDown = moveBlockDown;
window.showBlockTypeModal = showBlockTypeModal;
window.closeBlockTypeModal = closeBlockTypeModal;
window.selectBlockType = selectBlockType;
window.generateBlocksHtml = generateBlocksHtml;
window.addContentBlock = addContentBlock;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª–µ–π

</script>

<!-- –ú–æ–¥—É–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã -->
<script src="/static/error-handler.js"></script>
<script src="/static/forms.js"></script>
<script src="/static/modals.js"></script>
<script src="/static/html-editor.js"></script>
<script src="/static/content-blocks.js"></script>
<script src="/static/create-sidebar-section.js"></script>
<script src="/static/sidebar-wizard.js"></script>
<script src="/static/wizard.js?v=7"></script>
<script src="/static/app.js?v=2"></script>
</body>
</html> 
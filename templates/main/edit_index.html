{% extends "base.html" %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –Æ–Ω–æ–Ω–∞{% endblock %}
{% block content %}
<style>
.edit-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
}

.edit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e5e7eb;
}

.edit-form {
    background: white;
    padding: 32px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.form-section {
    margin-bottom: 32px;
    padding: 24px;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}

.form-section h2 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #1e293b;
    font-size: 1.5rem;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
    font-size: 1.1rem;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    box-sizing: border-box;
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.list-item {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    align-items: center;
}

.list-item input {
    flex: 1;
}

.btn-remove {
    background: #ef4444;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}

.btn-remove:hover {
    background: #dc2626;
}

.btn-add {
    background: #10b981;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 12px;
}

.btn-add:hover {
    background: #059669;
}

.btn-group {
    display: flex;
    gap: 12px;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 2px solid #e5e7eb;
}

.btn-save {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    padding: 12px 32px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
}

.btn-save:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

.btn-cancel {
    background: #6b7280;
    color: white;
    border: none;
    padding: 12px 32px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-cancel:hover {
    background: #4b5563;
}

.block-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
}

.block-card-header h2 {
    margin: 0;
}

.btn-move {
    background: #e5e7eb;
    border: 1px solid #d1d5db;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.1rem;
    line-height: 1;
}

.btn-move:hover {
    background: #d1d5db;
}

.btn-move + .btn-move {
    margin-left: 4px;
}

.block-placeholder {
    color: #6b7280;
    padding: 12px 0;
}

.block-placeholder a {
    color: #3b82f6;
}
</style>

<div class="edit-container">
    <div class="edit-header">
        <h1>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h1>
        <a href="/" class="btn-cancel">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    {% set block_order = page_content.get('block_order', ['header', 'slider', 'announcements', 'news', 'school_info', 'directions', 'events_achievements']) %}
    {% set block_titles = {'header': '–ë–ª–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', 'slider': '–°–ª–∞–π–¥–µ—Ä –Ω–∞ –≥–ª–∞–≤–Ω–æ–π', 'news': '–ù–æ–≤–æ—Å—Ç–∏', 'school_info': '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è, IT-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –ü–µ–¥–∞–≥–æ–≥–∏, –ü–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ', 'directions': '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è', 'events_achievements': '–°–æ–±—ã—Ç–∏—è –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è', 'announcements': '–û–±—ä—è–≤–ª–µ–Ω–∏—è'} %}

    <form class="edit-form" id="editForm" method="POST">
        <input type="hidden" name="block_order" id="blockOrderInput" value="{{ page_content.get('block_order_json', '[]') }}">
        <div id="blocks-container">
        {% for block_id in block_order %}
        <div class="form-section block-card" data-block-id="{{ block_id }}">
            <div class="block-card-header">
                <h2>{{ block_titles.get(block_id, block_id) }}</h2>
                <div>
                    <button type="button" class="btn-move" onclick="moveBlock('{{ block_id }}', -1)" title="–í–≤–µ—Ä—Ö">‚Üë</button>
                    <button type="button" class="btn-move" onclick="moveBlock('{{ block_id }}', 1)" title="–í–Ω–∏–∑">‚Üì</button>
                </div>
            </div>

            {% if block_id == 'header' %}
            <p style="color: #6b7280; margin: 0 0 16px 0; font-size: 0.95rem;">–¢–µ–∫—Å—Ç –≤ —à–∞–ø–∫–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –±–ª–æ–∫).</p>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:</label>
                <input type="text" name="header_title" value="{{ page_content.get('header_title', '') }}" placeholder="–ú–ë–û–£ ¬´–ò–¢ –ì–∏–º–Ω–∞–∑–∏—è ¬´–Æ–Ω–æ–Ω–∞¬ª">
            </div>
            <div class="form-group">
                <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                <input type="text" name="header_subtitle" value="{{ page_content.get('header_subtitle', '') }}" placeholder="–ø—Ä–∏ –í–ò–¢–ò –ù–ò–Ø–£ –ú–ò–§–ò –≥. –í–æ–ª–≥–æ–¥–æ–Ω—Å–∫–∞">
            </div>
            <div class="form-group">
                <label>–¢–µ–≥–∏ (–æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–¥ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–º, —á–µ—Ä–µ–∑ ‚Ä¢):</label>
                <div id="header-tags-list">
                    {% for tag in page_content.get('header_tags', []) %}
                    <div class="list-item">
                        <input type="text" name="header_tags[]" value="{{ tag }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: üöÄ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">
                        <button type="button" class="btn-remove" onclick="removeListItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add" onclick="addListItem('header-tags-list', 'header_tags[]')">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
            </div>

            {% elif block_id == 'news' %}
            <p class="block-placeholder">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ <a href="/news">–ù–æ–≤–æ—Å—Ç–∏</a>. –ù–∞ –≥–ª–∞–≤–Ω–æ–π –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–æ 4 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π.</p>

            {% elif block_id == 'slider' %}
            <input type="hidden" name="slider_images" id="sliderImagesInput" value="{{ page_content.get('slider_images_json', '[]') }}">
            <p style="color: #6b7280; margin: 0 0 12px 0; font-size: 0.95rem;">–§–æ—Ç–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ª–∞–π–¥–µ—Ä–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π. –ü–æ—Ä—è–¥–æ–∫: —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑.</p>
            <div id="slider-images-list" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px;">
                {% for url in page_content.get('slider_images', []) %}
                <div class="slider-image-item" style="position: relative; width: 120px;">
                    <img src="{{ url }}" alt="" style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px; display: block;">
                    <button type="button" class="btn-remove" onclick="removeSliderImage(this)" style="position: absolute; top: 4px; right: 4px; padding: 4px 8px; font-size: 0.85rem;">√ó</button>
                </div>
                {% endfor %}
            </div>
            <div>
                <label class="btn-add" style="display: inline-block; cursor: pointer; margin-bottom: 0;">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                    <input type="file" id="sliderFileInput" accept="image/jpeg,image/png,image/gif,image/webp" multiple style="display: none;">
                </label>
            </div>

            {% elif block_id == 'school_info' %}
            <div class="form-group">
                <label>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</label>
                <div id="achievements-list">
                    {% for item in page_content.get('achievements', []) %}
                    <div class="list-item">
                        <input type="text" name="achievements[]" value="{{ item }}" placeholder="–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ">
                        <button type="button" class="btn-remove" onclick="removeListItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add" onclick="addListItem('achievements-list', 'achievements[]')">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</button>
            </div>
            <div class="form-group">
                <label>IT-–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</label>
                <div id="it-infrastructure-list">
                    {% for item in page_content.get('it_infrastructure', []) %}
                    <div class="list-item">
                        <input type="text" name="it_infrastructure[]" value="{{ item }}" placeholder="–≠–ª–µ–º–µ–Ω—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã">
                        <button type="button" class="btn-remove" onclick="removeListItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add" onclick="addListItem('it-infrastructure-list', 'it_infrastructure[]')">+ –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
            </div>
            <div class="form-group">
                <label>–ü–µ–¥–∞–≥–æ–≥–∏</label>
                <div id="teachers-list">
                    {% for item in page_content.get('teachers', []) %}
                    <div class="list-item">
                        <input type="text" name="teachers[]" value="{{ item }}" placeholder="–ü—É–Ω–∫—Ç –æ –ø–µ–¥–∞–≥–æ–≥–∞—Ö">
                        <button type="button" class="btn-remove" onclick="removeListItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add" onclick="addListItem('teachers-list', 'teachers[]')">+ –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</button>
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ</label>
                <div id="partnership-list">
                    {% for item in page_content.get('partnership', []) %}
                    <div class="list-item">
                        <input type="text" name="partnership[]" value="{{ item }}" placeholder="–ü–∞—Ä—Ç–Ω—ë—Ä">
                        <button type="button" class="btn-remove" onclick="removeListItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add" onclick="addListItem('partnership-list', 'partnership[]')">+ –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞</button>
            </div>

            {% elif block_id == 'directions' %}
            <div id="directions-list">
                {% for d in page_content.get('directions', []) %}
                <div class="list-item" style="flex-direction: column; align-items: stretch; gap: 8px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;">
                    <div style="display: flex; gap: 12px;">
                        <input type="text" name="directions[][title]" value="{{ d.get('title', '') }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è" style="flex: 1;">
                        <input type="text" name="directions[][desc]" value="{{ d.get('desc', '') }}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" style="flex: 2;">
                        <button type="button" class="btn-remove" onclick="removeListItem(this.parentElement.parentElement)">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn-add" onclick="addDirectionItem()">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>

            {% elif block_id == 'events_achievements' %}
            <div class="form-group">
                <label>–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</label>
                <div id="events-list">
                    {% for event in page_content.get('events', []) %}
                    <div class="list-item" style="flex-direction: column; align-items: stretch; gap: 8px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; gap: 12px;">
                            <input type="text" name="events[][date]" value="{{ event.get('date', '') }}" placeholder="–î–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–µ–Ω—Ç—è–±—Ä—å 2024)" style="flex: 1;">
                            <input type="text" name="events[][text]" value="{{ event.get('text', '') }}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è" style="flex: 2;">
                            <button type="button" class="btn-remove" onclick="removeListItem(this.parentElement.parentElement)">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add" onclick="addEventItem()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
            </div>
            <div class="form-group">
                <label>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</label>
                <div id="achievements-list-items">
                    {% for item in page_content.get('achievements_list', []) %}
                    <div class="list-item">
                        <input type="text" name="achievements_list[]" value="{{ item }}" placeholder="–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ">
                        <button type="button" class="btn-remove" onclick="removeListItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add" onclick="addListItem('achievements-list-items', 'achievements_list[]')">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</button>
            </div>

            {% elif block_id == 'announcements' %}
            <p class="block-placeholder">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ <a href="/announcements">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>.</p>
            {% endif %}
        </div>
        {% endfor %}
        </div>

        <div class="btn-group">
            <button type="submit" class="btn-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="/" class="btn-cancel">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
function addListItem(containerId, name) {
    const container = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
        <input type="text" name="${name}" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç">
        <button type="button" class="btn-remove" onclick="removeListItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
    `;
    container.appendChild(div);
}

function addEventItem() {
    const container = document.getElementById('events-list');
    if (!container) return;
    const div = document.createElement('div');
    div.className = 'list-item';
    div.style.cssText = 'flex-direction: column; align-items: stretch; gap: 8px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;';
    div.innerHTML = `
        <div style="display: flex; gap: 12px;">
            <input type="text" name="events[][date]" placeholder="–î–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–µ–Ω—Ç—è–±—Ä—å 2024)" style="flex: 1;">
            <input type="text" name="events[][text]" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è" style="flex: 2;">
            <button type="button" class="btn-remove" onclick="removeListItem(this.parentElement.parentElement)">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    `;
    container.appendChild(div);
}

function addDirectionItem() {
    const container = document.getElementById('directions-list');
    if (!container) return;
    const div = document.createElement('div');
    div.className = 'list-item';
    div.style.cssText = 'flex-direction: column; align-items: stretch; gap: 8px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;';
    div.innerHTML = `
        <div style="display: flex; gap: 12px;">
            <input type="text" name="directions[][title]" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è" style="flex: 1;">
            <input type="text" name="directions[][desc]" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" style="flex: 2;">
            <button type="button" class="btn-remove" onclick="removeListItem(this.parentElement.parentElement)">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    `;
    container.appendChild(div);
}

function getSliderUrls() {
    var input = document.getElementById('sliderImagesInput');
    if (!input) return [];
    try {
        var v = JSON.parse(input.value);
        return Array.isArray(v) ? v : [];
    } catch (e) {
        return [];
    }
}

function setSliderUrls(urls) {
    var input = document.getElementById('sliderImagesInput');
    if (input) input.value = JSON.stringify(urls);
}

function removeSliderImage(btn) {
    var item = btn.closest('.slider-image-item');
    if (!item) return;
    var list = document.getElementById('slider-images-list');
    if (!list) return;
    var items = list.querySelectorAll('.slider-image-item');
    var idx = Array.prototype.indexOf.call(items, item);
    if (idx === -1) return;
    var urls = getSliderUrls();
    urls.splice(idx, 1);
    setSliderUrls(urls);
    item.remove();
}

document.addEventListener('DOMContentLoaded', function() {
    var sliderInput = document.getElementById('sliderFileInput');
    if (sliderInput) {
        sliderInput.addEventListener('change', function() {
            var files = this.files;
            if (!files || files.length === 0) return;
            var formData = new FormData();
            for (var i = 0; i < files.length; i++) formData.append('files', files[i]);
            fetch('/edit/index/slider-upload', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.success && data.urls && data.urls.length) {
                    var urls = getSliderUrls();
                    data.urls.forEach(function(url) { urls.push(url); });
                    setSliderUrls(urls);
                    var list = document.getElementById('slider-images-list');
                    if (list) {
                        data.urls.forEach(function(url) {
                            var div = document.createElement('div');
                            div.className = 'slider-image-item';
                            div.style.cssText = 'position: relative; width: 120px;';
                            div.innerHTML = '<img src="' + url + '" alt="" style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px; display: block;">' +
                                '<button type="button" class="btn-remove" onclick="removeSliderImage(this)" style="position: absolute; top: 4px; right: 4px; padding: 4px 8px; font-size: 0.85rem;">√ó</button>';
                            list.appendChild(div);
                        });
                    }
                }
            }).catch(function() {});
            this.value = '';
        });
    }
});

function moveBlock(blockId, delta) {
    const input = document.getElementById('blockOrderInput');
    const container = document.getElementById('blocks-container');
    if (!input || !container) return;
    let order;
    try {
        order = JSON.parse(input.value);
    } catch (e) {
        order = ['header', 'news', 'school_info', 'directions', 'events_achievements', 'announcements'];
    }
    const idx = order.indexOf(blockId);
    if (idx === -1) return;
    const newIdx = idx + delta;
    if (newIdx < 0 || newIdx >= order.length) return;
    [order[idx], order[newIdx]] = [order[newIdx], order[idx]];
    input.value = JSON.stringify(order);
    order.forEach(function(id) {
        const card = container.querySelector('[data-block-id="' + id + '"]');
        if (card) container.appendChild(card);
    });
}

function removeListItem(btn) {
    btn.closest('.list-item').remove();
}

document.getElementById('editForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—è
    for (let [key, value] of formData.entries()) {
        if (key.includes('[]')) {
            const fieldName = key.replace('[]', '');
            if (!data[fieldName]) data[fieldName] = [];
            data[fieldName].push(value);
        } else if (key.includes('[')) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (stats, events)
            const match = key.match(/(\w+)\[(\w+)\]/);
            if (match) {
                const objName = match[1];
                const objKey = match[2];
                if (!data[objName]) data[objName] = {};
                data[objName][objKey] = value;
            } else {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤ (events)
                const match2 = key.match(/(\w+)\[\]\[(\w+)\]/);
                if (match2) {
                    const arrName = match2[1];
                    const objKey = match2[2];
                    if (!data[arrName]) data[arrName] = [];
                    const index = formData.getAll(key).length - 1;
                    if (!data[arrName][index]) data[arrName][index] = {};
                    data[arrName][index][objKey] = value;
                }
            }
        } else {
            data[key] = value;
        }
    }
    
    const eventDates = formData.getAll('events[][date]');
    const eventTexts = formData.getAll('events[][text]');
    if (eventDates.length > 0) {
        data.events = [];
        for (let i = 0; i < eventDates.length; i++) {
            if (eventDates[i] || eventTexts[i]) {
                data.events.push({ date: eventDates[i] || '', text: eventTexts[i] || '' });
            }
        }
    }

    const dirTitles = formData.getAll('directions[][title]');
    const dirDescs = formData.getAll('directions[][desc]');
    if (dirTitles.length > 0) {
        data.directions = [];
        for (let i = 0; i < dirTitles.length; i++) {
            data.directions.push({ title: dirTitles[i] || '', desc: dirDescs[i] || '' });
        }
    }

    if (data.block_order && typeof data.block_order === 'string') {
        try {
            data.block_order = JSON.parse(data.block_order);
        } catch (e) {}
    }

    try {
        const response = await fetch('/edit/index', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            window.location.href = '/';
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
    }
});
</script>
{% endblock %}

